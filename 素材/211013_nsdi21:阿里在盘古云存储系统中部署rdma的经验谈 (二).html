<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>nsdi21:阿里在盘古云存储系统中部署rdma的经验谈 (二) | 只有不断学习，才能慢慢深入</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-141019448-1"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
      
          gtag('config', 'UA-141019448-1');
      </script>
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2468672938537807" crossorigin="anonymous"></script>
    <meta name="description" content="Hello World!">
    <meta name="baidu-site-verification" content="code-HRrK6kdBX1">
    
    <link rel="preload" href="/assets/css/0.styles.f6885cf5.css" as="style"><link rel="preload" href="/assets/js/app.a8c9fde6.js" as="script"><link rel="preload" href="/assets/js/2.a6173bc2.js" as="script"><link rel="preload" href="/assets/js/84.5c95e8fc.js" as="script"><link rel="prefetch" href="/assets/js/10.bf63d664.js"><link rel="prefetch" href="/assets/js/100.812b8c14.js"><link rel="prefetch" href="/assets/js/101.80f29e93.js"><link rel="prefetch" href="/assets/js/102.0741c62e.js"><link rel="prefetch" href="/assets/js/103.13b814aa.js"><link rel="prefetch" href="/assets/js/104.8e3aecf0.js"><link rel="prefetch" href="/assets/js/105.d0a825a1.js"><link rel="prefetch" href="/assets/js/106.693f2bc0.js"><link rel="prefetch" href="/assets/js/107.612f99c7.js"><link rel="prefetch" href="/assets/js/108.a25ef435.js"><link rel="prefetch" href="/assets/js/109.197286a9.js"><link rel="prefetch" href="/assets/js/11.e35a4e07.js"><link rel="prefetch" href="/assets/js/110.3762b13c.js"><link rel="prefetch" href="/assets/js/111.eb60db04.js"><link rel="prefetch" href="/assets/js/112.5570ba65.js"><link rel="prefetch" href="/assets/js/113.56c1c003.js"><link rel="prefetch" href="/assets/js/114.0d57db70.js"><link rel="prefetch" href="/assets/js/115.263fa6a6.js"><link rel="prefetch" href="/assets/js/12.316aac3b.js"><link rel="prefetch" href="/assets/js/13.16bd2a43.js"><link rel="prefetch" href="/assets/js/14.eed97db5.js"><link rel="prefetch" href="/assets/js/15.3cd14ae0.js"><link rel="prefetch" href="/assets/js/16.72848f44.js"><link rel="prefetch" href="/assets/js/17.54d0741d.js"><link rel="prefetch" href="/assets/js/18.d42d8070.js"><link rel="prefetch" href="/assets/js/19.ce408aa7.js"><link rel="prefetch" href="/assets/js/20.0a23f896.js"><link rel="prefetch" href="/assets/js/21.7c986b27.js"><link rel="prefetch" href="/assets/js/22.426d44ad.js"><link rel="prefetch" href="/assets/js/23.a36af85a.js"><link rel="prefetch" href="/assets/js/24.225a52eb.js"><link rel="prefetch" href="/assets/js/25.532bdceb.js"><link rel="prefetch" href="/assets/js/26.d7049420.js"><link rel="prefetch" href="/assets/js/27.9f191f81.js"><link rel="prefetch" href="/assets/js/28.691ac761.js"><link rel="prefetch" href="/assets/js/29.0cdd6852.js"><link rel="prefetch" href="/assets/js/3.582414ce.js"><link rel="prefetch" href="/assets/js/30.6438cbbe.js"><link rel="prefetch" href="/assets/js/31.522345d1.js"><link rel="prefetch" href="/assets/js/32.d8161cb7.js"><link rel="prefetch" href="/assets/js/33.85db058c.js"><link rel="prefetch" href="/assets/js/34.afe2ea0f.js"><link rel="prefetch" href="/assets/js/35.b0d12350.js"><link rel="prefetch" href="/assets/js/36.74ece8c7.js"><link rel="prefetch" href="/assets/js/37.e631c7b6.js"><link rel="prefetch" href="/assets/js/38.ff9656af.js"><link rel="prefetch" href="/assets/js/39.e953005d.js"><link rel="prefetch" href="/assets/js/4.0a620de0.js"><link rel="prefetch" href="/assets/js/40.bf8dac59.js"><link rel="prefetch" href="/assets/js/41.56c41f17.js"><link rel="prefetch" href="/assets/js/42.67a20a46.js"><link rel="prefetch" href="/assets/js/43.886b61e9.js"><link rel="prefetch" href="/assets/js/44.fe5c58ba.js"><link rel="prefetch" href="/assets/js/45.8e715a41.js"><link rel="prefetch" href="/assets/js/46.18432437.js"><link rel="prefetch" href="/assets/js/47.e0337ce7.js"><link rel="prefetch" href="/assets/js/48.3a63d39e.js"><link rel="prefetch" href="/assets/js/49.d69ae1ab.js"><link rel="prefetch" href="/assets/js/5.266a3c02.js"><link rel="prefetch" href="/assets/js/50.fb02fb1c.js"><link rel="prefetch" href="/assets/js/51.949764e2.js"><link rel="prefetch" href="/assets/js/52.e3a033f6.js"><link rel="prefetch" href="/assets/js/53.974750c5.js"><link rel="prefetch" href="/assets/js/54.31bca8dd.js"><link rel="prefetch" href="/assets/js/55.d169c802.js"><link rel="prefetch" href="/assets/js/56.1cd6f371.js"><link rel="prefetch" href="/assets/js/57.a770d143.js"><link rel="prefetch" href="/assets/js/58.289c5b9d.js"><link rel="prefetch" href="/assets/js/59.bc48ba05.js"><link rel="prefetch" href="/assets/js/6.770b56c2.js"><link rel="prefetch" href="/assets/js/60.d7f88202.js"><link rel="prefetch" href="/assets/js/61.c30ea24c.js"><link rel="prefetch" href="/assets/js/62.41c80be6.js"><link rel="prefetch" href="/assets/js/63.f24d9359.js"><link rel="prefetch" href="/assets/js/64.f6259b99.js"><link rel="prefetch" href="/assets/js/65.c72ba793.js"><link rel="prefetch" href="/assets/js/66.ed0b213e.js"><link rel="prefetch" href="/assets/js/67.572f1522.js"><link rel="prefetch" href="/assets/js/68.548a2110.js"><link rel="prefetch" href="/assets/js/69.9373ea6d.js"><link rel="prefetch" href="/assets/js/7.03daa1b7.js"><link rel="prefetch" href="/assets/js/70.4928d653.js"><link rel="prefetch" href="/assets/js/71.180adb10.js"><link rel="prefetch" href="/assets/js/72.65009026.js"><link rel="prefetch" href="/assets/js/73.6b472502.js"><link rel="prefetch" href="/assets/js/74.ee883b17.js"><link rel="prefetch" href="/assets/js/75.287b0775.js"><link rel="prefetch" href="/assets/js/76.7ec8be5e.js"><link rel="prefetch" href="/assets/js/77.6263397f.js"><link rel="prefetch" href="/assets/js/78.0a0e05ff.js"><link rel="prefetch" href="/assets/js/79.e2245133.js"><link rel="prefetch" href="/assets/js/8.150af887.js"><link rel="prefetch" href="/assets/js/80.689e9132.js"><link rel="prefetch" href="/assets/js/81.aaf24152.js"><link rel="prefetch" href="/assets/js/82.62dd3026.js"><link rel="prefetch" href="/assets/js/83.ed5d182b.js"><link rel="prefetch" href="/assets/js/85.3beda57a.js"><link rel="prefetch" href="/assets/js/86.018b2d0e.js"><link rel="prefetch" href="/assets/js/87.e732724f.js"><link rel="prefetch" href="/assets/js/88.9cbc5034.js"><link rel="prefetch" href="/assets/js/89.6fad310a.js"><link rel="prefetch" href="/assets/js/9.f7aab732.js"><link rel="prefetch" href="/assets/js/90.86ff277a.js"><link rel="prefetch" href="/assets/js/91.56c54e65.js"><link rel="prefetch" href="/assets/js/92.7139c500.js"><link rel="prefetch" href="/assets/js/93.4bef7a99.js"><link rel="prefetch" href="/assets/js/94.afc2d9f3.js"><link rel="prefetch" href="/assets/js/95.2533c372.js"><link rel="prefetch" href="/assets/js/96.9b4a2bfe.js"><link rel="prefetch" href="/assets/js/97.ad462c15.js"><link rel="prefetch" href="/assets/js/98.ed93e07b.js"><link rel="prefetch" href="/assets/js/99.f74104de.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f6885cf5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">只有不断学习，才能慢慢深入</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/素材/211013_nsdi21:阿里在盘古云存储系统中部署rdma的经验谈 (二).html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/素材/211013_nsdi21:阿里在盘古云存储系统中部署rdma的经验谈 (二).html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>nsdi21:阿里在盘古云存储系统中部署rdma的经验谈 (二)</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_1-阿里如何进行-rdma-部署" class="sidebar-link">1 阿里如何进行 RDMA 部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_1-1-rdma-部署规划中的考虑因素" class="sidebar-link">1.1 RDMA 部署规划中的考虑因素</a></li><li class="sidebar-sub-header"><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_1-2-盘古的-rdma-部署选择" class="sidebar-link">1.2 盘古的 RDMA 部署选择</a></li></ul></li><li><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_2-阿里部署-rdma-的性能优化" class="sidebar-link">2 阿里部署 RDMA 的性能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_2-1-性能障碍" class="sidebar-link">2.1 性能障碍</a></li><li class="sidebar-sub-header"><a href="/%E7%B4%A0%E6%9D%90/211013_nsdi21:%E9%98%BF%E9%87%8C%E5%9C%A8%E7%9B%98%E5%8F%A4%E4%BA%91%E5%AD%98%E5%82%A8%E7%B3%BB%E7%BB%9F%E4%B8%AD%E9%83%A8%E7%BD%B2rdma%E7%9A%84%E7%BB%8F%E9%AA%8C%E8%B0%88%20(%E4%BA%8C).html#_2-2-盘古的性能相关设计" class="sidebar-link">2.2 盘古的性能相关设计</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="content__default"><h2 id="_1-阿里如何进行-rdma-部署"><a href="#_1-阿里如何进行-rdma-部署" class="header-anchor">#</a> <strong>1 阿里如何进行 RDMA 部署</strong></h2> <h3 id="_1-1-rdma-部署规划中的考虑因素"><a href="#_1-1-rdma-部署规划中的考虑因素" class="header-anchor">#</a> 1.1 RDMA 部署规划中的考虑因素</h3> <p>存储集群的部署规划控制着网络拓扑结构、RDMA 通信范围、存储节点配置等，必须考虑多种因素，包括存储容量与需求的匹配、硬件成本的控制、性能的优化、可用性和 SLA 风险的最小化。最终的结果是所有这些因素之间的权衡。</p> <p>例如，微软部署 RDMA 的规模是适用于整个 CLOS 网络。因此，如果不加以阻止，PFC 风暴可能会蔓延到整个网络，并导致整个集群的崩溃。在生产级存储系统中，这种风险是不可接受的。</p> <h3 id="_1-2-盘古的-rdma-部署选择"><a href="#_1-2-盘古的-rdma-部署选择" class="header-anchor">#</a> 1.2 盘古的 RDMA 部署选择</h3> <p>RDMA 部署所采用的关键原则是可用性优先。</p> <p><img src="https://pic3.zhimg.com/v2-2746547643d52b0c64b4f4a369348aee_r.jpg" alt="img"></p> <p><strong>网络和节点配置</strong>。图 2 显示了盘古基于 CLOS 的网络拓扑结构。与常见的 dual-home 实践相一致，我们部署了 Mellanox CX 系列双端口 RNIC 来连接带有两个不同 ToR 交换机的主机。特别是，两个物理端口绑定到一个 IP 地址。网络连接（例如 RDMA 中的 QP）以循环方式 (Round-Robin) 在两个端口上进行均衡。当一个端口关闭时，可以将此端口上的连接迁移到另一个端口。</p> <p><img src="https://pic4.zhimg.com/v2-bdcdd991f0e8e984cd48f2f52f91b45b_r.jpg" alt="img"></p> <p>表 1 报告了 25Gbps 和 100Gbps RNIC 存储节点的典型硬件配置。每个节点的 SSD 数量由 RNIC 总带宽与单个 SSD 的吞吐量决定，允许 I/O 吞吐量与网络带宽相匹配。请注意，25Gbps 和 100Gbps 配置中的 SSD 类型是不同的，这会导致不成比例的数字。计算和存储节点部署在单个 podset 中的不同机架中。然后根据计算需求计算出计算节点数和存储节点数。</p> <p><strong>RDMA 范围</strong>。为了最小化故障域，我们只在每个 podset 内和存储节点之间启用 RDMA 通信。计算和存储节点之间的通信通过专用用户空间 TCP 协议执行。这是由于计算节点的硬件配置复杂，更新速度快。因此，TCP 可以有效地作为一种独立于硬件的传输协议来应用。与内核 TCP 相比，用户空间 TCP 更便于升级和管理，而内核 TCP 由于其通用性而被选择用于跨 podset 通信。</p> <p>生产部署是 podset 级 RDMA 的另一个关注点。在许多数据中心中，podset 位于不同的建筑中（跨楼）。对于交叉构建的 RDMA 链路，基本链路延迟要大得多，而 PFC 机制需要更大的 headroom 缓冲区。为了启用 RDMA，必须仔细调整和测试 Spine 交换机上的 PFC/ECN 阈值。这是一项艰巨的任务，目前还没有取得足够的成果。</p> <p><strong>RDMA/TCP 混合服务</strong>。据我们所知，以前关于 RDMA 部署的研究并没有探讨 RDMA 和 TCP 混合服务。在盘古，我们遵循可用性第一原则，将 TCP 作为最后的手段。尽管目前取得了进展，RDMA 设备还远没有完美无缺。因此，当可用性或 SLA 受到威胁时，将受影响的链路从 RDMA 切换到 TCP 可以保持可用带宽。此逃逸计划不会影响未受影响的 RDMA 链接。</p> <p><img src="https://pic3.zhimg.com/v2-374cb50aac7aac6f342d60387faafbbe_r.jpg" alt="img"></p> <p>然而，在混合部署过程中，我们确定共存的 TCP 流量会引发大量 TX 暂停（即 NICs 发送的 PFC 暂停帧），即使 RDMA/TCP 流量被隔离在两个优先级队列中。表 2 报告了盘古在不同负载和大约 50%TCP 流量下的 TX 暂停生成率。测试在 Mellanox CX-4 25Gbps 双端口 RNIC 上执行。如此大量的 TX 暂停对性能有害，并可能导致 PFC 风暴。我们与 Mellanox 一起研究了这个问题，并确定 Linux 内核中 TCP 的处理是高度 I/O 密集型的。内核 TCP 在 NIC 的 PCIe 总线上启动过多的部分写入 / 偏好性写入（partial writes）。随着 PCIe 带宽的消耗，NIC 的接收管道速度减慢。缓冲区溢出，NIC 随后开始传输 PFC pause 帧。</p> <p>为了优化 TCP 的内存访问，我们对数据访问过程进行了一些调整。首先，禁用大接收偏移量（LRO，Large Receive Offset）可以减少内存带宽的使用。这是由于启用 LRO 时访问多个缓存线造成的。此外，启用 NUMA 还提高了内存访问的效率，从而有助于减轻 PCIe 的压力。我们还为 RDMA 流量在 RNIC 上分配了更大的缓冲区，以防止 TX 暂停。最后，使应用程序数据缓存线对齐（cacheline-aligned）也是提高内存效率的常见优化实践。</p> <h2 id="_2-阿里部署-rdma-的性能优化"><a href="#_2-阿里部署-rdma-的性能优化" class="header-anchor">#</a> <strong>2 阿里部署 RDMA 的性能优化</strong></h2> <h3 id="_2-1-性能障碍"><a href="#_2-1-性能障碍" class="header-anchor">#</a> 2.1 性能障碍</h3> <p>盘古的性能优化目标是在最大化吞吐量的同时，最大限度地减少延迟。</p> <p><strong>RDMA - 存储协同设计</strong>。将 RDMA 协议栈与存储后端集成是一项挑战。它必须涵盖关键的性能点，如线程建模、内存管理和数据序列化。由于线程之间的通信开销，线程模型直接影响延迟。设计良好的内存管理和数据序列化是在数据访问期间实现零拷贝的关键。在这里，我们将简要介绍这些用于存储目的的组件的设计。</p> <p>用户空间存储操作系统（USSOS）是一个统一的用户空间存储软件平台，旨在支持 NVMe SSD 和持久性内存等新的存储介质。其设计原则（例如，内存管理、共享内存机制和用户空间驱动程序）基于众所周知的用户空间技术（例如，DPDK 和 SPDK）。相关测试显示，在盘古启用 USSOS 可以将 CPU 效率平均可提高 5% 以上。</p> <p>作为 USSOS 的核心部分，用户空间存储文件系统（USSFS）是一种为 SSD 设计的高性能本地文件系统。通过在用户空间中运行，USSFS 能够绕过内核以避免用户 / 内核空间交叉开销。USSOS 将磁盘划分为 “块”，这些块被 ChunkServer 在其 API 中使用（例如，创建、封装和删除）。USSOS 直接将数据和元数据写入磁盘，并使用轮询来感知完成事件。对于不同的块大小，与 Ext4 文件系统相比 USSFS 能够将 IOPS 提高 4-10 倍。</p> <p>运行到完成（run-to-completion）模型被认为是 RDMA 网络栈与存储栈集成的最佳方法。这个模型以前在讨论分类存储的研究中被探讨过（例如，Reflex，i10）。然而，这些研究是在 2017 年将 RDMA 引入 Pangu 之后发表的。Reflex 和 i10 侧重于远程直接 I/O，而 Pangu 中的 ChunkServer 则作为本地存储引擎应用于分布式存储。谷歌的 Snap 利用一个单独的网络进程来统一网络功能，减少网络连接的数量。</p> <p><strong>100Gbps 网络的内存瓶颈</strong>。部署 100Gbps 网络可以实现更低的延迟和更高的吞吐量。随着网络速度的提高，内存吞吐量成为了系统的瓶颈。</p> <p><img src="https://pic1.zhimg.com/v2-f3a1c1396b8ef08580a901e7ff2086ac_r.jpg" alt="img"></p> <p>为了获得内存访问吞吐量的上限，我们使用 Intel memory Latency Checker（MLC）工具测试内存吞吐量。表 3 详细说明了硬件资源的实际使用情况。在我们的测试中，最大可实现的内存带宽为 61GB/s，读写比为 1:1。但是，Pangu 工作负载的平均内存吞吐量已经是 29GB/s+28GB/s=57GB/s。这表明内存是瓶颈，而不是网络。</p> <p>通过监视盘古中的内存使用情况，我们确定验证和数据复制过程都需要优化。数据完整性是分布式存储最重要的特性之一。盘古采用循环冗余校验（CRC）进行应用级数据验证。</p> <p><img src="https://pic4.zhimg.com/v2-250210a0bdfa574a6e30b675b671942b_r.jpg" alt="img"></p> <p>如图 4 所示，接收到的数据被分成 4KB 的块，每个块加上 4B CRC 值和 44B 间隙。当计算应用于整个数据集时，此操作是内存和计算密集型操作。数据在写入磁盘时也会被复制，以便包含 CRC 校验。由于 RDMA 的远程内存访问语义，在其他组件中不执行复制。</p> <p><img src="https://pic3.zhimg.com/v2-7a171cf374e27712b07574ca15750846_r.jpg" alt="img"></p> <p><strong>大量 QP</strong>。我们过去在盘古的运行线程之间采用全网状链路模式（full-mesh link mode），以最大化吞吐量和最小化延迟（图 6（a））。假设每个 ChunkServer 有 14 个线程，每个 BlockServer 有 8 个线程，每个节点同时包含 ChunkServer 和 BlockServer。对于 100 个存储节点组成的集群中的全网格模式，可能有 14 个节点 ×8×2×99 = 每个节点 22176 个 QPs。由于 cache 未命中（cache miss），RNICs 对于大量 QP 的性能会急剧下降。特别地，RX 暂停（即，接收到的 PFC 暂停帧）的数目非常高。</p> <p>以前的研究也证明了同样的问题。为了解决这个问题，FaSST 在线程之间共享 QPs，由于线程之间 QPs 的锁争用（lock contention），从而降低了 CPU 效率和性能。另一种启发式方法是包含一个专用的代理线程来管理所有的接收和发送请求。但是，切换到 / 从专用代理线程切换回来会增加延迟。此外，单线程很难打满整个网络带宽。此外，代理解决方案对底层 RDMA 库是不透明的。</p> <h3 id="_2-2-盘古的性能相关设计"><a href="#_2-2-盘古的性能相关设计" class="header-anchor">#</a> 2.2 盘古的性能相关设计</h3> <p>盘古的性能相关设计是基于软硬件协同设计的原则，以最小化性能开销。</p> <p><img src="https://pic4.zhimg.com/v2-bfa591b0e0b3703dccbc41185968221f_r.jpg" alt="img"></p> <p><strong>存储 - RDMA 统一的运行到完成（Run-to-Completion）协议栈</strong>。我们对存储和网络都采用了从运行到完成的线程模型，以实现低延迟。图 5 示出了用于处理请求的过程。当节点接收到写 RPC 时，RNIC 通过 DMA 将其发送到用户空间。RPC 框架使用轮询获得请求，然后将其交给 ChunkServer 模块进行处理。然后 ChunkServer 通知 USSFS 为请求分配一个 “chunk” 资源。最后，用户空间驱动程序与 NVMe SSD 交互以存储数据。这些操作通常在单个服务器线程中执行，而不进行线程切换。这种从运行到完成的模型使延迟最小化。为了减少任务（jobs）造成的阻塞时间，应用程序在提交大的 I/O 请求时会将请求拆分为小的请求。这种优化确保了对 I/O 信号的快速响应。针对大型 I/O 请求的另一种优化策略涉及将辅助工作（例如格式化和 CRC 计算）传递到非 I/O 线程，然后在那里对它们进行处理。这些优化将典型存储请求（例如，4KB 大小）的平均延迟减少到 30us 以下。</p> <p>数据格式统一为 I/O 向量。在网络中使用分散 - 聚集 DMA（通过单个中断传输不连续数据），通过单个 RDMA verb 传输 I/O 向量而不进行复制。由于 RDMA 语义，序列化是不必要的。</p> <p><strong>零拷贝和 CRC 卸载</strong>。如上述所述，数据必须在 I/O 路径上复制一次，因为每个 4KB 的数据块都经过验证，并附有一个 CRC 校验值。这里，我们利用 RNICs 的用户模式内存注册（UMR）特性来避免这种数据复制。UMR 可以通过定义适当的内存 keys 将 RDMA 数据分散在远程端。因此，可以根据存储应用程序格式格式化和组织数据。我们使用 UMR 将发送方的连续数据重新映射到接收方的 I/O 缓冲区，其中包含 4KB 的数据、4B 的校验值和 44B 的间隔。在 CRC 计算之后，填充的 I/O 缓冲区可以直接用于磁盘写入。此外，CRC 计算能够卸载到有能力的 RNIC（例如 Mellanox CX-5），从而降低 CPU 和内存的使用。4KB 数据被发送到 RNIC，然后生成 4B CRC 校验和。</p> <p><strong>共享链接</strong>。我们采用共享链路模式，有效地减少了盘古 QP 的数量。共享链接模式是在应用层实现的，不影响 RDMA 库。目的节点中的对应线程被分配给源节点中的每个线程（图 6（b））。线程对节点的请求被发送到相应的线程，该线程随后将请求发送到正确的目标线程。</p> <p>考虑一个有 N 个线程的守护进程，每个线程轮询 N 个请求 / 响应队列以获得请求 / 响应。请注意，每个请求 / 响应队列只有一个生产者 / 消费者。因此，我们对每个请求 / 响应队列使用无锁队列来避免争用。根据我们的测试，这个设计增加了大约 0.3us 的延迟。</p> <p>在共享链接模式下，当源线程发送太多请求时，在请求调度期间，相应线程上会有资源开销。Pangu 支持共享组，其中一个节点中的线程可以分为多个组。对应线程只转发对其组成员的请求。回到上一个示例，全共享模式中的 QP 的数量现在减少到（8+8）×99=1584。如果线程被分成 2 个共享组，QP 的数量将是（8× 2 + 8 × 2) × 99 =3,168.</p> <p>未完待续...</p> <p><strong>参考文献</strong>：Yixiao Gao, et., al. “When Cloud Storage Meets RDMA”. In Proceedings of USENIX NSDI, 2021.</p> <p><strong>更多精彩内容，请关注微信公众号 &quot;网络技术风云汇&quot;。</strong></p> <p>全文完</p> <p>本文由 <a href="http://ksria.com/simpread" target="_blank" rel="noopener noreferrer">简悦 SimpRead<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 优化，用以提升阅读体验</p> <p>使用了 全新的简悦词法分析引擎 beta，<a href="http://ksria.com/simpread/docs/#/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E" target="_blank" rel="noopener noreferrer">点击查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>详细说明</p> <p><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-0" target="_blank" rel="noopener noreferrer">1 阿里如何进行 RDMA 部署<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-1" target="_blank" rel="noopener noreferrer">1.1 RDMA 部署规划中的考虑因素<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-2" target="_blank" rel="noopener noreferrer">1.2 盘古的 RDMA 部署选择<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-3" target="_blank" rel="noopener noreferrer">2 阿里部署 RDMA 的性能优化<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-4" target="_blank" rel="noopener noreferrer">2.1 性能障碍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://zhuanlan.zhihu.com/p/376989325#sr-toc-5" target="_blank" rel="noopener noreferrer">2.2 盘古的性能相关设计<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/10/13 上午12:22:21</span></div></footer> <!----> </main> <div class="footer-wrapper footer"><span><a href="https://beian.miit.gov.cn/">豫ICP备20003255号</a></span> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.a8c9fde6.js" defer></script><script src="/assets/js/2.a6173bc2.js" defer></script><script src="/assets/js/84.5c95e8fc.js" defer></script>
  </body>
</html>
