(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{473:function(s,n,a){"use strict";a.r(n);var e=a(42),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("p",[s._v("[Linuxå†…æ ¸ä¹‹æ—…](javascript:void(0)ğŸ˜‰ "),a("em",[s._v("ä»Šå¤©")])]),s._v(" "),a("p",[s._v("ä»¥ä¸‹æ–‡ç« æ¥æºäºæŠ€æœ¯ç®€è¯´ ï¼Œä½œè€…è‘£æ—­")]),s._v(" "),a("p",[s._v("æœ¬å…¬ä¼—å·ä½œè€…ä¸ºLinuxå†…æ ¸ä¹‹æ—…ç¤¾åŒºæˆå‘˜-è‘£æ—­")]),s._v(" "),a("p",[s._v("åŸºäºtcpdumpåŸç†æ‰‹åŠ¨å®ç°æŠ“åŒ…ç¨‹åº")]),s._v(" "),a("p",[s._v("å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†ætcpdumpå®ç°æŠ“åŒ…åŸç†ï¼š")]),s._v(" "),a("p",[s._v("1ã€"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483799&idx=1&sn=d31ddd924b8809040c004c5f163cb61d&chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 1"),a("OutboundLink")],1),s._v("ä¸»è¦ä»Linuxå†…æ ¸è§’åº¦åˆ†ætcpdumpæ—è·¯å—…æ¢æ•°æ®åŒ…çš„è¿‡ç¨‹")]),s._v(" "),a("p",[s._v("2ã€"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483893&idx=1&sn=e6ba1fdb1bb5a792ccb141b936eb5211&chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 2"),a("OutboundLink")],1),s._v("ä¸»è¦ä»Linuxå†…æ ¸è§’åº¦åˆ†ætcpdumpåˆ©ç”¨BPFæœºåˆ¶å®ç°æ•°æ®åŒ…æ•è·å‰çš„è¿‡æ»¤è¿‡ç¨‹")]),s._v(" "),a("p",[s._v("æœ¬æ¬¡å°†æ ¹æ®å‰é¢çš„åˆ†æï¼Œæ‰‹åŠ¨å†™ä¸€ä¸ªåŸºäºtcpdumpå·¥å…·åŸç†çš„ç®€æ˜“æŠ“åŒ…ç¨‹åºï¼Œå®ç°ä»é“¾è·¯å±‚çš„æŠ“åŒ…ï¼ŒåŠ æ·±ä¸€ä¸‹å…³äºtcpdumpåŸç†çš„å°è±¡ã€‚")]),s._v(" "),a("h3",{attrs:{id:""}},[a("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])]),s._v(" "),a("p",[s._v("æµç¨‹åˆ†æ")]),s._v(" "),a("h4",{attrs:{id:"_1ã€pf-packetåè®®æ—çš„socket"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1ã€pf-packetåè®®æ—çš„socket"}},[s._v("#")]),s._v(" 1ã€PF_PACKETåè®®æ—çš„socket")]),s._v(" "),a("p",[s._v("æ­£å¦‚åœ¨"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483799&idx=1&sn=d31ddd924b8809040c004c5f163cb61d&chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 1"),a("OutboundLink")],1),s._v("ä¸­åˆ†ææ—¶ï¼Œä»¥"),a("code",[s._v("socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL))")]),s._v("ä¸ºç€æ‰‹ç‚¹ã€‚æˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€šè¿‡åˆ›å»ºPF_PACKETåè®®æ—çš„socket,ç”¨æ¥æŠ“åŒ…ã€åˆ†ææ•°æ®çš„ã€‚")]),s._v(" "),a("p",[s._v("å¦‚ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªPF_PACKETç±»å‹çš„socket,typeæŒ‡å®šä¸ºSOCK_RAW,å½“æŒ‡å®šSOCK_RAWæ—¶ï¼Œè·å–çš„æ•°æ®åŒ…æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é“¾è·¯å±‚æ•°æ®åŒ…ã€‚proticolå­—æ®µè®¾ç½®ä¸ºhtons(ETH_P_ALL)ï¼Œè¡¨ç¤ºæ¥æ”¶ç«¯æ•°æ®é“¾è·¯å±‚æ‰€æœ‰åè®®å¸§ã€‚")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('/*socketå‡½æ•°åŸå‹ï¼š\n#include <sys/socket.h>\nsockfd = socket(int socket_family, int socket_type, int protocol);\n*/\nsock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));\n if (sock < 0) {\n  perror("socket");\n  return 1;\n }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h4",{attrs:{id:"_2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§"}},[s._v("#")]),s._v(" 2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§")]),s._v(" "),a("h5",{attrs:{id:"æ ¸å¿ƒç»“æ„ä½“-struct-sockaddr-ll"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#æ ¸å¿ƒç»“æ„ä½“-struct-sockaddr-ll"}},[s._v("#")]),s._v(" æ ¸å¿ƒç»“æ„ä½“ï¼šstruct sockaddr_ll")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("struct sockaddr_ll\n{\n unsigned short int sll_family; /* ä¸€èˆ¬ä¸ºAF_PACKET */\n unsigned short int sll_protocol; /* ä¸Šå±‚åè®®ç±»å‹ */\n int  sll_ifindex; /* ç½‘å¡æ¥å£ç´¢å¼•å·ï¼Œ0 åŒ¹é…æ‰€æœ‰çš„ç½‘ç»œæ¥å£å¡ */\n unsigned short int sll_hatype; /* æŠ¥å¤´ç±»å‹ */\n unsigned char sll_pkttype; /* åŒ…ç±»å‹ */\n unsigned char sll_halen; /* åœ°å€é•¿åº¦ */\n unsigned char sll_addr[8]; /* MACåœ°å€ */\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("è¯¥ç»“æ„ä½“ä¸ºè®¾å¤‡æ— å…³çš„ç‰©ç†å±‚åœ°å€ç»“æ„ï¼Œæ•°æ®é“¾è·¯å±‚çš„å¤´ä¿¡æ¯é€šå¸¸å®šä¹‰åœ¨sockaddr_allçš„ç»“æ„ä½“ä¸­ï¼Œå½“å‘é€æ•°æ®åŒ…æ—¶ï¼ŒæŒ‡å®š sll_family, sll_addr, sll_halen, sll_ifindex, sll_protocol å°±è¶³å¤Ÿäº†ã€‚å…¶å®ƒå­—æ®µè®¾ç½®ä¸º0ï¼›sll_hatypeå’Œ sll_pkttypeæ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…æ—¶ä½¿ç”¨çš„ï¼›å¦‚æœè¦bind, åªéœ€è¦ä½¿ç”¨ sll_protocolå’Œ sll_ifindexå°±è¶³å¤Ÿã€‚")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(" struct sockaddr_ll addr;\n memset(&addr, 0, sizeof(addr));\n addr.sll_ifindex = if_nametoindex(name);//nameä¸ºå½“å‰è¦æŠ“åŒ…çš„ç½‘å¡æ¥å£åç§°\n addr.sll_family = AF_PACKET;\n addr.sll_protocol = htons(ETH_P_ALL);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š"}},[s._v("#")]),s._v(" 3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' if (bind(sock, (struct sockaddr *) &addr, sizeof(addr))) {\n  perror("bind");\n  return 1;\n }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h4",{attrs:{id:"_4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶"}},[s._v("#")]),s._v(" 4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶")]),s._v(" "),a("p",[s._v("åœ¨"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483893&idx=1&sn=e6ba1fdb1bb5a792ccb141b936eb5211&chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 2"),a("OutboundLink")],1),s._v("ä¸­ï¼Œä»‹ç»äº†BPFè¿‡æ»¤æœºåˆ¶ï¼Œåœ¨tcpdumpçš„è¿‡æ»¤æœºåˆ¶ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„ç»“æ„ä½“:struct sock_filterï¼ŒåŒæ—¶ä¹Ÿæ˜¯cBPFæ±‡ç¼–çš„ä¸€ä¸ªæ¡†æ¶")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("struct sock_filter {\n __u16 code;   /*æŒ‡ä»¤  32ä½*/\n __u8 jt; /* jtæ˜¯æŒ‡ä»¤ç»“æœä¸ºtrueçš„è·³è½¬ */\n __u8 jf; /* jfæ˜¯ä¸ºfalseçš„è·³è½¬ */\n __u32 k;      /* æŒ‡ä»¤å‚æ•°*/\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("è¯¥ç»“æ„ä½“ä¸€èˆ¬æ˜¯å°è£…åœ¨struct sock_fprogä¸­ä½¿ç”¨:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("struct sock_fprog      \n{\n    unsigned short  len;   \n    struct sock_filter   *filter;\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("åœ¨"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483799&idx=1&sn=d31ddd924b8809040c004c5f163cb61d&chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 1"),a("OutboundLink")],1),s._v("ä¸­åˆ†æè¿‡ï¼Œä½¿ç”¨tcpdump -då‚æ•°å¯ä»¥ç”ŸæˆBPFæ±‡ç¼–ä¼ªä»£ç ï¼š")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dx@ubuntu:~$ sudo tcpdump -d 'ip and tcp port 80'\n(000) ldh      [12]\n(001) jeq      #0x800           jt 2    jf 12\n(002) ldb      [23]\n(003) jeq      #0x6             jt 4    jf 12\n(004) ldh      [20]\n(005) jset     #0x1fff          jt 12   jf 6\n(006) ldxb     4*([14]&0xf)\n(007) ldh      [x + 14]\n(008) jeq      #0x50            jt 11   jf 9\n(009) ldh      [x + 16]\n(010) jeq      #0x50            jt 11   jf 12\n(011) ret      #262144\n(012) ret      #0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("è¿™ç§ä¼ªä»£ç åœ¨Cç¨‹åºä¸­æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œéœ€è¦å€Ÿç”¨tcpdump -ddå‚æ•°ç”Ÿæˆç­‰æ•ˆçš„cä»£ç ï¼š")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("dx@ubuntu:~$ sudo tcpdump -dd 'ip and tcp port 80'\n{ 0x28, 0, 0, 0x0000000c },\n{ 0x15, 0, 10, 0x00000800 },\n{ 0x30, 0, 0, 0x00000017 },\n{ 0x15, 0, 8, 0x00000006 },\n{ 0x28, 0, 0, 0x00000014 },\n{ 0x45, 6, 0, 0x00001fff },\n{ 0xb1, 0, 0, 0x0000000e },\n{ 0x48, 0, 0, 0x0000000e },\n{ 0x15, 2, 0, 0x00000050 },\n{ 0x48, 0, 0, 0x00000010 },\n{ 0x15, 0, 1, 0x00000050 },\n{ 0x6, 0, 0, 0x00040000 },\n{ 0x6, 0, 0, 0x00000000 },\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("è¿™æ®µä»£ç å°±æ˜¯struct sock_filterï¼š")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("static struct sock_filter bpfcode[13] = {\n{ 0x28, 0, 0, 0x0000000c },\n{ 0x15, 0, 10, 0x00000800 },\n{ 0x30, 0, 0, 0x00000017 },\n{ 0x15, 0, 8, 0x00000006 },\n{ 0x28, 0, 0, 0x00000014 },\n{ 0x45, 6, 0, 0x00001fff },\n{ 0xb1, 0, 0, 0x0000000e },\n{ 0x48, 0, 0, 0x0000000e },\n{ 0x15, 2, 0, 0x00000050 },\n{ 0x48, 0, 0, 0x00000010 },\n{ 0x15, 0, 1, 0x00000050 },\n{ 0x6, 0, 0, 0x00040000 },\n{ 0x6, 0, 0, 0x00000000 },\n};\n\nstruct sock_fprog bpf = { 13, bpfcode };\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h4",{attrs:{id:"_5ã€è®¾ç½®bpfè¿‡æ»¤å™¨"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5ã€è®¾ç½®bpfè¿‡æ»¤å™¨"}},[s._v("#")]),s._v(" 5ã€è®¾ç½®BPFè¿‡æ»¤å™¨")]),s._v(" "),a("p",[s._v("Linuxåœ¨å®‰è£…å’Œå¸è½½è¿‡æ»¤å™¨æ—¶éƒ½ä½¿ç”¨äº†å‡½æ•°setsockopt(),å…¶ä¸­æ ‡å¿—SOL_SOCKETä»£è¡¨å¯¹socketè¿›è¡Œè®¾ç½®ï¼ŒSO_ATTACH_FILTERè¡¨ç¤ºå®‰è£…è¿‡æ»¤å™¨åŠ¨ä½œï¼Œsetsockoptåœ¨å†…æ ¸ä¸­çš„è°ƒç”¨å¯ä»¥çœ‹"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483893&idx=1&sn=e6ba1fdb1bb5a792ccb141b936eb5211&chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 2"),a("OutboundLink")],1),s._v("ã€‚")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('setsockopt(sd, SOL_SOCKET, SO_ATTACH_FILTER, &Filter, sizeof(Filter));\n if (setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &bpf, sizeof(bpf))) {\n  perror("setsockopt ATTACH_FILTER");\n  return 1;\n }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼"}},[s._v("#")]),s._v(" 6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼")]),s._v(" "),a("p",[s._v("å…³é”®ç»“æ„ä½“ï¼šstruct packet_mreq")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("struct packet_mreq\n{\nintmr_ifindex; /* æ¥å£ç´¢å¼• */\nunsigned shortmr_type; /* mreq ç±»å‹ */\nunsigned shortmr_alen; /* åœ°å€é•¿åº¦ */\nunsigned charmr_address[8]; /* ç‰©ç†åœ°å€ */\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("æ··æ‚æ¨¡å¼ï¼š")]),s._v(" "),a("p",[s._v("æ··æ‚æ¨¡å¼å°±æ˜¯æ¥æ”¶æ‰€æœ‰ç»è¿‡ç½‘å¡çš„æ•°æ®åŒ…ï¼ŒåŒ…æ‹¬ä¸æ˜¯å‘ç»™æœ¬æœºçš„åŒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹ç½‘å¡åªæŠŠå‘ç»™æœ¬æœºçš„åŒ…ï¼ˆåŒ…æ‹¬å¹¿æ’­åŒ…ï¼‰ä¼ é€’ç»™ä¸Šå±‚ç¨‹åºï¼Œå…¶å®ƒçš„åŒ…ä¸€å¾‹ä¸¢å¼ƒï¼›ç®€å•çš„è®²ï¼Œæ··æ‚æ¨¡å¼å°±æ˜¯æŒ‡ç½‘å¡èƒ½æ¥å—æ‰€æœ‰é€šè¿‡å®ƒçš„æ•°æ®æµï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œä»€ä¹ˆåœ°å€ï¼Œå½“ç½‘å¡å¤„äºæ··æ‚æ¨¡å¼æ—¶ï¼Œè¯¥ç½‘å¡å°±å…·æœ‰â€œå¹¿æ’­åœ°å€â€ï¼Œå®ƒå¯¹æ‰€æœ‰é‡åˆ°çš„æ¯ä¸€ä¸ªæ•°æ®å¸§éƒ½äº§ç”Ÿä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ï¼Œä»¥ä¾¿æé†’æ“ä½œç³»ç»Ÿå¤„ç†æµç»è¿‡è¯¥ç‰©ç†åª’ä½“ä¸Šçš„æ¯ä¸€ä¸ªæŠ¥æ–‡åŒ…ã€‚")]),s._v(" "),a("p",[s._v("é€šè¿‡"),a("code",[s._v("shortmr_type")]),s._v("å­—æ®µå¯ä»¥è®¾ç½®æ··æ‚æ¨¡å¼")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("    struct packet_mreq mreq;\n    memset(&mreq, 0, sizeof(mreq));\n mreq.mr_type = PACKET_MR_PROMISC;//è®¾ç½®æ··æ‚æ¨¡å¼\n mreq.mr_ifindex = if_nametoindex(name);\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("å°†è®¾ç½®çš„æ··æ‚æ¨¡å¼è®¾ç½®åˆ°socket:")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' if (setsockopt(sock, SOL_PACKET,\n    PACKET_ADD_MEMBERSHIP, (char *)&mreq, sizeof(mreq))) {\n  perror("setsockopt MR_PROMISC");//ACKET_ADD_MEMBERSHIP ç”¨äºå¢åŠ ä¸€ä¸ªç»‘å®š\n  return 1;\n }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h4",{attrs:{id:"_7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯"}},[s._v("#")]),s._v(" 7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯")]),s._v(" "),a("h5",{attrs:{id:"æºå’Œç›®çš„macåœ°å€"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#æºå’Œç›®çš„macåœ°å€"}},[s._v("#")]),s._v(" æºå’Œç›®çš„MACåœ°å€")]),s._v(" "),a("p",[s._v("å…³é”®ç»“æ„ä½“ï¼š")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("struct ether_header\n{\n  uint8_t  ether_dhost[ETH_ALEN]; /* ç›®çš„MACåœ°å€ */\n  uint8_t  ether_shost[ETH_ALEN]; /* æºMACåœ°å€ */\n  uint16_t ether_type;          /* packet type ID field */\n};\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("IPä¿¡æ¯(æºã€ç›®çš„IPï¼ŒIPç‰ˆæœ¬)ã€ä¸Šå±‚åè®®ç±»å‹")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('struct iphdr\n  {\n#if __BYTE_ORDER == __LITTLE_ENDIAN\n    unsigned int ihl:4;\n    unsigned int version:4;\n#elif __BYTE_ORDER == __BIG_ENDIAN\n    unsigned int version:4;\n    unsigned int ihl:4;\n#else\n# error "Please fix <bits/endian.h>"\n#endif\n    uint8_t tos;\n    uint16_t tot_len;\n    uint16_t id;\n    uint16_t frag_off;\n    uint8_t ttl;\n    uint8_t protocol;  //ä¸Šå±‚åè®®ç±»å‹\n    uint16_t check;\n    uint32_t saddr;   //æºåœ°å€\n    uint32_t daddr;   //ç›®çš„åœ°å€\n    /*The options start here. */\n  };\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h4",{attrs:{id:"_8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…"}},[s._v("#")]),s._v(" 8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…")]),s._v(" "),a("p",[s._v("åœ¨"),a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&mid=2247483799&idx=1&sn=d31ddd924b8809040c004c5f163cb61d&chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&scene=21#wechat_redirect",target:"_blank",rel:"noopener noreferrer"}},[s._v("æ–‡ç« 1"),a("OutboundLink")],1),s._v("ä¸­ï¼Œåˆ†æäº†æ•°æ®åŒ…æ˜¯æ€æ ·æ•è·çš„:")]),s._v(" "),a("blockquote",[a("p",[s._v("å›é¡¾ï¼š")]),s._v(" "),a("p",[s._v("tcpdumpè¿›è¡ŒæŠ“åŒ…çš„å†…æ ¸æµç¨‹æ¢³ç†")]),s._v(" "),a("ul",[a("li",[s._v("åº”ç”¨å±‚é€šè¿‡libpcapåº“ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨åˆ›å»ºsocket,"),a("code",[s._v("sock_fd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));")]),s._v("tcpdumpåœ¨socketåˆ›å»ºè¿‡ç¨‹ä¸­åˆ›å»ºpacket_type(struct packet_type),å¹¶æŒ‚è½½åˆ°å…¨å±€çš„ptype_allé“¾è¡¨ä¸Šã€‚(åŒæ—¶åœ¨packet_typeè®¾ç½®å›è°ƒå‡½æ•°packet_rcv")]),s._v(" "),a("li",[s._v("ç½‘ç»œæ”¶åŒ…/å‘åŒ…æ—¶ï¼Œä¼šåœ¨å„è‡ªçš„å¤„ç†å‡½æ•°(æ”¶åŒ…æ—¶ï¼š"),a("code",[s._v("__netif_receive_skb_core")]),s._v("ï¼Œå‘åŒ…æ—¶ï¼š"),a("code",[s._v("dev_queue_xmit_nit")]),s._v(")ä¸­éå†ptype_allé“¾è¡¨ï¼Œå¹¶åŒæ—¶æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ï¼Œè¿™é‡Œtcpdumpçš„æ³¨å†Œçš„å›è°ƒå‡½æ•°å°±æ˜¯packet_rcv")]),s._v(" "),a("li",[s._v("packet_rcvå‡½æ•°ä¸­ä¼šå°†ç”¨æˆ·è®¾ç½®çš„è¿‡æ»¤æ¡ä»¶ï¼Œé€šè¿‡BPFè¿›è¡Œè¿‡æ»¤ï¼Œå¹¶å°†è¿‡æ»¤çš„æ•°æ®åŒ…æ·»åŠ åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸­")]),s._v(" "),a("li",[s._v("åº”ç”¨å±‚è°ƒç”¨recvfrom ã€‚PF_PACKET åè®®ç°‡æ¨¡å—è°ƒç”¨packet_recvmsg å°†æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ•°æ®copyåº”ç”¨å±‚ï¼Œåˆ°æ­¤å°†æ•°æ®åŒ…æ•è·åˆ°ã€‚")])])]),s._v(" "),a("p",[s._v("æ‰€ä»¥ä¸Šé¢åˆ›å»ºå¥½çš„PF_PACKETç±»å‹socketï¼Œå¹¶è®¾ç½®å¥½è¿‡æ»¤å™¨åï¼Œå½“ç½‘å¡æœ‰æ•°æ®è¿›å‡ºæ—¶ï¼Œå°±å·²ç»å°†æ•°æ®æŠ¥æ–‡æ·»åŠ åˆ°äº†æ¥æ”¶é˜Ÿåˆ—ä¸Šäº†ï¼Œä¸‹é¢åªéœ€è¦æˆ‘ä»¬è¿›è¡Œrecvè·å–æ•°æ®æŠ¥æ–‡å³å¯ã€‚")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v(' for (;;) {\n  n = recv(sock, buf, sizeof(buf), 0);\n  if (n < 1) {\n   perror("recv");\n   return 0;\n  }\n        //è·å–é“¾è·¯å±‚çš„æºå’Œç›®çš„åœ°å€\n  mac_hdr=(struct ether_header *)buf;\n\n  ip = (struct iphdr *)(buf + sizeof(struct ether_header));\n\n  inet_ntop(AF_INET, &ip->saddr, saddr_str, sizeof(saddr_str));\n  inet_ntop(AF_INET, &ip->daddr, daddr_str, sizeof(daddr_str));\n\n  switch (ip->protocol) {\n#define PTOSTR(_p,_str) \\\n   case _p: proto_str = _str; break\n\n  PTOSTR(IPPROTO_ICMP, "icmp");\n  PTOSTR(IPPROTO_TCP, "tcp");\n  PTOSTR(IPPROTO_UDP, "udp");\n  default:\n   proto_str = "";\n   break;\n  }\n        printf(" SMAC:%X:%X:%X:%X:%X:%X",\n    (u_char)mac_hdr->ether_shost[0],\n    (u_char)mac_hdr->ether_shost[1],\n    (u_char)mac_hdr->ether_shost[2],\n    (u_char)mac_hdr->ether_shost[3],\n    (u_char)mac_hdr->ether_shost[4],\n    (u_char)mac_hdr->ether_shost[5]\n   );\n\n  printf(" ==>  DMAC:%X:%X:%X:%X:%X:%X  ",\n    (u_char)mac_hdr->ether_dhost[0],\n    (u_char)mac_hdr->ether_dhost[1],\n    (u_char)mac_hdr->ether_dhost[2],\n    (u_char)mac_hdr->ether_dhost[3],\n    (u_char)mac_hdr->ether_dhost[4],\n    (u_char)mac_hdr->ether_dhost[5]\n   );\n  printf("IPv%d proto=%d(%s) src=%s dst=%s\\n",\n    ip->version, ip->protocol, proto_str, saddr_str, daddr_str);\n }\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br")])]),a("p",[s._v("è‡³æ­¤ï¼Œä»åˆ›å»ºsocketï¼Œåˆ°è®¾ç½®socketè¿‡æ»¤å™¨ã€ç½‘å¡å·¥ä½œæ¨¡å¼ï¼Œåˆ°æ¥æ”¶æ•è·çš„æ•°æ®åŒ…å°±ç»“æŸäº†ã€‚")]),s._v(" "),a("h3",{attrs:{id:"-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[s._v("#")])]),s._v(" "),a("p",[s._v("é™„ï¼šæºä»£ç ")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_gif/EjWxxIM2EQJDl28hhtwMqByPiceMkObWic7WIIXpTBn5ibvVNKicK8Dhjga8Q1zasPKVgbhC4vd3CyyCH4tJMvicQ2Q/640?wx_fmt=gif&tp=webp&wxfrom=5&wx_lazy=1",alt:"å›¾ç‰‡"}})]),s._v(" "),a("p",[s._v("å®ç°æ•è·æ•°æ®åŒ…çš„è¿‡æ»¤æ¡ä»¶ï¼šip and tcp port 80")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('#include <stdio.h>\n#include <string.h>\n#include <sys/types.h>\n#include <sys/socket.h>\n#include <net/if.h>\n#include <net/ethernet.h>\n#include <netinet/in.h>\n#include <netinet/ip.h>\n#include <arpa/inet.h>\n#include <netpacket/packet.h>\n#include <linux/filter.h>\n\nstatic struct sock_filter bpfcode[13] = {\n{ 0x28, 0, 0, 0x0000000c },\n{ 0x15, 0, 10, 0x00000800 },\n{ 0x30, 0, 0, 0x00000017 },\n{ 0x15, 0, 8, 0x00000006 },\n{ 0x28, 0, 0, 0x00000014 },\n{ 0x45, 6, 0, 0x00001fff },\n{ 0xb1, 0, 0, 0x0000000e },\n{ 0x48, 0, 0, 0x0000000e },\n{ 0x15, 2, 0, 0x00000050 },\n{ 0x48, 0, 0, 0x00000010 },\n{ 0x15, 0, 1, 0x00000050 },\n{ 0x6, 0, 0, 0x00040000 },\n{ 0x6, 0, 0, 0x00000000 },\n};\n\nint main(int argc, char **argv)\n{\n int sock;\n int n;\n char buf[2000];\n struct sockaddr_ll addr;\n struct packet_mreq mreq;\n struct iphdr *ip;\n    struct ether_header *mac_hdr;\n    char saddr_str[INET_ADDRSTRLEN], daddr_str[INET_ADDRSTRLEN];\n char *proto_str;\n char *name;\n struct sock_fprog bpf = { 13, bpfcode };\n\n if (argc != 2) {\n  printf("Usage: %s ifname\\n", argv[0]);\n  return 1;\n }\n\n name = argv[1];\n\n sock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));\n if (sock < 0) {\n  perror("socket");\n  return 1;\n }\n\n memset(&addr, 0, sizeof(addr));\n addr.sll_ifindex = if_nametoindex(name);\n addr.sll_family = AF_PACKET;\n addr.sll_protocol = htons(ETH_P_ALL);\n\n if (bind(sock, (struct sockaddr *) &addr, sizeof(addr))) {\n  perror("bind");\n  return 1;\n }\n\n if (setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &bpf, sizeof(bpf))) {\n  perror("setsockopt ATTACH_FILTER");\n  return 1;\n }\n\n memset(&mreq, 0, sizeof(mreq));\n mreq.mr_type = PACKET_MR_PROMISC;\n mreq.mr_ifindex = if_nametoindex(name);\n\n if (setsockopt(sock, SOL_PACKET,\n    PACKET_ADD_MEMBERSHIP, (char *)&mreq, sizeof(mreq))) {\n  perror("setsockopt MR_PROMISC");\n  return 1;\n }\n\n for (;;) {\n  n = recv(sock, buf, sizeof(buf), 0);\n  if (n < 1) {\n   perror("recv");\n   return 0;\n  }\n        //è·å–é“¾è·¯å±‚çš„æºå’Œç›®çš„åœ°å€\n  mac_hdr=(struct ether_header *)buf;\n\n  ip = (struct iphdr *)(buf + sizeof(struct ether_header));\n\n  inet_ntop(AF_INET, &ip->saddr, saddr_str, sizeof(saddr_str));\n  inet_ntop(AF_INET, &ip->daddr, daddr_str, sizeof(daddr_str));\n\n  switch (ip->protocol) {\n#define PTOSTR(_p,_str) \\\n   case _p: proto_str = _str; break\n\n  PTOSTR(IPPROTO_ICMP, "icmp");\n  PTOSTR(IPPROTO_TCP, "tcp");\n  PTOSTR(IPPROTO_UDP, "udp");\n  default:\n   proto_str = "";\n   break;\n  }\n        printf(" SMAC:%X:%X:%X:%X:%X:%X",\n    (u_char)mac_hdr->ether_shost[0],\n    (u_char)mac_hdr->ether_shost[1],\n    (u_char)mac_hdr->ether_shost[2],\n    (u_char)mac_hdr->ether_shost[3],\n    (u_char)mac_hdr->ether_shost[4],\n    (u_char)mac_hdr->ether_shost[5]\n   );\n\n  printf(" ==>  DMAC:%X:%X:%X:%X:%X:%X  ",\n    (u_char)mac_hdr->ether_dhost[0],\n    (u_char)mac_hdr->ether_dhost[1],\n    (u_char)mac_hdr->ether_dhost[2],\n    (u_char)mac_hdr->ether_dhost[3],\n    (u_char)mac_hdr->ether_dhost[4],\n    (u_char)mac_hdr->ether_dhost[5]\n   );\n  printf("IPv%d proto=%d(%s) src=%s dst=%s\\n",\n    ip->version, ip->protocol, proto_str, saddr_str, daddr_str);\n }\n\n return 0;\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br"),a("span",{staticClass:"line-number"},[s._v("116")]),a("br"),a("span",{staticClass:"line-number"},[s._v("117")]),a("br"),a("span",{staticClass:"line-number"},[s._v("118")]),a("br"),a("span",{staticClass:"line-number"},[s._v("119")]),a("br"),a("span",{staticClass:"line-number"},[s._v("120")]),a("br"),a("span",{staticClass:"line-number"},[s._v("121")]),a("br"),a("span",{staticClass:"line-number"},[s._v("122")]),a("br"),a("span",{staticClass:"line-number"},[s._v("123")]),a("br"),a("span",{staticClass:"line-number"},[s._v("124")]),a("br"),a("span",{staticClass:"line-number"},[s._v("125")]),a("br"),a("span",{staticClass:"line-number"},[s._v("126")]),a("br"),a("span",{staticClass:"line-number"},[s._v("127")]),a("br"),a("span",{staticClass:"line-number"},[s._v("128")]),a("br")])]),a("h4",{attrs:{id:"è¿è¡Œ"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#è¿è¡Œ"}},[s._v("#")]),s._v(" è¿è¡Œï¼š")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://mmbiz.qpic.cn/mmbiz_png/EjWxxIM2EQLoiaBp9GUEWP5Qx1RQRc0CFGcDVdUb9aaJyWYhmI3LuPZh6wMy1kaEjO7ibnT510jXTAJzLytF2Rwg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1",alt:"å›¾ç‰‡"}})]),s._v(" "),a("blockquote",[a("p",[s._v("æ³¨æ„ï¼šç¨‹åºæŒ‡å®šçš„å‚æ•°ï¼šens33ä¸ºè‡ªå·±çš„ç½‘å¡æ¥å£åç§°ï¼Œå¯ä»¥é€šè¿‡ip addrè¿›è¡ŒæŸ¥çœ‹ã€‚")])]),s._v(" "),a("p",[s._v("å–œæ¬¢æ­¤å†…å®¹çš„äººè¿˜å–œæ¬¢")]),s._v(" "),a("p",[s._v("Filebeatã€Logstashã€Rsyslog å„ç§å§¿åŠ¿é‡‡é›†Nginxæ—¥å¿—")]),s._v(" "),a("p",[s._v("é«˜æ•ˆè¿ç»´")]),s._v(" "),a("p",[s._v("ä¸å–œæ¬¢")]),s._v(" "),a("p",[s._v("ä¸çœ‹çš„åŸå› ")]),s._v(" "),a("p",[s._v("ç¡®å®š")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("å†…å®¹è´¨é‡ä½")])]),s._v(" "),a("li"),s._v(" "),a("li",[a("p",[s._v("ä¸çœ‹æ­¤å…¬ä¼—å·")])])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://mp.weixin.qq.com/mp/qrcode?scene=10000004&size=102&__biz=MzI3NzA5MzUxNA==&mid=2664610380&idx=1&sn=2f15cdfb6e31bcd5b5f62437ca4c7740&send_time=",alt:"img"}})]),s._v(" "),a("p",[s._v("å¾®ä¿¡æ‰«ä¸€æ‰«\nå…³æ³¨è¯¥å…¬ä¼—å·")]),s._v(" "),a("p",[s._v("ï¼šï¼Œã€‚è§†é¢‘å°ç¨‹åºèµï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆèµåœ¨çœ‹ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆåœ¨çœ‹")])])}),[],!1,null,null,null);n.default=t.exports}}]);