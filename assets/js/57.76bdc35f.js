(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{440:function(t,s,e){"use strict";e.r(s);var n=e(42),a=Object(n.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目录"}},[t._v("#")]),t._v(" 目录")]),t._v(" "),e("h3",{attrs:{id:"文章目录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#文章目录"}},[t._v("#")]),t._v(" 文章目录")]),t._v(" "),e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_0",target:"_blank",rel:"noopener noreferrer"}},[t._v("目录"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_2",target:"_blank",rel:"noopener noreferrer"}},[t._v("前言"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#SDN_5",target:"_blank",rel:"noopener noreferrer"}},[t._v("软件定义网络（SDN）"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#vSwitch_12",target:"_blank",rel:"noopener noreferrer"}},[t._v("虚拟交换机（vSwitch）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_SDN__15",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么说云计算时代的 SDN 非常重要"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#OpenFlow__18",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenFlow 简介"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch_28",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch__56",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的架构"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#ovsdbovsdbserver_63",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovsdb（ovsdb-server）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#ovsvswitchdvswitchd_66",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovs-vswitchd（vswitchd）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Datapatchopenvswitchko_69",target:"_blank",rel:"noopener noreferrer"}},[t._v("Datapatch（openvswitch.ko）"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#OvS__77",target:"_blank",rel:"noopener noreferrer"}},[t._v("OvS 的工具集"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#ovsvsctl__85",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovs-vsctl 常用指令"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch__116",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的工作原理"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#OpenvSwitch__130",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenvSwitch 的典型工作流程"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch__141",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的安装部署"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch__DBovsdb_205",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的 DB（ovs-db）"),e("OutboundLink")],1)])])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Open_vSwitch__299",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的操作对象"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Manager_302",target:"_blank",rel:"noopener noreferrer"}},[t._v("Manager"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_Manager_OvS_DB_Connection_335",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置 Manager OvS DB Connection"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#SSL_371",target:"_blank",rel:"noopener noreferrer"}},[t._v("SSL"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_SSL_Connection_405",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置 SSL Connection"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Bridge_506",target:"_blank",rel:"noopener noreferrer"}},[t._v("Bridge"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Bridge__509",target:"_blank",rel:"noopener noreferrer"}},[t._v("Bridge 常用操作指令"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Controller_615",target:"_blank",rel:"noopener noreferrer"}},[t._v("Controller"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Controller__648",target:"_blank",rel:"noopener noreferrer"}},[t._v("Controller 常用指令"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_Floodlight_659",target:"_blank",rel:"noopener noreferrer"}},[t._v("安装 Floodlight"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_KVM__OvS_Bridge_722",target:"_blank",rel:"noopener noreferrer"}},[t._v("将 KVM 虚拟机接入 OvS Bridge"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Floodlight_Controller__747",target:"_blank",rel:"noopener noreferrer"}},[t._v("Floodlight Controller 常用指令"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Mirror_787",target:"_blank",rel:"noopener noreferrer"}},[t._v("Mirror"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#SPAN_802",target:"_blank",rel:"noopener noreferrer"}},[t._v("SPAN"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#RSPAN_820",target:"_blank",rel:"noopener noreferrer"}},[t._v("RSPAN"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Interface_828",target:"_blank",rel:"noopener noreferrer"}},[t._v("Interface"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Port_844",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Port__VLAN_845",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 VLAN"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Port__VLAN__866",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 VLAN 的常用操作指令"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Port__Bond_887",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 Bond"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Port__QoS_901",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 QoS"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_QoS__907",target:"_blank",rel:"noopener noreferrer"}},[t._v("网络流程 QoS 的实现原理与方式"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_TC__HTBHierarchical_Token_Bucket_928",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 TC 创建一个 HTB（Hierarchical Token Bucket）树"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Tunnel_968",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tunnel"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#OvS_Tunnel__974",target:"_blank",rel:"noopener noreferrer"}},[t._v("OvS Tunnel 的操作指令示例"),e("OutboundLink")],1)])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#Flow_Table_1000",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flow Table"),e("OutboundLink")],1)])]),t._v(" "),e("li",[e("ul",[e("li",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_1027",target:"_blank",rel:"noopener noreferrer"}},[t._v("常用流表操作指令"),e("OutboundLink")],1)])])])])]),t._v(" "),e("li",[e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#_1048",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考文档"),e("OutboundLink")],1)])])]),t._v(" "),e("h1",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),e("p",[t._v("该篇文章是在《通俗说 Openvswitch》的基础上再结合我再网上收集的资料进行学习、整理与归纳，感谢刘大（公众号：刘超的通俗云计算）以及创作者的分享。")]),t._v(" "),e("h1",{attrs:{id:"软件定义网络-sdn"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#软件定义网络-sdn"}},[t._v("#")]),t._v(" 软件定义网络（SDN）")]),t._v(" "),e("p",[t._v("软件定义有啥好处呢？\n想象你有一个大的数据中心，里面有很多的网络设备，光交换机就有很多，你希望在交换机上配置一些网络的策略，例如某个口应该属于某个 VLAN。\n怎么配置呢？登到这台交换机上去，敲几行命令就搞定了。\n如果要配置 100 台交换机呢？头大了吧，难不成登陆 100 台？\n"),e("strong",[t._v("想不想有一个集中的地方，能看到整个网络的拓扑图，统一配置一下，然后一回车，配置的策略就通过管理网络平面下发到 100 台交换机上。这样整个网络的拓扑结构就不是硬的了，也即不是通过插线，拔线，登陆盒子配置的，而是变成了软的，也即通过软件统一控制，这个统一控制的地方我们称为 SDN Controller（控制器），这样的网络拓扑结构，我们称为软件定义的网络")]),t._v("。")]),t._v(" "),e("h2",{attrs:{id:"虚拟交换机-vswitch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#虚拟交换机-vswitch"}},[t._v("#")]),t._v(" 虚拟交换机（vSwitch）")]),t._v(" "),e("p",[t._v("虚拟交换机（vSwitch）就是利用虚拟平台，通过软件的方式实现（Software Defined Network，SDN，软件定义网络）的交换机部件。跟传统的物理交换机相比，虚拟交换机具备众多优点：一是配置灵活，一台普通的服务器可以配置出数十台甚至上百台虚拟交换机，且端口数目也可以灵活选择。例如，一台 VMware ESXi 服务器可以仿真出 248 台虚拟交换机，且每台交换机预设虚拟端口即可达 56 个；二是成本低廉，通过虚拟交换同样可以获得昂贵的普通交换机才能达到的性能，例如，微软的 Hyper-V，虚拟机与虚拟交换机之间的联机速度轻易可达 10Gbps。")]),t._v(" "),e("h2",{attrs:{id:"为什么说云计算时代的-sdn-非常重要"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#为什么说云计算时代的-sdn-非常重要"}},[t._v("#")]),t._v(" 为什么说云计算时代的 SDN 非常重要")]),t._v(" "),e("p",[t._v("因为虚拟机的创建，删除，迁移比物理机灵活的多，所以很难像物理的交换机一样，用网线将交换机和物理服务器连接起来，就不怎么变了。虚拟机就不一样了，所以需要虚拟交换机，也即通过软件模拟一个交换机，用软件模拟一根网线，一头插在虚拟机上，一头插在虚拟交换机上，一会儿创建五个虚拟机，要插到一个交换机上，一会儿其中两个虚拟机迁移到了另外的物理机上，则他们两个的网口要从上一台交换机上拔下来，插到新的虚拟交换机上，这样做没有问题，因为都是软件实现的，很灵活。")]),t._v(" "),e("h1",{attrs:{id:"openflow-简介"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#openflow-简介"}},[t._v("#")]),t._v(" OpenFlow 简介")]),t._v(" "),e("p",[t._v("OpenFlow is a open standard managed by Open Networking Foundation. It specifies a protocol by which a remote controller can modify the behavior of networking devices through a well-defined “forwarding instruction set”.")]),t._v(" "),e("p",[t._v("OpenFlow，一种网上通信协议，属于数据链路层，能够控制网上交换器或路由器的数据转发平面（Forwarding Plane），借此改变网上数据包所经过的网上路径。"),e("strong",[t._v("简而言之，OpenFlow 就是 SDN Controller 远程控制网络设备的协议，经由网上交换器，决定网上数据包要由何种路径通过网络交换机")]),t._v("。虽然 OpenFlow 的功能不如各大网络厂商的自家协议强大，但正因如此，OpenFlow 成为了一个兼容非常高的功能子集，以至于让各网络厂商能够达成了部分的共识。")]),t._v(" "),e("p",[t._v("OpenFlow 允许从远程控制网上交换器的数据包转送表，透过新增、修改、移除数据包控制规则与行动，来改变数据包转送的路径。比起用访问控制表（ACLs）和路由协议，允许更加复杂且灵活的流量管理。同时，OpenFlow 允许不同网络供应商用一个简单，开源的协议去远程管理交换机（通常提供专有的接口和描述语言）。OpenFlow 协议用来描述控制器和交换机之间交互所用信息的标准，以及控制器和交换机的接口标准。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211124722125.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h1",{attrs:{id:"open-vswitch"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch"}},[t._v("#")]),t._v(" Open vSwitch")]),t._v(" "),e("p",[t._v("Open vSwitch is a production quality, multilayer virtual switch licensed under the open source Apache 2.0 license. It is designed to enable massive network automation through programmatic extension, while still supporting standard management interfaces and protocols (e.g. NetFlow, sFlow, IPFIX, RSPAN, CLI, LACP, 802.1ag). In addition, it is designed to support distribution across multiple physical servers similar to VMware’s vNetwork distributed vswitch or Cisco’s Nexus 1000V.\n– "),e("a",{attrs:{href:"http://www.openvswitch.org/",target:"_blank",rel:"noopener noreferrer"}},[t._v("官方网站"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("Open vSwitch（下文简称 OvS）就是一个开源的虚拟交换机实现。广泛应用在云计算行业，为网络管理员提供虚拟云主机之间和之内的流量可见性与可控性。Open vSwitch 旨在用虚拟化方案解决网络问题，与控制器软件一起实现分布式的虚拟交换技术。这意味着，交换机和控制器软件能够在多个服务器之间创建集群网络配置，从而不需要在每一台云主机和物理主机上单独配置网络。这个交换机还支持 VLAN 中继，通过 NetFlow、sFlow 和 RSPAN 实现可见性，通过 OpenFlow 协议进行管理。它还有其他一些特性：严格流量控制，它由 OpenFlow 交换协议实现；远程管理功能，它能通过网络策略实现更多控制。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190217202557706.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("简而言之，Open vSwitch 即开放的软件虚拟交换机，能够达到产品级的质量，也就是说可以部署一些生产环境使用。它不光支持基本的二层交换，还支持标准的管理机接口和协议（e.g. NetFlow,sFlow,SPAN,RSAPN,CLI,LACP,802.1ag），同时也支持 OpenFlow，可以很好的与 SDN 体系融合")]),t._v("。")]),t._v(" "),e("p",[e("strong",[t._v("Open vSwitch 的特性清单")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("支持通过 NetFlow、sFlow、IPFIX、SPAN、RSPAN 和 GRE-tunneled 镜像使虚拟机内部通讯可以被监控；")]),t._v(" "),e("li",[t._v("支持 LACP（IEEE 802.1AX-2008，多端口绑定）协议；")]),t._v(" "),e("li",[t._v("支持标准的 802.1Q VLAN 模型以及 Trunk 模式；")]),t._v(" "),e("li",[t._v("支持 BFD 和 802.1ag 链路状态监测；")]),t._v(" "),e("li",[t._v("支持 STP（IEEE 802.1D-1998）；")]),t._v(" "),e("li",[t._v("支持细粒度的 Qos；")]),t._v(" "),e("li",[t._v("支持 HFSC 系统级别的流量控制队列；")]),t._v(" "),e("li",[t._v("支持每虚拟机网卡的流量的流量控制策略；")]),t._v(" "),e("li",[t._v("支持基于源 MAC 负载均衡模式、主备模式、L4 哈希模式的多端口绑定；")]),t._v(" "),e("li",[t._v("支持 OpenFlow 协议（包括许多虚拟化的增强特性）；")]),t._v(" "),e("li",[t._v("支持 IPV6")]),t._v(" "),e("li",[t._v("支持多种隧道协议（GRE, VXLAN, IPsec, GRE and VXLAN over IPsec）")]),t._v(" "),e("li",[t._v("支持通过 C 或者 Python 接口远程配置；")]),t._v(" "),e("li",[t._v("支持内核态和用户态的转发引擎设置；")]),t._v(" "),e("li",[t._v("支持多列表转发的发送缓存引擎；")]),t._v(" "),e("li",[t._v("支持转发层抽象以容易的定向到新的软件或者硬件平台；")])]),t._v(" "),e("h2",{attrs:{id:"open-vswitch-的架构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch-的架构"}},[t._v("#")]),t._v(" Open vSwitch 的架构")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019021120470977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211215602618.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211215556947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"ovsdb-ovsdb-server"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ovsdb-ovsdb-server"}},[t._v("#")]),t._v(" ovsdb（ovsdb-server）")]),t._v(" "),e("p",[t._v("轻量级的数据库，用于存储整个 OvS 的配置信息，包括接口，交换内容，VLAN，虚拟交换机的创建，网卡的添加等信息与操作记录，都由 ovsdb 保存到一个 conf.db 文件（JSON 格式）里面，通过 db.sock 提供服务。")]),t._v(" "),e("h3",{attrs:{id:"ovs-vswitchd-vswitchd"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ovs-vswitchd-vswitchd"}},[t._v("#")]),t._v(" ovs-vswitchd（vswitchd）")]),t._v(" "),e("p",[t._v("OvS 的核心部件，实现交换功能，与 Linux 内核兼容模块一起实现基于流的交换（Flow-based Switching）。它和上层 Controller 通信遵从 OpenFlow 协议，它与 ovsdb-server 通信遵从 OVSDB 协议，它和内核模块通过 netlink 进行通信，它支持多个独立的 Datapath（网桥），它通过更改 Flow Table 实现了 Binding（绑定）和 VLAN 等功能。是真正的虚拟交换机生命周期管理进程。它通过 db.sock 文件从 ovsdb-server 进程读取 conf.db 的配置信息（e.g. 用户所创建的虚拟交换机、所添加的网卡等等操作记录）。")]),t._v(" "),e("h3",{attrs:{id:"datapatch-openvswitch-ko"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#datapatch-openvswitch-ko"}},[t._v("#")]),t._v(" Datapatch（openvswitch.ko）")]),t._v(" "),e("p",[t._v("在 OvS 中，给一个交换机，或者说一个桥，用了一个专业的名词，叫做 DataPath！是一个 Linux Kernel 模块，监听网卡接口设备，获取网络包并交给 vSwitch 处理，支持数据在内核的交换。当 openvswtich.ko 被加载到了内核，会在网卡上注册一个钩子函数，每当有网络包到达网卡时，这个函数就会被调用，将网络包开始层层拆包（MAC 层，IP 层，TCP 层等），然后查看有没有已经定义好的策略来处理网络包（e.g. 修改 MAC，修改 IP，修改 TCP 端口，从哪个网卡发出去等等），如果找到了策略，则将网络包从网卡发出。这个处理过程全在内核完成，所以非常快，称之为 Fast Path。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211210021910.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("NOTE")]),t._v("：然而内核态并没有被分配太多内存，所以内核态能够保存的策略很少，往往有新的策略到来，老的策略就被丢弃。如果在内核态找不到策略，则需要到用户态去查询，网络包会通过 netlink（一种内核态与用户态交互的机制）发送给 vswitchd，vswitchd 有一个监听线程，当发现有从内核态发过来的包，就进入自己的处理流程。在用户态相对较慢，故称值为 Slow Path。用户态的 vswtichd 不需要吝啬内存，它包含了所有策略，这些策略都是 Controller（控制器）通过 OpenFlow 协议下发的。vswtichd 会根据网络包的信息层层匹配，直到找到一款策略进行处理。如果实在找不到，则一般会采用默认策略，比如丢弃这个包。当最终匹配到了一个策略之后，则会根据 “局部性原理” 再通过 netlink 协议，将这条策略下发到内核态，为了下一个相同类型的网络包能够直接从内核匹配到，以此加快执行效率。当这条策略下发给内核时，如果内核的内存空间不足，则会开始淘汰部分老策略。由于近因效应，接下来的网络包应该大概率能够匹配这条策略的。例如：传输一个文件，同类型的网络包会源源不断的到来。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211211010364.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"ovs-的工具集"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ovs-的工具集"}},[t._v("#")]),t._v(" OvS 的工具集")]),t._v(" "),e("ul",[e("li",[e("p",[e("strong",[t._v("ovs-vsctl")]),t._v("：用于获取、更改 ovs-vswitchd 的配置信息。")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("ovs-ofctl")]),t._v("：用于查询、控制 OvS 作为 OpenFlow 交换机工作时的流表内容。")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("ovs-pki")]),t._v("：用于创建、管理 OvS 与 Controller 之间的 SSL 通信框架。")])]),t._v(" "),e("li",[e("p",[e("strong",[t._v("ovs-dpctl")]),t._v("：用于配置 Switch 内核模块，可以控制转发规则。")])]),t._v(" "),e("li",[e("p",[t._v("ovs-appctl")]),t._v(" "),e("p",[t._v("：用于向 ovs-vswitchd 守护进程发送命令消息，一般用不上。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224120048163.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})])])]),t._v(" "),e("h3",{attrs:{id:"ovs-vsctl-常用指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ovs-vsctl-常用指令"}},[t._v("#")]),t._v(" ovs-vsctl 常用指令")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 查看 OvS Log 级别\novs-appctl vlog/list\n# 设置 Log 级别\novs-appctl vlog/set {module name}:{console, syslog, file}:{off, emer, err, warn, info, dbg}\n# 以 stp 设置 file 为 dbg level 为例\novs-appctl vlog/set stp:file:dbg\n\n# 查看 OvS 版本\novs-ofctl -V\n\n# 查询指令历史记录\novsdb-tool show-log [-mmm]\n\n# 修改 ofport (openflow port number) 为 100\novs-vsctl add-port <bridge> <interface> -- set Interface <interface> ofport_request=100\n# 设置 interface 为 internal\novs-vsctl set Interface <interface> type=internal\n\n# 开启指定 Bridge 的 STP\novs-vsctl set bridge <bridge> stp_enable=true\n# 关闭指定 Bridge 的 STP\novs-vsctl set bridge <bridge> stp_enable=false\n# 查询指定 Bridge 的 STP 的配置信息\novs-vsctl get bridge <bridge> stp_enable\n# 设置指定 Bridge 的 STP Priority\novs−vsctl set bridge <bridge> other_config:stp-priority=0x7800\n# 设置指定 Bridge 的 STP Cost\novs−vsctl set port <bridge> other_config:stp-path-cost=10\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br")])]),e("h2",{attrs:{id:"open-vswitch-的工作原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch-的工作原理"}},[t._v("#")]),t._v(" Open vSwitch 的工作原理")]),t._v(" "),e("p",[t._v("要理解 OvS 的工作原理，首先要了解网桥的工作原理。网桥也叫做桥接器，工作在数据链路层，将两个 LAN 连接，根据 MAC 地址来转发数据帧，可以看成一个 “低层的路由器”。网桥处理数据帧遵循以下几条规则：")]),t._v(" "),e("ul",[e("li",[t._v("在一个接口上接收到的帧不会再往那个接口上发送此帧。")]),t._v(" "),e("li",[t._v("每个接收到的帧都要学习其 Source MAC 地址。")]),t._v(" "),e("li",[t._v("如果数据帧是多播或者广播包（通过 2 层 MAC 地址确定）则要向接收端口以外的所有端口转发，如果上层协议感兴趣，则还会递交上层处理。")]),t._v(" "),e("li",[t._v("如果数据帧的地址不能在 CAM（MAC-Port Mapping）表中找到，则向接收端口以外的所有端口转发。")]),t._v(" "),e("li",[t._v("如果 CAM 表中能找到，则转发给相应端口，如果发送和接收都是同一个端口，则不发送。")]),t._v(" "),e("li",[t._v("网桥是以混杂模式工作的，所有 MAC 地址的数据帧都能够通过。")])]),t._v(" "),e("p",[t._v("Open vSwitch 的内核模块（openvswitch.ko）实现了多个 “数据路径（Datapath）”（类似于网桥），每个 Datapath 都可以有多个 vPorts（类似于网桥上的端口）。每个 Datapath 也通过关联流表（Flow Table）来定义数据流向，通常的操作都是将数据流转发到指定的 vPort 上。当网络包到达一个 vPort，内核模块所做的处理是提取其流的关键信息并在流表中查找这些关键信息，当有一个匹配的流时，就对该网络包执行相应的操作；如果没有匹配，则将网络包送到用户空间的处理队列中，用户空间可能会定义一个流用于以后碰到相同类型的网络包可以在内核中执行操作，这就是所谓的 Slow Path 和 Fast Path。")]),t._v(" "),e("p",[t._v("Open vSwitch 实现的流量控制很大部分上是通过 OpenFlow 交换协议实现的。OpenFlow 使 Controller 能够通过网络访问一个交换机或路由器的 Datapath。网管人员可以在任意一台计算机（Controller）上远程控制数据管理，这样他们就能够进行精细的路由和交换控制，并实现复杂的网络策略。有了 Open vSwitch 中的这些远程管理功能，云计算的集成商和供应商就能够向客户提供在一台计算机上持续管理各自虚拟网络、应用和策略的功能。")]),t._v(" "),e("h2",{attrs:{id:"openvswitch-的典型工作流程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#openvswitch-的典型工作流程"}},[t._v("#")]),t._v(" OpenvSwitch 的典型工作流程")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224133735630.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("ol",[e("li",[t._v("Instance 产生一个数据包并发送至虚拟网络接口 vNIC（Instance eth0）。")]),t._v(" "),e("li",[t._v("这个数据包传递到物理机的 vNIC 接口（vnet）。")]),t._v(" "),e("li",[t._v("数据包从 vnet 出来，到达 Bridge br100 上。")]),t._v(" "),e("li",[t._v("数据包经过 Bridge 的处理，从物理节点上的 NIC（eth0）发出。")]),t._v(" "),e("li",[t._v("数据包从 eth0 出去后，按照宿主机的路由以及默认网关操作。此时该数据包已经不再受你控制了。")])]),t._v(" "),e("p",[t._v("NOTE：L2 Switch 连接到宿主机的 eth0 通常是一个 Trunk 口，因为虚拟机对应的 vnet 往往会设置 VLAN TAG 来隔离虚拟机的广播域。所以 eth0 就相当于一个 Trunk 口，而 vnets 就相当于 Access 口。")]),t._v(" "),e("h2",{attrs:{id:"open-vswitch-的安装部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch-的安装部署"}},[t._v("#")]),t._v(" Open vSwitch 的安装部署")]),t._v(" "),e("p",[e("strong",[t._v("OS")]),t._v("：CentOS7")]),t._v(" "),e("p",[e("strong",[t._v("Step1")]),t._v(". 关闭 SELinux，否则 ovsdb-server Manager 无法正常工作。")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# setenforce 0\n\n[root@localhost ~]# cat /etc/selinux/config | grep -v ^#\nSELINUX=disabled\nSELINUXTYPE=targeted\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[e("strong",[t._v("Step 2")]),t._v(". yum install")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("yum install openvswitch openvswitch-test\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("strong",[t._v("Step 3")]),t._v(". 启动服务")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("systemctl enable openvswitch\nsystemctl start openvswitch\nsystemctl status openvswitch\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("查看当前的 OvS 版本:")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[t._v("查看 OvS 服务进程清单：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ovsdb-server /etc/openvswitch/conf.db \n    -vconsole:emer -vsyslog:err \n    -vfile:info \n    --remote=punix:/var/run/openvswitch/db.sock \n    --private-key=db:Open_vSwitch,SSL,private_key \n    --certificate=db:Open_vSwitch,SSL,certificate \n    --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert --no-chdir \n    --log-file=/var/log/openvswitch/ovsdb-server.log \n    --pidfile=/var/run/openvswitch/ovsdb-server.pid\n    --detach \n    --monitor\n\novs-vswitchd unix:/var/run/openvswitch/db.sock \n    -vconsole:emer \n    -vsyslog:err \n    -vfile:info \n    --mlockall \n    --no-chdir \n    --log-file=/var/log/openvswitch/ovs-vswitchd.log \n    --pidfile=/var/run/openvswitch/ovs-vswitchd.pid \n    --detach \n    --monitor\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br")])]),e("p",[t._v("查看加载的内核模块：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# lsmod | grep openvswitch\nopenvswitch            70743  0\nvxlan                  37584  1 openvswitch\ngre                    13808  1 openvswitch\nlibcrc32c              12644  2 xfs,openvswitch\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[t._v("从架构图可知，ovsdb-server 与 ovs-vswitchd 可以通过 UNIX Domain Socket（/var/run/openvswitch/db.sock）进行互相通信。")]),t._v(" "),e("h2",{attrs:{id:"open-vswitch-的-db-ovs-db"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch-的-db-ovs-db"}},[t._v("#")]),t._v(" Open vSwitch 的 DB（ovs-db）")]),t._v(" "),e("p",[t._v("ovs-db 在操作系统上的载体是 JSON 文件 /etc/openvswitch/conf.db，通过执行指令 "),e("code",[t._v("ovsdb-client dump")]),t._v(" 可以查看其内容，e.g.")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovsdb-client dump\nBridge table\n_uuid controller datapath_id datapath_type external_ids fail_mode flood_vlans flow_tables ipfix mirrors name netflow other_config ports protocols sflow status stp_enable\n----- ---------- ----------- ------------- ------------ --------- ----------- ----------- ----- ------- ---- ------- ------------ ----- --------- ----- ------ ----------\n\nController table\n_uuid connection_mode controller_burst_limit controller_rate_limit enable_async_messages external_ids inactivity_probe is_connected local_gateway local_ip local_netmask max_backoff other_config role status target\n----- --------------- ---------------------- --------------------- --------------------- ------------ ---------------- ------------ ------------- -------- ------------- ----------- ------------ ---- ------ ------\n\nFlow_Sample_Collector_Set table\n_uuid bridge external_ids id ipfix\n----- ------ ------------ -- -----\n\nFlow_Table table\n_uuid flow_limit groups name overflow_policy\n----- ---------- ------ ---- ---------------\n\nIPFIX table\n_uuid cache_active_timeout cache_max_flows external_ids obs_domain_id obs_point_id sampling targets\n----- -------------------- --------------- ------------ ------------- ------------ -------- -------\n\nInterface table\n_uuid admin_state bfd bfd_status cfm_fault cfm_fault_status cfm_health cfm_mpid cfm_remote_mpids cfm_remote_opstate duplex external_ids ifindex ingress_policing_burst ingress_policing_rate lacp_current link_resets link_speed link_state mac mac_in_use mtu name ofport ofport_request options other_config statistics status type\n----- ----------- --- ---------- --------- ---------------- ---------- -------- ---------------- ------------------ ------ ------------ ------- ---------------------- --------------------- ------------ ----------- ---------- ---------- --- ---------- --- ---- ------ -------------- ------- ------------ ---------- ------ ----\n\nManager table\n_uuid connection_mode external_ids inactivity_probe is_connected max_backoff other_config status target\n----- --------------- ------------ ---------------- ------------ ----------- ------------ ------ ------\n\nMirror table\n_uuid external_ids name output_port output_vlan select_all select_dst_port select_src_port select_vlan statistics\n----- ------------ ---- ----------- ----------- ---------- --------------- --------------- ----------- ----------\n\nNetFlow table\n_uuid active_timeout add_id_to_interface engine_id engine_type external_ids targets\n----- -------------- ------------------- --------- ----------- ------------ -------\n\nOpen_vSwitch table\n_uuid                                bridges cur_cfg db_version external_ids                                       manager_options next_cfg other_config ovs_version ssl statistics system_type system_version\n------------------------------------ ------- ------- ---------- -------------------------------------------------- --------------- -------- ------------ ----------- --- ---------- ----------- --------------\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f []      0       "7.3.0"    {system-id="257b9b47-87e7-4404-9af8-37f98b04f2bd"} []              0        {}           "2.0.0"     []  {}         unknown     unknown       \n\nPort table\n_uuid bond_downdelay bond_fake_iface bond_mode bond_updelay external_ids fake_bridge interfaces lacp mac name other_config qos statistics status tag trunks vlan_mode\n----- -------------- --------------- --------- ------------ ------------ ----------- ---------- ---- --- ---- ------------ --- ---------- ------ --- ------ ---------\n\nQoS table\n_uuid external_ids other_config queues type\n----- ------------ ------------ ------ ----\n\nQueue table\n_uuid dscp external_ids other_config\n----- ---- ------------ ------------\n\nSSL table\n_uuid bootstrap_ca_cert ca_cert certificate external_ids private_key\n----- ----------------- ------- ----------- ------------ -----------\n\nsFlow table\n_uuid agent external_ids header polling sampling targets\n----- ----- ------------ ------ ------- -------- -------\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br"),e("span",{staticClass:"line-number"},[t._v("29")]),e("br"),e("span",{staticClass:"line-number"},[t._v("30")]),e("br"),e("span",{staticClass:"line-number"},[t._v("31")]),e("br"),e("span",{staticClass:"line-number"},[t._v("32")]),e("br"),e("span",{staticClass:"line-number"},[t._v("33")]),e("br"),e("span",{staticClass:"line-number"},[t._v("34")]),e("br"),e("span",{staticClass:"line-number"},[t._v("35")]),e("br"),e("span",{staticClass:"line-number"},[t._v("36")]),e("br"),e("span",{staticClass:"line-number"},[t._v("37")]),e("br"),e("span",{staticClass:"line-number"},[t._v("38")]),e("br"),e("span",{staticClass:"line-number"},[t._v("39")]),e("br"),e("span",{staticClass:"line-number"},[t._v("40")]),e("br"),e("span",{staticClass:"line-number"},[t._v("41")]),e("br"),e("span",{staticClass:"line-number"},[t._v("42")]),e("br"),e("span",{staticClass:"line-number"},[t._v("43")]),e("br"),e("span",{staticClass:"line-number"},[t._v("44")]),e("br"),e("span",{staticClass:"line-number"},[t._v("45")]),e("br"),e("span",{staticClass:"line-number"},[t._v("46")]),e("br"),e("span",{staticClass:"line-number"},[t._v("47")]),e("br"),e("span",{staticClass:"line-number"},[t._v("48")]),e("br"),e("span",{staticClass:"line-number"},[t._v("49")]),e("br"),e("span",{staticClass:"line-number"},[t._v("50")]),e("br"),e("span",{staticClass:"line-number"},[t._v("51")]),e("br"),e("span",{staticClass:"line-number"},[t._v("52")]),e("br"),e("span",{staticClass:"line-number"},[t._v("53")]),e("br"),e("span",{staticClass:"line-number"},[t._v("54")]),e("br"),e("span",{staticClass:"line-number"},[t._v("55")]),e("br"),e("span",{staticClass:"line-number"},[t._v("56")]),e("br"),e("span",{staticClass:"line-number"},[t._v("57")]),e("br"),e("span",{staticClass:"line-number"},[t._v("58")]),e("br"),e("span",{staticClass:"line-number"},[t._v("59")]),e("br"),e("span",{staticClass:"line-number"},[t._v("60")]),e("br"),e("span",{staticClass:"line-number"},[t._v("61")]),e("br")])]),e("p",[t._v("使用图形化工具可以更加友好的查看：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211222543110.png",alt:"img"}})]),t._v(" "),e("p",[t._v("数据库表之间的关系如下图所示：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190217203611578.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("其中 Open_vSwitch 表是 OvS DB 的 root（根）。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190217203820944.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190211223634231.png",alt:"img"}})]),t._v(" "),e("p",[t._v("它的表结构如下图，记录 ovs-vswitchd 的配置信息，e.g.")]),t._v(" "),e("ul",[e("li",[t._v("Bridge 设备的配置")]),t._v(" "),e("li",[t._v("OvS 本身的配置\n"),e("ul",[e("li",[t._v("other_config:stats-update-interval：将统计信息写入数据库的间隔时间")]),t._v(" "),e("li",[t._v("other_config:flow-restore-wait： 针对 hot-upgrade，如果为 True 则不处理任何包。一般使用的过程为：先停掉 ovs-vswitchd，然后将这个值设为 True，再启动 ovs-vswitchd。这个时候不处理任何包，然后使用 ovs-ofctl 将 flow table restore 到一个正确的状态，最后设置这个值为 False，开始处理包。")]),t._v(" "),e("li",[t._v("other_config:flow-limit：指定 Flow Table 中 flow entry（入口）的数量")]),t._v(" "),e("li",[t._v("other_config:n-handler-threads：用于处理新 Flow 的线程数")]),t._v(" "),e("li",[t._v("other_config:n-revalidator-threads：用于验证 Flow 的线程数")]),t._v(" "),e("li",[t._v("other_config:enable-statistics：是否统计以下项目\n"),e("ul",[e("li",[t._v("statistics:cpu：统计 CPU 数量，线程")]),t._v(" "),e("li",[t._v("statistics:load_average：system load")]),t._v(" "),e("li",[t._v("statistics:memory：总 RAM，Swap")]),t._v(" "),e("li",[t._v("statistics:process_NAME：统计 memory size, cpu time 等（with NAME replaced by a process name）")]),t._v(" "),e("li",[t._v("statistics:file_systems：mount point, size, used")])])]),t._v(" "),e("li",[t._v("client request id：cur_cfg 和 next_cfg，当一个 Client 修改完数据库时，next_cfg 加 1，然后等待 OvS 应用这些修改，当应用完毕，则 cur_cfg 加 1，此时 cur_cfg 等于 next_cfg。显然，该配置是为了保证高并发请求的一致性而存在的。")]),t._v(" "),e("li",[t._v("对 ovsdb-server 的配置，指向 Manager 表，ovs-vswitchd 作为 ovsdb-server 的 Client 之一，Manager 配置了 DB Connection 的字段。")]),t._v(" "),e("li",[t._v("对 SSL DB Connection 的配置：指向 SSL 表，主要配置 SSL 安全通信所需要的 private key、certificate 等文件的路径。")])])])]),t._v(" "),e("h1",{attrs:{id:"open-vswitch-的操作对象"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#open-vswitch-的操作对象"}},[t._v("#")]),t._v(" Open vSwitch 的操作对象")]),t._v(" "),e("p",[t._v("数据库结构是一款软件的资源模型设计的映射，下文主要根据 OvS 的资源模型来依次认识每种资源对象的特性与作用。")]),t._v(" "),e("h2",{attrs:{id:"manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#manager"}},[t._v("#")]),t._v(" Manager")]),t._v(" "),e("p",[t._v("Manager 对象都是为了配置 ovsdb-server 的 Connection，让 Clients（e.g. ovs-vswitchd、ovs-vsctl、host） 可以远程对 ovsdb-server 执行 DB Operation。")]),t._v(" "),e("p",[t._v("从上述架构图可知，ovsdb-server 是 ovs-db 提供管理的 RPC 接口。加载了 Open_vSwitch 表中的 manager_options 字段值来作为监听端口。")]),t._v(" "),e("p",[e("strong",[t._v("Manager 的表结构")]),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019021122202838.png",alt:"img"}})]),t._v(" "),e("p",[t._v("其中最重要的字段是 "),e("strong",[t._v("target")]),t._v("，记录了 ovsdb-server 的监听参数信息：")]),t._v(" "),e("ul",[e("li",[t._v("Active（主动）database connection methods：\n"),e("ul",[e("li",[e("code",[t._v("ssl:ip[:port]")]),t._v("：监听在指定 Remote IP 的 Port 上，协议为 SSL")]),t._v(" "),e("li",[e("code",[t._v("tcp:ip[:port]")]),t._v("：监听在指定 Remote IP 的 Port 上，协议为 TCP")]),t._v(" "),e("li",[e("code",[t._v("unix:FILE")]),t._v("：Unix domain socket named FILE")])])]),t._v(" "),e("li",[t._v("Passive（被动）database connection methods:\n"),e("ul",[e("li",[e("code",[t._v("pssl:[port][:ip]")]),t._v("：监听在本机 IP 的指定 Port 上，协议为 SSL")]),t._v(" "),e("li",[e("code",[t._v("ptcp:[port][:ip]")]),t._v("：监听在本机 IP 的指定 Port 上，协议为 TCP")])])])]),t._v(" "),e("p",[t._v("通过下述指令设置：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ovs-vsctl set-manager TARGET...      # set the list of managers to TARGET...\n\n# Active Listener\novs-vsctl set-manager tcp:1.2.3.4:6640\n# Passive Listener \novs-vsctl set-manager ptcp:6640\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v("：基于 TCP 的 DB Connection，使得 ovs-vsctl 在远程机器上也可以控制 ovsdb-server。")]),t._v(" "),e("h3",{attrs:{id:"配置-manager-ovs-db-connection"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-manager-ovs-db-connection"}},[t._v("#")]),t._v(" 配置 Manager OvS DB Connection")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    ovs_version: "2.0.0"\n\n[root@localhost ~]# ovs-vsctl set-manager ptcp:8881\n\n[root@localhost ~]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "ptcp:8881"\n    ovs_version: "2.0.0"\n\n[root@localhost ~]# ovsdb-client dump\n...\nManager table\n_uuid                                connection_mode external_ids inactivity_probe is_connected max_backoff other_config status                                                               target\n------------------------------------ --------------- ------------ ---------------- ------------ ----------- ------------ -------------------------------------------------------------------- -----------\n84f0a33c-a798-40fc-a285-ed4d83121d3e []              {}           []               false        []          {}           {bound_port="8881", sec_since_connect="0", sec_since_disconnect="0"} "ptcp:8881"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br")])]),e("p",[t._v("检查 Port 是否正常开启：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# netstat -lpntu | grep 8881\ntcp        0      0 0.0.0.0:8881            0.0.0.0:*               LISTEN      3024/ovsdb-server\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("p",[t._v("从远程计算机上执行连接：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovs-vsctl --db=tcp:192.168.1.109:8881 show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "ptcp:8881"\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v("：注意防火墙的干扰因素。")]),t._v(" "),e("h2",{attrs:{id:"ssl"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ssl"}},[t._v("#")]),t._v(" SSL")]),t._v(" "),e("p",[t._v("如果将 Open vSwitch 配置为通过网络连接到 OpenFlow 控制器（ovs-vswitchd 与 ovs-controller 之间），那么建议你使用 OpenSSL 来构建安全的网络通讯，双向的 SSL 互相可确保 OpenFlow 连接的完整性和与安全。")]),t._v(" "),e("p",[t._v("想建立 SSL 连接，首先要获取相关的 CA 证书，并将这些证书记录到 SSL 表中。启动 ovsdb-server 时，通过选项 "),e("code",[t._v("--private-key=db:Open_vSwitch,SSL,private_key --certificate=db:Open_vSwitch,SSL,certificate --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert")]),t._v(" 来指定应用这些参数。")]),t._v(" "),e("p",[e("strong",[t._v("SSL 表结构")]),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/201902112257078.png",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("SSL 表属性")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("private_key：私钥")]),t._v(" "),e("li",[t._v("ca_cert：CA 根证书")]),t._v(" "),e("li",[t._v("bootstrap_ca_cert（Boolean）：如果为 True，则每次启动 ovsdb-server，都会向 Controller 获取最新的 CA 证书。否则，就继续使用旧的 CA 证书。")]),t._v(" "),e("li",[t._v("certificate：CA 签发的证书")])]),t._v(" "),e("p",[t._v("其中主机（客户端）的 Public key 包含在 CA 签发的证书（certificate）内，然后再由 CA 中心的 private key 进行签名，CA 中心来担保这个 certificate 是合法的。为了验证 CA 签名，还需要 CA 的 public key，并放到 ca_cert 指向的 CA 证书里面。而 CA 本身的 public key 也需要被签名更高级的 CA 或者 CA（根 CA）自己担保。")]),t._v(" "),e("p",[e("strong",[t._v("SSL 验证流程")]),t._v("：")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("客户端持有 CA 根证书（ca_cert）并与 CA 的私钥进行验证（CA 根证书由 CA 通过自己的私钥进行自签发），验证成功则说明该 CA 是 root CA，可以自己担保自己。")])]),t._v(" "),e("li",[e("p",[t._v("客户端持有 CA 签发的证书（certificate，内含客户端公钥）并与 CA 根证书进行验证（由 CA 签发的证书可以使用 CA 私钥解开），如果验证成功则返回客户端的公钥。")])]),t._v(" "),e("li",[e("p",[t._v("客户端持有自己的私钥并与 CA 解开的客户端公钥进行验证，验证成功，则说明该客户端是受到 CA 担保的。")])]),t._v(" "),e("li",[e("p",[t._v("客户端与服务器建立 SSL 连接。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/201902231717450.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("简而言之，客户端需要保证持有自己的私钥、CA 签发的证书、CA 根证书才可以完成 SSL 验证。更多 CA 自签发的内容，请浏览")]),t._v(" "),e("p",[t._v("《自建 CA 中心并签发 CA 证书》")]),t._v(" "),e("p",[t._v("。")])])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 查询 SSL 连接\novs-vsctl get-ssl\n# 设置 SSL 证书\novs-vsctl set-ssl sc-privkey.pem sc-cert.pem cacert.pem\n# 删除 SSL 连接\novs-vsctl del-ssl\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("h3",{attrs:{id:"配置-ssl-connection"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-ssl-connection"}},[t._v("#")]),t._v(" 配置 SSL Connection")]),t._v(" "),e("p",[e("strong",[t._v("自签发 CA 根证书")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("Step 1. 生成 CA 根证书的 RSA 私钥")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("mkdir ~/OVS_CA\ncd ~/OVS_CA\n\nopenssl genrsa -out caprivate.key 1024\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("ul",[e("li",[t._v("Step 2. 生成 CA 根证书的签名请求（CSR）")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('openssl req -key caprivate.key -new -subj "/C=CN/ST=CN/L=CN/O=CN/CN=fanguiju@163.com" -out cacertificate.req\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("Step 3. 自签发 CA 根证书（内含了 CA 的公钥）")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("openssl x509 -req -in cacertificate.req -signkey caprivate.key -out cacertificate.pem\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("strong",[t._v("PS")]),t._v("：自签发即自己担保自己，用自己的私钥对自己的 CSR 进行签发，所以也称为根证书。")]),t._v(" "),e("p",[e("strong",[t._v("签发客户端证书")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("Step 1. 生成客户端私钥")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("mkdir ~/ClientCerts\ncd ~/ClientCerts\n\nopenssl genrsa -out cliu8private.key 1024\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("ul",[e("li",[t._v("Step 2. 生成客户端签名请求")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('openssl req -key cliu8private.key -new -subj "/C=CN/ST=CN/L=CN/O=CN/CN=cliu8@163.com" -out cliu8certificate.req\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("Step 3. CA 中心签发客户端证书（CA 中心担保该客户端)")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("cp ~/OVS_CA/caprivate.key ~/OVS_CA/cacertificate.pem ~/ClientCerts\n\nopenssl x509 -req -in cliu8certificate.req -CA cacertificate.pem -CAkey caprivate.key -out cliu8certificate.pem -CAcreateserial\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[e("strong",[t._v("配置 SSL Connection")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ovs-vsctl del-manager\novs-vsctl set-manager pssl:8881\novs-vsctl set-ssl /root/ClientCerts/cliu8private.key /root/ClientCerts/cliu8certificate.pem /root/OVS_CA/cacertificate.pem\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v("：set-ssl 一定要指定绝对路径，否则无法正确载入证书文件。")]),t._v(" "),e("p",[e("strong",[t._v("查看修改")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost newcerts]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "pssl:8881"\n    ovs_version: "2.0.0"\n\n[root@localhost ~]# ovsdb-client dump\n...\nSSL table\n_uuid                                bootstrap_ca_cert ca_cert                          certificate                              external_ids private_key\n------------------------------------ ----------------- -------------------------------- ---------------------------------------- ------------ ------------------------------------\nf8d8f0f5-f87b-430b-9d48-123a74a6804f false             "/root/OVS_CA/cacertificate.pem" "/root/ClientCerts/cliu8certificate.pem" {}           "/root/ClientCerts/cliu8private.key"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br")])]),e("p",[e("strong",[t._v("验证")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("此时如果不输入 PKI 配置则无法通过 SSL 认证")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# ovs-vsctl --db=ssl:192.168.1.109:8881 show\n2019-02-23T06:46:26Z|00001|stream_ssl|ERR|Private key must be configured to use SSL\n2019-02-23T06:46:26Z|00002|stream_ssl|ERR|Certificate must be configured to use SSL\n2019-02-23T06:46:26Z|00003|stream_ssl|ERR|CA certificate must be configured to use SSL\n2019-02-23T06:46:26Z|00004|reconnect|WARN|ssl:192.168.1.109:8881: connection attempt failed (Protocol not available)\novs-vsctl: ssl:192.168.1.109:8881: database connection failed (Protocol not available)\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("ul",[e("li",[t._v("将 cliu8private.key、cliu8certificate.pem、cacertificate.pem 的副本复制到客户端")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("scp cliu8private.key cliu8certificate.pem cacertificate.pem root@192.168.1.110:~/certs\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("在客户端请求建立 SSL 连接")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost certs]#  ovs-vsctl --db=ssl:192.168.1.109:8881 --private-key=cliu8private.key --certificate=cliu8certificate.pem --ca-cert=cacertificate.pem show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "pssl:8881"\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v(":")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("PKI configuration (required to use SSL):\n  -p, --private-key=FILE  file with private key\n  -c, --certificate=FILE  file with certificate for private key\n  -C, --ca-cert=FILE      file with peer CA certificate\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("h2",{attrs:{id:"bridge"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#bridge"}},[t._v("#")]),t._v(" Bridge")]),t._v(" "),e("p",[t._v("Bridge 即网桥，但在 Linux 的语义中 Bridge 与 vSwitch 具有相同的含义，可见 Bridge 正式 Open vSwitch 最为核心的对象与概念。关于 Bridge 的概念不再多谈，更详细的内容可以浏览《Networking 基本术语 / 概念》一文。下面主要记录了 OvS 关于 Bridge 的常见操作。")]),t._v(" "),e("h3",{attrs:{id:"bridge-常用操作指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#bridge-常用操作指令"}},[t._v("#")]),t._v(" Bridge 常用操作指令")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Bridge commands:\n  add-br BRIDGE               create a new bridge named BRIDGE\n  add-br BRIDGE PARENT VLAN   create new fake BRIDGE in PARENT on VLAN\n  del-br BRIDGE               delete BRIDGE and all of its ports\n  list-br                     print the names of all the bridges\n  br-exists BRIDGE            exit 2 if BRIDGE does not exist\n  br-to-vlan BRIDGE           print the VLAN which BRIDGE is on\n  br-to-parent BRIDGE         print the parent of BRIDGE\n  br-set-external-id BRIDGE KEY VALUE  set KEY on BRIDGE to VALUE\n  br-set-external-id BRIDGE KEY  unset KEY on BRIDGE\n  br-get-external-id BRIDGE KEY  print value of KEY on BRIDGE\n  br-get-external-id BRIDGE  list key-value pairs on BRIDGE\n\n# Bridge 管理操作\novs-vsctl show\novs-vsctl add-br <bridge>\novs-vsctl del-br <bridge>\novs-vsctl --if-exists del-br <bridge>\novs-vsctl add-port <bridge> <port>|<interface>\novs-vsctl del-port <bridge> <port>|<interface>\novs-vsctl list <bridge>|<port>|<interface>\novs-vsctl list bridge <bridge>\n# 创建 Bridge 的同时为 Bridge 添加 Port/Interface\novs−vsctl add−br <bridge> -- add−port <bridge> <port>|<interface>\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190223203120317.png",alt:"img"}})]),t._v(" "),e("ul",[e("li",[t._v("创建虚拟交换机：")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovs-vsctl add-br ubuntu_br\n[root@localhost ~]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "ptcp:8881"\n    Bridge ubuntu_br\n        Port ubuntu_br\n            Interface ubuntu_br\n                type: internal\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br")])]),e("ul",[e("li",[t._v("创建虚拟 “网线”（VETH pair）：")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# ip link add first_br type veth peer name first_if\n[root@localhost ~]# ip link add second_br type veth peer name second_if\n[root@localhost ~]# ip link add third_br type veth peer name third_if\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("ul",[e("li",[t._v("查看新建的设备：")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# ip l\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: eno16777736: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP mode DEFAULT qlen 1000\n    link/ether 00:0c:29:a2:2e:a4 brd ff:ff:ff:ff:ff:ff\n3: ovs-system: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether f6:66:5f:f9:ba:17 brd ff:ff:ff:ff:ff:ff\n4: ubuntu_br: <BROADCAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UNKNOWN mode DEFAULT qlen 1000\n    link/ether 46:ca:9f:ed:0b:46 brd ff:ff:ff:ff:ff:ff\n5: virbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DEFAULT qlen 1000\n    link/ether 52:54:00:69:fc:47 brd ff:ff:ff:ff:ff:ff\n6: virbr0-nic: <BROADCAST,MULTICAST> mtu 1500 qdisc pfifo_fast master virbr0 state DOWN mode DEFAULT qlen 1000\n    link/ether 52:54:00:69:fc:47 brd ff:ff:ff:ff:ff:ff\n7: vnet0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen 1000\n    link/ether fe:54:00:b8:9a:cf brd ff:ff:ff:ff:ff:ff\n8: vnet1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen 1000\n    link/ether fe:54:00:43:07:06 brd ff:ff:ff:ff:ff:ff\n9: vnet2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN mode DEFAULT qlen 1000\n    link/ether fe:54:00:ce:e6:40 brd ff:ff:ff:ff:ff:ff\n10: first_if@first_br: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether 46:df:83:a6:66:bc brd ff:ff:ff:ff:ff:ff\n11: first_br@file_if: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether 72:90:6d:0d:4b:e0 brd ff:ff:ff:ff:ff:ff\n12: second_if@second_br: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether 6a:68:8f:38:86:a2 brd ff:ff:ff:ff:ff:ff\n13: second_br@second_if: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether 86:8d:e3:32:03:b4 brd ff:ff:ff:ff:ff:ff\n14: third_if@third_br: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether 5e:72:4c:9b:4d:18 brd ff:ff:ff:ff:ff:ff\n15: third_br@third_if: <BROADCAST,MULTICAST,M-DOWN> mtu 1500 qdisc noop state DOWN mode DEFAULT qlen 1000\n    link/ether a2:cf:5f:72:da:23 brd ff:ff:ff:ff:ff:ff\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br"),e("span",{staticClass:"line-number"},[t._v("22")]),e("br"),e("span",{staticClass:"line-number"},[t._v("23")]),e("br"),e("span",{staticClass:"line-number"},[t._v("24")]),e("br"),e("span",{staticClass:"line-number"},[t._v("25")]),e("br"),e("span",{staticClass:"line-number"},[t._v("26")]),e("br"),e("span",{staticClass:"line-number"},[t._v("27")]),e("br"),e("span",{staticClass:"line-number"},[t._v("28")]),e("br"),e("span",{staticClass:"line-number"},[t._v("29")]),e("br"),e("span",{staticClass:"line-number"},[t._v("30")]),e("br"),e("span",{staticClass:"line-number"},[t._v("31")]),e("br")])]),e("ul",[e("li",[t._v("将虚拟 “网线” 的一端接入虚拟交换机：")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# ovs-vsctl add-port ubuntu_br first_br\n[root@localhost ~]# ovs-vsctl add-port ubuntu_br second_br\n[root@localhost ~]# ovs-vsctl add-port ubuntu_br third_br\n\n[root@localhost ~]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "ptcp:8881"\n    Bridge ubuntu_br\n        Port ubuntu_br\n            Interface ubuntu_br\n                type: internal\n        Port first_br\n            Interface first_br\n        Port second_br\n            Interface second_br\n        Port third_br\n            Interface third_br\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br")])]),e("p",[t._v("NOTE：Bridge ubuntu_br 的同名 Port，一般就是 Bridge 的管理端口了，类比物理交换机的管理端口，一般会为其配置 IP 地址。")]),t._v(" "),e("h2",{attrs:{id:"controller"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#controller"}},[t._v("#")]),t._v(" Controller")]),t._v(" "),e("p",[t._v("OvS 是一个 OpenFlow Switch 实现，可以通过 OpenFlow Controller（OpenFlow 协议）对所有分布式的 Bridge 进行统一管理。所谓 “管理”，实际上是对 Bridge 的 Flow Table 的管理。"),e("strong",[t._v("SDN Controller 的核心是控制策略的下发，并以此来决策数据的流向")]),t._v("。")]),t._v(" "),e("p",[e("strong",[t._v("Controller 有两种类型")]),t._v("：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Primary Controller")]),t._v("：真正控制 Bridge 的 Flow Table，Bridge 会保持与 Controller 的连接，如果连接失败或断开，取决于 Bridge 的 Fail Mode 来进行处理。一个 Bridge 可以连接到多个 Controller，但是 Controller 之间的协作需要 Controller 自己来完成。")]),t._v(" "),e("li",[e("strong",[t._v("Service Controller")]),t._v("：仅仅用于 Support，偶尔操作，Maintain 使用，如果 Connection 与 Bridge 断开连接，Bridge 的 Fail Mode 也不会起作用。")])]),t._v(" "),e("p",[e("strong",[t._v("OvS 为 Bridge 提供了下列两种 Fail Mode")]),t._v("：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Secure")]),t._v("：断开连接后 Bridge 会试图重连 Controller 直至成功，并不会自己维护 Flow Table。")]),t._v(" "),e("li",[e("strong",[t._v("Standalone")]),t._v("：若 Bridge 尝试三次依旧连接不上 Controller，则会自己建立并维护独立的 Flow Table。")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 查询 Bridge 的 Fail Mode\novs-vsctl get-fail-mode ovs-br\n# 设置 Bridge 的 Fail Mode\novs-vsctl set-fail-mode ovs-br standalone\novs-vsctl set-fail-mode ovs-br secure\n# 移除 Bridge 的 Fail Mode\novs-vsctl del-fail-mode ovs-br\n\n# 查看 Bridge 和 Controller 的连接模式\novs-vsctl get controller ovs-br connection-mode\n# 设置 Out-of-band 连接模式\novs-vsctl set controller ovs-br connection-mode=out-of-band\n# 设置 In-band (default) 连接模式\novs-vsctl set controller ovs-br connection-mode=in-band\n# 移除 hidden flow\novs-vsctl set bridge br0 other-config:disable-in-band=true\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br")])]),e("p",[e("strong",[t._v("Controller 表结构")]),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190212095504186.png",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"controller-常用指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#controller-常用指令"}},[t._v("#")]),t._v(" Controller 常用指令")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 设置 Controller\novs-vsctl set-controller <bridge> tcp:<controller_ip>:6633\n# 设置 Multi Controller\novs-vsctl set-controller <bridge> tcp:<controller_ip1>:6633 tcp:<controller_ip2>:6633\n# 获取 Bridge 的 Controller\novs-vsctl get-controller <bridge>\n# 移除 Controller\novs-vsctl del-controller <bridge>\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("h3",{attrs:{id:"安装-floodlight"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-floodlight"}},[t._v("#")]),t._v(" 安装 Floodlight")]),t._v(" "),e("p",[t._v("OpenFlow Controller 的种类繁多，常见有如 OpenDaylight 等等，详细清单可浏览《"),e("a",{attrs:{href:"http://groups.geni.net/geni/wiki/OpenFlow/Controllers",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenFlow Controllers in GENI"),e("OutboundLink")],1),t._v("》。本篇以 Floodlight 为例，感受 Controller 对 Bridge 的流量控制功能。")]),t._v(" "),e("p",[t._v("官方网站：http://www.projectfloodlight.org/getting-started/\n官方部署手册：https://floodlight.atlassian.net/wiki/spaces/floodlightcontroller/pages/1343544/Installation+Guide")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190223213213461.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("Installing Floodlight")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("git clone git://github.com/floodlight/floodlight.git\ncd floodlight/\ngit submodule init\ngit submodule update\nant\n\nsudo mkdir /var/lib/floodlight\nsudo mkdir /var/log/floodlight\nsudo chmod 777 /var/lib/floodlight\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v("： 这里使用的是 Tag 1.2 版本")]),t._v(" "),e("p",[e("strong",[t._v("Running Floodlight in the Terminal")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("nohup java -jar ~/floodlight/target/floodlight.jar > /var/log/floodlight/floodlight.log 2>&1 &\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("strong",[t._v("检查 Controller 的监听端口")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost ~]# cat /var/log/floodlight/floodlight.log | grep "Listening for switch connections"\n09:28:16.102 INFO [n.f.c.i.OFSwitchManager:main] Listening for switch connections on /0.0.0.0:6653\n\n[root@localhost ~]# netstat -lpntu | grep 6653\ntcp6       0      0 :::6653                 :::*                    LISTEN      20159/java\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[t._v("NOTE：Floodlight 会通过监听 "),e("code",[t._v("/0.0.0.0:6653")]),t._v(" Socket 来获取 Bridge 的连接。")]),t._v(" "),e("p",[e("strong",[t._v("将 Bridge 连接到 Controller")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('[root@localhost floodlight-1.2]# ovs-vsctl set-controller ubuntu_br tcp:192.168.1.109:6653\n[root@localhost floodlight-1.2]# ovs-vsctl show\n2028eafc-e1db-4ea8-b0fc-30a21fdaca0f\n    Manager "ptcp:8881"\n    Bridge ubuntu_br\n        Controller "tcp:192.168.1.109:6633"\n        Port ubuntu_br\n            Interface ubuntu_br\n                type: internal\n        Port third_br\n            Interface third_br\n        Port first_br\n            Interface first_br\n        Port second_br\n            Interface second_br\n    ovs_version: "2.0.0"\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br")])]),e("p",[t._v("NOTE：Bridge 连接到 Controller 之后，Controller 就可以收集、下发、管理 Bridge 的相关信息了（e.g. Flow Table）。")]),t._v(" "),e("p",[e("strong",[t._v("访问 Web GUI")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("http://192.168.1.109:8080/ui/index.html\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"将-kvm-虚拟机接入-ovs-bridge"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#将-kvm-虚拟机接入-ovs-bridge"}},[t._v("#")]),t._v(" 将 KVM 虚拟机接入 OvS Bridge")]),t._v(" "),e("p",[e("strong",[t._v("将三台 KVM 虚拟机接入到 Bridge")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("[root@localhost ~]# virsh domiflist VM1\nInterface  Type       Source     Model       MAC\n-------------------------------------------------------\nmacvtap1   direct     ubuntu_br  rtl8139     52:54:00:b8:9a:cf\n\n[root@localhost ~]# virsh domiflist VM2\nInterface  Type       Source     Model       MAC\n-------------------------------------------------------\nmacvtap0   direct     ubuntu_br  rtl8139     52:54:00:43:07:06\n\n[root@localhost ~]# virsh domiflist VM3\nInterface  Type       Source     Model       MAC\n-------------------------------------------------------\nmacvtap2   direct     ubuntu_br  rtl8139     52:54:00:ce:e6:40\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br")])]),e("p",[e("strong",[t._v("NOTE")]),t._v("：VM1、2、3 都连接到同一个 Bridge 上，只要三者具有网段的 IP 地址就可以通信了。")]),t._v(" "),e("p",[e("strong",[t._v("查看 Floodlight Dashboard")]),t._v("：")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190223234645102.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("等待一段时间 Floodlight 就会将会主机上的 Bridges、Bridge 上的 Hosts、Host 的 IP/MAC 地址等信息收集上来。")]),t._v(" "),e("h3",{attrs:{id:"floodlight-controller-常用指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#floodlight-controller-常用指令"}},[t._v("#")]),t._v(" Floodlight Controller 常用指令")]),t._v(" "),e("p",[t._v("Floodlight Dashboard 基本上只作为展示，所以大部分操作依旧需要通过指令行来完成。")]),t._v(" "),e("ul",[e("li",[t._v("请求该 Controller 上所有 Switch 的 DPID")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("curl http://localhost:8080/wm/core/controller/switches/json\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("查看流表项")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("curl http://localhost:8080/wm/staticflowentrypusher/list/all/json\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("查看指定 Switch 的流表项")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("curl http://192.168.1.109:8080/wm/core/switch/00:00:46:ca:9f:ed:0b:46/flow/json\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("添加静态流表项")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('curl -d \'{"switch": "00:00:00:00:00:00:00:01", "name":"flow-mod-1", "cookie":"0", "priority":"32768", "ingress-port":"1", "active":"true", "actions":"output=2"}\' http://localhost:8080/wm/staticflowentrypusher/json\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("只允许 10.0.0.101 和 10.0.0.103 相互 Ping 的静态流表")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('# VM1\ncurl -d \'{"switch": "00:00:46:ca:9f:ed:0b:46", "name":"static-flow2", "cookie":"0", "priority":"32768", "src-mac":"52:54:00:b8:9a:cf","active":"true", "actions":"output=10"}\'  http://localhost:8080/wm/staticflowentrypusher/json\n\n# VM3\ncurl -d \'{"switch": "00:00:46:ca:9f:ed:0b:46", "name":"static-flow1", "cookie":"0", "priority":"32768", "src-mac":"52:54:00:ce:e6:40","active":"true", "actions":"output=12"}\'  http://localhost:8080/wm/staticflowentrypusher/json\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("ul",[e("li",[t._v("删除指定流表")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('curl -X DELETE -d \'{"name":"flow-mod-1"}\' http://localhost:8080/wm/staticflowentrypusher/json\n')])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ul",[e("li",[t._v("删除指定 Switch 所有流表")])]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("curl http://localhost:8080/wm/staticflowentrypusher /clear/<dpid>/json\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"mirror"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mirror"}},[t._v("#")]),t._v(" Mirror")]),t._v(" "),e("p",[t._v("Mirror 的功能就是配置一个 Bridge 将某些具有特定条件的包发给指定的 Mirrored Ports。")]),t._v(" "),e("p",[t._v("包的条件有以下几种：")]),t._v(" "),e("ul",[e("li",[t._v("select_all")]),t._v(" "),e("li",[t._v("select_dst_port")]),t._v(" "),e("li",[t._v("select_src_port")]),t._v(" "),e("li",[t._v("select_vlan")])]),t._v(" "),e("p",[t._v("指定的目的 Ports 有以下两种：")]),t._v(" "),e("ul",[e("li",[t._v("output_port (SPAN Switched Port ANalyzer)")]),t._v(" "),e("li",[t._v("output_vlan (RSPAN Remote Switched Port ANalyzer)")])]),t._v(" "),e("h3",{attrs:{id:"span"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#span"}},[t._v("#")]),t._v(" SPAN")]),t._v(" "),e("p",[e("strong",[t._v("Source (SPAN) port")]),t._v(" - A port that is monitored with use of the SPAN feature.\n"),e("strong",[t._v("Destination (SPAN) port")]),t._v(" - A port that monitors source ports, usually where a network analyzer is connected.")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224202051195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ovs-vsctl add-br ovs-br\novs-vsctl add-port ovs-br eth0\novs-vsctl add-port ovs-br eth1\n# 设置 SPAN Mirrors，将 ovs-br 上 add-port {eth0,eth1} Mirror 至 tap0\novs-vsctl add-port ovs-br tap0 \\\n     -- --id=@p get port tap0 \\\n     -- --id=@m create mirror name=m0 select-all=true output-port=@p \\\n     -- set bridge ovs-br mirrors=@m\n# 删除 SPAN Mirrors\novs-vsctl clear bridge ovs-br mirrors\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br")])]),e("h3",{attrs:{id:"rspan"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#rspan"}},[t._v("#")]),t._v(" RSPAN")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("被监控的流量不是发送到一个指定的端口，而是 Flood 给指定的 VLAN")])]),t._v(" "),e("li",[e("p",[t._v("监听的端口不一定要在本地 Switch 上，可以在指定的 VLAN 的任意 Switch 上")])]),t._v(" "),e("li",[e("p",[t._v("S1 is a source switch")])]),t._v(" "),e("li",[e("p",[t._v("S2 and S3 are intermediate switches")])]),t._v(" "),e("li",[e("p",[t._v("S4 and S5 are destination switches.")])]),t._v(" "),e("li",[e("p",[t._v("learning is disabled to enable flooding")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019022420220422.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})])])]),t._v(" "),e("h2",{attrs:{id:"interface"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#interface"}},[t._v("#")]),t._v(" Interface")]),t._v(" "),e("p",[e("strong",[t._v("Open vSwitch 支持的网卡类型")]),t._v("：")]),t._v(" "),e("ul",[e("li",[t._v("netdev：通用网卡设备（e.g. eth0、veth）\n"),e("ul",[e("li",[t._v("接收：一个 netdev 在 L2 收到报文后会直接通过 OvS 接收函数处理，不会再走传统内核 TCP/IP 协议栈。")]),t._v(" "),e("li",[t._v("发送：OvS 中的一条流指定从该 netdev 发出的时候就通过该网卡设备发送。")])])]),t._v(" "),e("li",[t._v("internal：虚拟网卡设备\n"),e("ul",[e("li",[t._v("接收：当从系统发出的报文路由查找通过该设备发送的时候，就进入 OvS 接收处理函数。")]),t._v(" "),e("li",[t._v("发送：OvS 中的一条流制定从该 internal 设备发出的时候，该报文被重新注入内核协议栈。")])])]),t._v(" "),e("li",[t._v("gre device：隧道设备（不管用户态创建多少个 GRE Tunnel，在内核态有且只有一个 GRE 设备）\n"),e("ul",[e("li",[t._v("接收：当系统收到 GRE 报文后，传递给 L4 层解析 gre header，然后传递给 OvS 接收处理函数。")]),t._v(" "),e("li",[t._v("发送：OvS 中的一条流制定从该 GRE 设备发送，报文会根据流表规则加上 GRE 头以及外层包裹 IP，查找路由发送。")])])])]),t._v(" "),e("h2",{attrs:{id:"port"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#port"}},[t._v("#")]),t._v(" Port")]),t._v(" "),e("h3",{attrs:{id:"port-与-vlan"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#port-与-vlan"}},[t._v("#")]),t._v(" Port 与 VLAN")]),t._v(" "),e("p",[t._v("Port 的一个重要的特性就是 VLAN Configuration，具有两种类型：")]),t._v(" "),e("ul",[e("li",[t._v("Trunk Port")]),t._v(" "),e("li",[t._v("Access Port")])]),t._v(" "),e("p",[t._v("Trunk Port：")]),t._v(" "),e("ul",[e("li",[t._v("这个 Port 不配置 Tag，配置 trunks。")]),t._v(" "),e("li",[t._v("如果 trunks 为空，则所有的 VLAN 都 trunk，缺省 VLAN ID 为 0，全部允许通过。")]),t._v(" "),e("li",[t._v("如果 trunks 不为空，则仅有符合条件（ID）的 VLAN 能通过。")])]),t._v(" "),e("p",[t._v("简而言之，就是物理交换机的 Trunk 口，符合 Trunks 列表的 VLAN ID 可通过。")]),t._v(" "),e("p",[t._v("Access Port：")]),t._v(" "),e("ul",[e("li",[t._v("这个 Port 配置 Tag，从这个 Port 进来的包都被打上 Tag（ID）。")]),t._v(" "),e("li",[t._v("如果从其他的 Trunk Port 中进来的本身就带有 VLAN ID 的包，若 VLAN ID 等于这个 Port 的 Tag，则会从这个 Port 发出。")]),t._v(" "),e("li",[t._v("从其他的 Access Port 进来的包，如果 Tag 相同，也会被 Forward 到这个 Port。")]),t._v(" "),e("li",[t._v("从 Access Port 发出的包会被摘除 Tag，不带 VLAN ID。")]),t._v(" "),e("li",[t._v("如果一个本身带 VLAN ID 的包到达 Access Port，即便 VLAN ID 等于 Tag，也会被抛弃，Access Port 只接受 Untag 包。")])]),t._v(" "),e("p",[t._v("简而言之，由 Access Port 接收到的包会被打上 Tag，Access Port 只接收 Untag 包，否则丢弃。具有相同 VLAN ID 的包会给转发到对应的 Access Port 然后解除 Tag 再发出。")]),t._v(" "),e("h3",{attrs:{id:"port-与-vlan-的常用操作指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#port-与-vlan-的常用操作指令"}},[t._v("#")]),t._v(" Port 与 VLAN 的常用操作指令")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 添加 Port 并设置 VLAN tag，ID 为 3\novs-vsctl add-port <bridge> <vlan_access_interface> tag=3 -- set interface <vlan_access_interface> type=internal\n# 为已存在的 Port 设置 VLAN tag，ID 为 9\novs-vsctl set port <port> tag=9\n# 移除 VLAN tag\novs-vsctl del-port <bridge> <vlan_access_interface>\n# 查询 VLAN\nifconfig <vlan_access_interface>\n# 设置 Vlan Trunk\novs-vsctl add-port <bridge> <vlan_trunk_interface> trunk=3,4,5,6\n# 添加设置 VLAN 的 Flow，ID 为 100\novs-ofctl add-flow <bridge> in_port=1,dl_vlan=0xffff,actions=mod_vlan_vid:100,output:3\novs-ofctl add-flow <bridge> in_port=1,dl_vlan=0xffff,actions=push_vlan:0x8100,set_field:100-\\>vlan_vid,output:3\n# 添加摘除 VLAN tag 的 Flow\novs-ofctl add-flow <bridge> in_port=3,dl_vlan=100,actions=strip_vlan,output:1\n# ovs-ofctl add-flow pop-vlan\novs-ofctl add-flow ovs-br in_port=3,dl_vlan=0xffff,actions=pop_vlan,output:1\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br")])]),e("h3",{attrs:{id:"port-与-bond"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#port-与-bond"}},[t._v("#")]),t._v(" Port 与 Bond")]),t._v(" "),e("p",[t._v("Port 和 Interface 的关系是一对多的关系，因为 OvS 支持 Bond 功能。所谓 Bond 就是将多个 Interface “捆绑” 在一起形成一个虚拟的连接，从而实现高可用性以及高吞吐量的效果。")]),t._v(" "),e("p",[t._v("常见的 bond_mode 有以下几种：")]),t._v(" "),e("ul",[e("li",[t._v("active-backup：故障转移，一个连接 Active，其他连接 Backup。")]),t._v(" "),e("li",[t._v("balance-slb：负载均衡，根据源 MAC 和 output VLAN 进行负载均衡。")]),t._v(" "),e("li",[t._v("balance-tcp：负载均衡，必须在支持 LACP 协议的情况下才可以，可根据 L2, L3, L4 进行负载均衡。")]),t._v(" "),e("li",[t._v("stable（LACP）：Attempts to always assign a given flow to the same slave consistently.")])]),t._v(" "),e("p",[t._v("PS：LACP (Link Aggregation Control Protocol，链路聚合控制协议)。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224204802195.png",alt:"img"}})]),t._v(" "),e("p",[e("strong",[t._v("OvS 的 bond 模型")]),t._v(":")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019022420485437.png",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"port-与-qos"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#port-与-qos"}},[t._v("#")]),t._v(" Port 与 QoS")]),t._v(" "),e("p",[t._v("OvS 中的 Qos 往往是和 Flow Policy 一起使用的。总所周知 QoS 有两个方向，一个是入方向（Ingress），一个是出方向（Egress）。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224205239962.png",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"网络流程-qos-的实现原理与方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#网络流程-qos-的实现原理与方式"}},[t._v("#")]),t._v(" 网络流程 QoS 的实现原理与方式")]),t._v(" "),e("p",[t._v("在 Linux 上最常用的网络 QoS 就是 TC 工具，其主要是通过 "),e("strong",[t._v("队列")]),t._v(" 的方式来实现的。")]),t._v(" "),e("p",[t._v("1."),e("strong",[t._v("Classless Queuing Disciplines")]),t._v("：默认为 pfifo_fast，是一种不把网络包分类的技术。pfifo_fast 根据网络包中的 TOS 对应的数字，在 TOS 的 priomap 中查看对应的 Band，不同的 Band 对应的不同的队列。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224210115885.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224210130828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("\\2. "),e("strong",[t._v("SFQ, Stochastic Fair Queuing")]),t._v("：有很多的 FIFO 的队列，TCP Session 或者 UDP stream 会被分配到某个队列。包会 RoundRobin 的从各个队列中取出发送。这样一个 Session 就不会占据所有的流量。但不是每一个 Session 都具有一个队列，而是通过 Hash 算法，将大量的 Session 分配到有限的队列中。这样两个或若干个 Session 会共享一个队列，也有可能互相影响。因此 Hash 函数会经常改变，从而 Session 不会总是相互影响。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/2019022421031688.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("\\3. "),e("strong",[t._v("TBF, Token Bucket Filter")]),t._v("：所有的网络包排成队列进行发送，但不是到了队头就能发送，而是需要拿到 Token 的包才能发送。Token 根据设定的速率（Rate）生成，所以即便队列很长，也会按照 Rate 进行发送。当没有包在队列中时，Token 还是以既定的速度生成，但是并非无限累积，而是到 Buckets 放满为止，篮子（buckets）的大小常用 burst/buffer/maxburst 参数来设定。Buckets 会避免下面这种情况：当长时间没有包发送的时候，积累了大量的 Token，突然来了大量的包，每个都能得到 Token，造成瞬间流量大增。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224210631350.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("\\4. "),e("strong",[t._v("Classful Queuing Disciplines")]),t._v("：其中典型的为 "),e("strong",[t._v("HTB, Hierarchical Token Bucket")]),t._v("。")]),t._v(" "),e("ul",[e("li",[t._v("Shaping：仅仅发生在叶子节点，依赖于其他的 Queue。")]),t._v(" "),e("li",[t._v("Borrowing：当网络资源空闲的时候，借点过来为我所用。")]),t._v(" "),e("li",[t._v("Rate：设定的速率。")]),t._v(" "),e("li",[t._v("Ceil：最大的速率，与 Rate 之间的差值表示最多能向别人借多少。")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/201902242108524.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h3",{attrs:{id:"使用-tc-创建一个-htb-hierarchical-token-bucket-树"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用-tc-创建一个-htb-hierarchical-token-bucket-树"}},[t._v("#")]),t._v(" 使用 TC 创建一个 HTB（Hierarchical Token Bucket）树")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224211136166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 创建一个 HTB 的 qdisc 在 eth0 上，句柄为 1:，default 12 表示默认发送给 1:12。\ntc qdisc add dev eth0 root handle 1: htb default 12\n\n# 创建一个 root class，然后再创建几个 sub class。\n# 同一个 root class 下的 sub class 可以相互借流量，如果直接不在 qdisc下面创建一个 root class，而是直接创建三个 class，他们之间是不能相互借流量的。\ntc class add dev eth0 parent 1: classid 1:1 htb rate 100kbps ceil 100kbps\ntc class add dev eth0 parent 1:1 classid 1:10 htb rate 30kbps ceil 100kbps\ntc class add dev eth0 parent 1:1 classid 1:11 htb rate 10kbps ceil 100kbps\ntc class add dev eth0 parent 1:1 classid 1:12 htb rate 60kbps ceil 100kbps\n\n# 创建叶子 qdisc，分别为 fifo 和 sfq。\ntc qdisc add dev eth0 parent 1:10 handle 20: pfifo limit 5\ntc qdisc add dev eth0 parent 1:11 handle 30: pfifo limit 5\ntc qdisc add dev eth0 parent 1:12 handle 40: sfq perturb 10\n\n# 设定规则：从 IP 1.2.3.4 来的并且发送给 port 80 的包，从 1:10 走；其他从 1.2.3.4 发送来的包从 1:11 走；其他的走默认。\n# 实现了限速与分流。\ntc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip src 1.2.3.4 match ip dport 80 0xffff flowid 1:10\ntc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 match ip src 1.2.3.4 flowid 1:11\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br")])]),e("p",[t._v("实际上 OvS 能控制的只有 Egress QoS，通过 Shaping 实现。而 Ingress QoS 是无法控制的，只能通过 Policy 将指定的包丢弃。")]),t._v(" "),e("p",[e("strong",[t._v("Ingress policy")]),t._v("：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("ovs-vsctl set Interface tap0 ingress_policing_rate=100000\novs-vsctl set Interface tap0 ingress_policing_burst=10000\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("p",[e("strong",[t._v("Egress shaping")]),t._v("：Port QoS policy 仅支持 HTB。")]),t._v(" "),e("ul",[e("li",[t._v("在 Port 上可以创建 QoS")]),t._v(" "),e("li",[t._v("一个 QoS 可以有多个 Queue")]),t._v(" "),e("li",[t._v("规则通过 Flow 设定")])]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224211004316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"tunnel"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#tunnel"}},[t._v("#")]),t._v(" Tunnel")]),t._v(" "),e("p",[t._v("OvS 支持三种隧道类型，这三种 Tunnel 的原理均在 《Networking 基础术语 / 概念》中讲过，不再赘述。")]),t._v(" "),e("ul",[e("li",[t._v("GRE")]),t._v(" "),e("li",[t._v("VxLAN")]),t._v(" "),e("li",[t._v("IPSec_gre")])]),t._v(" "),e("h3",{attrs:{id:"ovs-tunnel-的操作指令示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ovs-tunnel-的操作指令示例"}},[t._v("#")]),t._v(" OvS Tunnel 的操作指令示例")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# Instance1\novs-vsctl add-br testbr\nifconfig testbr 10.0.0.1/24\novs-vsctl add-port testbr gre0 -- set Interface gre0 type=gre options:local_ip=192.168.100.100 options:remote_ip=192.168.100.101\novs-vsctl add-port testbr vxlan0 -- set Interface vxlan0 type=vxlan options:local_ip=192.168.100.100 options:remote_ip=192.168.100.102\n\n# Instance2\novs-vsctl add-br testbr\nifconfig testbr 10.0.0.2/24\novs-vsctl add-port testbr gre0 -- set Interface gre0 type=gre options:local_ip=192.168.100.101 options:remote_ip=192.168.100.100\novs-vsctl add-port testbr ipsec0 -- set Interface ipsec0 type=ipsec_gre options:local_ip=192.168.100.101 options:remote_ip=192.168.100.102 options:psk=password\n\n# Instance3\novs-vsctl add-br testbr\nifconfig testbr 10.0.0.3/24\novs-vsctl add-port testbr vxlan0 -- set Interface vxlan0 type=vxlan options:local_ip=192.168.100.102 options:remote_ip=192.168.100.100\novs-vsctl add-port testbr ipsec0 -- set Interface ipsec0 type=ipsec_gre options:local_ip=192.168.100.102 options:remote_ip=192.168.100.101 options:psk=password\n\n# enable STP，避免环导致的洪泛（Flood）\n# Spanning Tree Protocol，即通过协议，将一个有环的二层网络变成一颗树。\novs-vsctl set Bridge testbr stp_enable=true\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br"),e("span",{staticClass:"line-number"},[t._v("17")]),e("br"),e("span",{staticClass:"line-number"},[t._v("18")]),e("br"),e("span",{staticClass:"line-number"},[t._v("19")]),e("br"),e("span",{staticClass:"line-number"},[t._v("20")]),e("br"),e("span",{staticClass:"line-number"},[t._v("21")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224212435711.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("h2",{attrs:{id:"flow-table"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#flow-table"}},[t._v("#")]),t._v(" Flow Table")]),t._v(" "),e("p",[t._v("Open vSwitch 定义了一系列的 Flow Table，通过这些 Tables 来控制网络包的流向和结构。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190217202737570.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190217202932970.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("p",[t._v("根据 OpenFlow 协议，一行 Flow Entry 应该由两部分组成：")]),t._v(" "),e("ul",[e("li",[e("strong",[t._v("Match Field")])]),t._v(" "),e("li",[e("strong",[t._v("Action")])])]),t._v(" "),e("p",[t._v("如果数据包符合 Match 则执行 Action。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/20190224212700697.png",alt:"img"}})]),t._v(" "),e("p",[t._v("Match Field 对网络包进行解析，解析的内容涵盖了 TCP/IP 协议族各层，具有下列字段，看这些字段是否能够匹配某个值。")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://img-blog.csdnimg.cn/201902242129518.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxr,size_16,color_FFFFFF,t_70",alt:"img"}})]),t._v(" "),e("ul",[e("li",[t._v("Layer 1 – Tunnel ID, In Port, QoS priority, skb mark")]),t._v(" "),e("li",[t._v("Layer 2 – MAC address, VLAN ID, Ethernet type")]),t._v(" "),e("li",[t._v("Layer 3 – IPv4/IPv6 fields, ARP")]),t._v(" "),e("li",[t._v("Layer 4 – TCP/UDP, ICMP, ND")])]),t._v(" "),e("p",[t._v("Action 主要包含下列操作：")]),t._v(" "),e("ul",[e("li",[t._v("Output to port (port range, flood, mirror)")]),t._v(" "),e("li",[t._v("Discard, Resubmit to table x")]),t._v(" "),e("li",[t._v("Packet Mangling (Push/Pop VLAN header, TOS, …)")]),t._v(" "),e("li",[t._v("Send to controller, Learn")])]),t._v(" "),e("h3",{attrs:{id:"常用流表操作指令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常用流表操作指令"}},[t._v("#")]),t._v(" 常用流表操作指令")]),t._v(" "),e("p",[t._v("OvS 对 Flow Table 的管理，主要通过 ovs-ofctl 工具来完成：")]),t._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# 查看 Bridge 的流表\novs-ofctl show <bridge>\n# 查询指定 Bridge 的流表\novs-ofctl dump-flows <bridge>\n# 添加 Bridge 的流表\novs-ofctl add−flow <bridge> <flow>\n# e.g.\novs-ofctl add-flow ovs_br dl_src=02:a2:a2:a2:a2:a2,dl_dst=02:b2:b2:b2:b2:b2,in_port=2,dl_type=0x0800,nw_src=10.0.0.1,nw_dst=10.0.0.2,actions=output:6\n# 修改 Bridge 的流表\novs-ofctl mod−flows <bridge> <flow>\n# 删除 Bridge 的指定流表\novs-ofctl del−flows <bridge> <flow>\n# e.g.\novs-ofctl del-flows <bridge> dl_src=02:a2:a2:a2:a2:a2,dl_dst=02:b2:b2:b2:b2:b2,in_port=2,dl_type=0x0800,nw_src=10.0.0.1,nw_dst=10.0.0.2\n# 删除 Bridge 的所有流表\novs-ofctl del-flows <bridge>   # This will delete all the flow entries in the flow table\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br"),e("span",{staticClass:"line-number"},[t._v("14")]),e("br"),e("span",{staticClass:"line-number"},[t._v("15")]),e("br"),e("span",{staticClass:"line-number"},[t._v("16")]),e("br")])]),e("h1",{attrs:{id:"参考文档"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考文档"}},[t._v("#")]),t._v(" 参考文档")]),t._v(" "),e("p",[t._v("https://www.cnblogs.com/popsuper1982/p/3800576.html\nhttps://blog.csdn.net/w0823m/article/details/71319973\nhttps://blog.csdn.net/tantexian/article/details/46707175")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-0",target:"_blank",rel:"noopener noreferrer"}},[t._v("目录"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-1",target:"_blank",rel:"noopener noreferrer"}},[t._v("文章目录"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-2",target:"_blank",rel:"noopener noreferrer"}},[t._v("前言"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-3",target:"_blank",rel:"noopener noreferrer"}},[t._v("软件定义网络（SDN）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-4",target:"_blank",rel:"noopener noreferrer"}},[t._v("虚拟交换机（vSwitch）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-5",target:"_blank",rel:"noopener noreferrer"}},[t._v("为什么说云计算时代的 SDN 非常重要"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-6",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenFlow 简介"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-7",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-8",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的架构"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-9",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovsdb（ovsdb-server）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-10",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovs-vswitchd（vswitchd）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-11",target:"_blank",rel:"noopener noreferrer"}},[t._v("Datapatch（openvswitch.ko）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-12",target:"_blank",rel:"noopener noreferrer"}},[t._v("OvS 的工具集"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-13",target:"_blank",rel:"noopener noreferrer"}},[t._v("ovs-vsctl 常用指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-14",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的工作原理"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-15",target:"_blank",rel:"noopener noreferrer"}},[t._v("OpenvSwitch 的典型工作流程"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-16",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的安装部署"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-17",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的 DB（ovs-db）"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-18",target:"_blank",rel:"noopener noreferrer"}},[t._v("Open vSwitch 的操作对象"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-19",target:"_blank",rel:"noopener noreferrer"}},[t._v("Manager"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-20",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置 Manager OvS DB Connection"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-21",target:"_blank",rel:"noopener noreferrer"}},[t._v("SSL"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-22",target:"_blank",rel:"noopener noreferrer"}},[t._v("配置 SSL Connection"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-23",target:"_blank",rel:"noopener noreferrer"}},[t._v("Bridge"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-24",target:"_blank",rel:"noopener noreferrer"}},[t._v("Bridge 常用操作指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-25",target:"_blank",rel:"noopener noreferrer"}},[t._v("Controller"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-26",target:"_blank",rel:"noopener noreferrer"}},[t._v("Controller 常用指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-27",target:"_blank",rel:"noopener noreferrer"}},[t._v("安装 Floodlight"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-28",target:"_blank",rel:"noopener noreferrer"}},[t._v("将 KVM 虚拟机接入 OvS Bridge"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-29",target:"_blank",rel:"noopener noreferrer"}},[t._v("Floodlight Controller 常用指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-30",target:"_blank",rel:"noopener noreferrer"}},[t._v("Mirror"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-31",target:"_blank",rel:"noopener noreferrer"}},[t._v("SPAN"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-32",target:"_blank",rel:"noopener noreferrer"}},[t._v("RSPAN"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-33",target:"_blank",rel:"noopener noreferrer"}},[t._v("Interface"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-34",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-35",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 VLAN"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-36",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 VLAN 的常用操作指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-37",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 Bond"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-38",target:"_blank",rel:"noopener noreferrer"}},[t._v("Port 与 QoS"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-39",target:"_blank",rel:"noopener noreferrer"}},[t._v("网络流程 QoS 的实现原理与方式"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-40",target:"_blank",rel:"noopener noreferrer"}},[t._v("使用 TC 创建一个 HTB（Hierarchical Token Bucket）树"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-41",target:"_blank",rel:"noopener noreferrer"}},[t._v("Tunnel"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-42",target:"_blank",rel:"noopener noreferrer"}},[t._v("OvS Tunnel 的操作指令示例"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-43",target:"_blank",rel:"noopener noreferrer"}},[t._v("Flow Table"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-44",target:"_blank",rel:"noopener noreferrer"}},[t._v("常用流表操作指令"),e("OutboundLink")],1),e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html#sr-toc-45",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考文档"),e("OutboundLink")],1)]),t._v(" "),e("p",[e("a",{attrs:{href:"https://www.cnblogs.com/jmilkfan-fanguiju/p/10589725.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ori"),e("OutboundLink")],1)])])}),[],!1,null,null,null);s.default=a.exports}}]);