(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{130:function(a,d,t){"use strict";t.r(d);var s=t(0),v=Object(s.a)({},function(){var a=this,d=a.$createElement,t=a._self._c||d;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"简介"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#简介","aria-hidden":"true"}},[a._v("#")]),a._v(" 简介")]),a._v(" "),t("h2",{attrs:{id:"架构设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#架构设计","aria-hidden":"true"}},[a._v("#")]),a._v(" 架构设计")]),a._v(" "),t("p",[t("img",{attrs:{src:"/hdfs-arch.png",alt:"pic"}})]),a._v(" "),t("h3",{attrs:{id:"名字节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#名字节点","aria-hidden":"true"}},[a._v("#")]),a._v(" 名字节点")]),a._v(" "),t("p",[a._v("元数据")]),a._v(" "),t("p",[a._v("第一关系: map{文件: 数据块列表}, 类似mds上的元数据")]),a._v(" "),t("p",[a._v("第二关系: map{数据块: 节点信息}, 类似cs上的信息")]),a._v(" "),t("h3",{attrs:{id:"数据节点"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据节点","aria-hidden":"true"}},[a._v("#")]),a._v(" 数据节点")]),a._v(" "),t("p",[a._v("数据节点中每个block中会保存数据和校验和,")]),a._v(" "),t("p",[a._v("这样dn可以自己进行校验, 检查数据是否损坏,")]),a._v(" "),t("h2",{attrs:{id:"系统设计"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#系统设计","aria-hidden":"true"}},[a._v("#")]),a._v(" 系统设计")]),a._v(" "),t("h3",{attrs:{id:"读流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#读流程","aria-hidden":"true"}},[a._v("#")]),a._v(" 读流程")]),a._v(" "),t("p",[a._v("客户端从mds获取一个blk的dn")]),a._v(" "),t("p",[a._v("客户端从dn读取数据")]),a._v(" "),t("p",[a._v("如果dn不在线, 读取副本")]),a._v(" "),t("p",[a._v("客户端获取下一个blk的dn")]),a._v(" "),t("h3",{attrs:{id:"写流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#写流程","aria-hidden":"true"}},[a._v("#")]),a._v(" 写流程")]),a._v(" "),t("p",[a._v("客户端向mds申请一个blk,")]),a._v(" "),t("p",[a._v("客户端向mds分配的dn写入数据")]),a._v(" "),t("p",[a._v("如果dn无法连接")]),a._v(" "),t("p",[a._v("客户端abandonBlock, 重新向mds申请blk")]),a._v(" "),t("p",[a._v("客户端向mds分配的dn写入数据")]),a._v(" "),t("p",[a._v("客户端向mds申请一个blk,")]),a._v(" "),t("h3",{attrs:{id:"删除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#删除","aria-hidden":"true"}},[a._v("#")]),a._v(" 删除")]),a._v(" "),t("p",[a._v("客户端向mds删除文件")]),a._v(" "),t("p",[a._v("mds将文件相关blk标记为删除")]),a._v(" "),t("p",[a._v("dn心跳连接mds,")]),a._v(" "),t("p",[a._v("mds下发删除")]),a._v(" "),t("h3",{attrs:{id:"数据恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据恢复","aria-hidden":"true"}},[a._v("#")]),a._v(" 数据恢复")]),a._v(" "),t("p",[a._v("1 mds检测到副本不够\n通知一个拥有该blk的dn, 复制到其他dn\n2 sdk, dn全量汇报检测数据出错\n通知一个拥有该blk的dn, 复制到其他dn")]),a._v(" "),t("h4",{attrs:{id:"dn挂掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#dn挂掉","aria-hidden":"true"}},[a._v("#")]),a._v(" dn挂掉")]),a._v(" "),t("p",[a._v("如果dn在sdk写入后, dn向mds汇报前挂掉, mds感知到错误")]),a._v(" "),t("p",[a._v("假如blk存在于dn1, dn2, dn3")]),a._v(" "),t("p",[a._v("dn1挂掉,")]),a._v(" "),t("p",[a._v("则dn2, dn3汇报时, mds会指定dn2复制到一个正常节点")]),a._v(" "),t("p",[a._v("通知一个拥有该blk的dn, 复制到其他dn")]),a._v(" "),t("p",[a._v("如果dn在sdk写入时挂掉, sdk感知到错误:")]),a._v(" "),t("p",[a._v("会选择一个主dn, 然后让主dn对其他dn进行数据复制")]),a._v(" "),t("p",[a._v("通知一个拥有该blk的dn, 复制到其他dn")]),a._v(" "),t("p",[a._v("之后dn会返回sdk一个恢复成功数据块的位置, 和dn列表")]),a._v(" "),t("p",[a._v("sdk可以在这个位置, 继续写入")]),a._v(" "),t("h4",{attrs:{id:"sdk挂掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sdk挂掉","aria-hidden":"true"}},[a._v("#")]),a._v(" sdk挂掉")]),a._v(" "),t("p",[a._v("参考租约恢复")]),a._v(" "),t("h4",{attrs:{id:"mds挂掉"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mds挂掉","aria-hidden":"true"}},[a._v("#")]),a._v(" mds挂掉,")]),a._v(" "),t("p",[a._v("sdk在写入时, mds挂掉")]),a._v(" "),t("p",[a._v("mds只能在给sdk分配完dn后挂掉, 如果之前挂, 则sdk无法找到写的dn")]),a._v(" "),t("p",[a._v("此时, sdk把该blk写完后, 无法关闭文件, 需人工介入,")]),a._v(" "),t("p",[a._v("dn这里无所谓, 只是暂时块汇报无法响应")]),a._v(" "),t("h3",{attrs:{id:"高可用-备机做fsimage"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#高可用-备机做fsimage","aria-hidden":"true"}},[a._v("#")]),a._v(" 高可用, 备机做fsimage")]),a._v(" "),t("pre",[t("code",[a._v("备机从主机拉取editlog和image合成新的image,\n再将新的image推送给主机\n")])]),a._v(" "),t("h4",{attrs:{id:"注册"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#注册","aria-hidden":"true"}},[a._v("#")]),a._v(" 注册")]),a._v(" "),t("p",[a._v("在注册时, 上报本节点的数据块信息,\n名字节点根据数据块信息, 构建{数据块:节点信息}")]),a._v(" "),t("h4",{attrs:{id:"心跳"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#心跳","aria-hidden":"true"}},[a._v("#")]),a._v(" 心跳")]),a._v(" "),t("p",[a._v("每次心跳, 名字节点向数据节点发送无效节点信息列表,\n数据节点进行删除,")]),a._v(" "),t("h3",{attrs:{id:"并发-租约"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#并发-租约","aria-hidden":"true"}},[a._v("#")]),a._v(" 并发, 租约")]),a._v(" "),t("h4",{attrs:{id:"租约恢复"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#租约恢复","aria-hidden":"true"}},[a._v("#")]),a._v(" 租约恢复")]),a._v(" "),t("p",[a._v("软超时, 是sdk每隔2s进行续约")]),a._v(" "),t("p",[a._v("硬超时, 是如果sdk断开, 且没有其他sdk抢夺这个租约造成的超时,")]),a._v(" "),t("p",[a._v("一般是1h")]),a._v(" "),t("p",[a._v("如果sdk刚打开文件就挂了, 还没写数据:")]),a._v(" "),t("p",[a._v("直接关闭文件")]),a._v(" "),t("p",[a._v("abandonBlock调用场景:")]),a._v(" "),t("p",[a._v("当sdk请求一个blk后, mds返回一个dn,")]),a._v(" "),t("p",[a._v("当sdk无法连接这个dn后, 就会调用abandonBlock,")]),a._v(" "),t("p",[a._v("让mds重新分配一个dn")]),a._v(" "),t("p",[a._v("如果sdk在调用abandonBlock后挂掉:")]),a._v(" "),t("p",[a._v("主dn是倒数第二个blk的dn(倒数第一个被abandon了)")]),a._v(" "),t("p",[a._v("指定一个主dn, 然后主dn与其他dn计算出一个最短公共长度,")]),a._v(" "),t("p",[a._v("以此最短公共长度作为有效数据,")]),a._v(" "),t("p",[a._v("主dn向mds申请一个新的版本号, 并同步给其他dn, 将这个版本号赋给blk")]),a._v(" "),t("h3",{attrs:{id:"小文件"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小文件","aria-hidden":"true"}},[a._v("#")]),a._v(" 小文件")]),a._v(" "),t("h3",{attrs:{id:"生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#生命周期","aria-hidden":"true"}},[a._v("#")]),a._v(" 生命周期")]),a._v(" "),t("h3",{attrs:{id:"负载均衡-数据均衡"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡-数据均衡","aria-hidden":"true"}},[a._v("#")]),a._v(" 负载均衡, 数据均衡")]),a._v(" "),t("h3",{attrs:{id:"追加写"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#追加写","aria-hidden":"true"}},[a._v("#")]),a._v(" 追加写")]),a._v(" "),t("h3",{attrs:{id:"目录"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#目录","aria-hidden":"true"}},[a._v("#")]),a._v(" 目录")])])},[],!1,null,null,null);d.default=v.exports}}]);