<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>小张笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-141019448-1"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
      
          gtag('config', 'UA-141019448-1');
      </script>
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2468672938537807" crossorigin="anonymous"></script>
    <meta name="description" content="Little Zhang's Note">
    <meta name="baidu-site-verification" content="code-HRrK6kdBX1">
    
    <link rel="preload" href="/assets/css/0.styles.9b71556a.css" as="style"><link rel="preload" href="/assets/js/app.59705b41.js" as="script"><link rel="preload" href="/assets/js/2.a6173bc2.js" as="script"><link rel="preload" href="/assets/js/117.7a9c97bf.js" as="script"><link rel="prefetch" href="/assets/js/10.bf63d664.js"><link rel="prefetch" href="/assets/js/100.03316f1c.js"><link rel="prefetch" href="/assets/js/101.1752c00a.js"><link rel="prefetch" href="/assets/js/102.07d89fbc.js"><link rel="prefetch" href="/assets/js/103.993c777d.js"><link rel="prefetch" href="/assets/js/104.751e72ae.js"><link rel="prefetch" href="/assets/js/105.a9f677f4.js"><link rel="prefetch" href="/assets/js/106.b5844b20.js"><link rel="prefetch" href="/assets/js/107.1a39af47.js"><link rel="prefetch" href="/assets/js/108.afc6efa7.js"><link rel="prefetch" href="/assets/js/109.95afd03d.js"><link rel="prefetch" href="/assets/js/11.48fa6147.js"><link rel="prefetch" href="/assets/js/110.94fc9104.js"><link rel="prefetch" href="/assets/js/111.e2d59692.js"><link rel="prefetch" href="/assets/js/112.8bd3854d.js"><link rel="prefetch" href="/assets/js/113.11a364cf.js"><link rel="prefetch" href="/assets/js/114.b72b6211.js"><link rel="prefetch" href="/assets/js/115.69636b31.js"><link rel="prefetch" href="/assets/js/116.40f54ce7.js"><link rel="prefetch" href="/assets/js/118.35370456.js"><link rel="prefetch" href="/assets/js/119.803001ba.js"><link rel="prefetch" href="/assets/js/12.ef0e7bb2.js"><link rel="prefetch" href="/assets/js/120.41ae5ce2.js"><link rel="prefetch" href="/assets/js/121.574c1406.js"><link rel="prefetch" href="/assets/js/122.d7aa4bde.js"><link rel="prefetch" href="/assets/js/123.e45f6aa6.js"><link rel="prefetch" href="/assets/js/124.439f290f.js"><link rel="prefetch" href="/assets/js/125.0ba4fef5.js"><link rel="prefetch" href="/assets/js/126.167213e1.js"><link rel="prefetch" href="/assets/js/127.bfa9f828.js"><link rel="prefetch" href="/assets/js/128.f76b6b12.js"><link rel="prefetch" href="/assets/js/129.845e984c.js"><link rel="prefetch" href="/assets/js/13.60c4e03a.js"><link rel="prefetch" href="/assets/js/130.c019f492.js"><link rel="prefetch" href="/assets/js/131.801cfd17.js"><link rel="prefetch" href="/assets/js/132.320ffcae.js"><link rel="prefetch" href="/assets/js/133.8c638fc4.js"><link rel="prefetch" href="/assets/js/134.a6998c7d.js"><link rel="prefetch" href="/assets/js/135.a1ae7010.js"><link rel="prefetch" href="/assets/js/136.740fe250.js"><link rel="prefetch" href="/assets/js/137.9539721b.js"><link rel="prefetch" href="/assets/js/138.074a22c7.js"><link rel="prefetch" href="/assets/js/139.cf86b3b2.js"><link rel="prefetch" href="/assets/js/14.a7d3976d.js"><link rel="prefetch" href="/assets/js/140.343cf95d.js"><link rel="prefetch" href="/assets/js/141.d2a630a0.js"><link rel="prefetch" href="/assets/js/142.f0396341.js"><link rel="prefetch" href="/assets/js/143.fad4d70a.js"><link rel="prefetch" href="/assets/js/144.0b61a03b.js"><link rel="prefetch" href="/assets/js/145.b026234b.js"><link rel="prefetch" href="/assets/js/146.35587f65.js"><link rel="prefetch" href="/assets/js/147.119cfa30.js"><link rel="prefetch" href="/assets/js/148.21d10c5d.js"><link rel="prefetch" href="/assets/js/149.358de87e.js"><link rel="prefetch" href="/assets/js/15.ea316444.js"><link rel="prefetch" href="/assets/js/150.1eccb0ef.js"><link rel="prefetch" href="/assets/js/151.99eb067e.js"><link rel="prefetch" href="/assets/js/152.4a8071a1.js"><link rel="prefetch" href="/assets/js/153.37e8e5f4.js"><link rel="prefetch" href="/assets/js/154.229e9bef.js"><link rel="prefetch" href="/assets/js/155.d7e35a2e.js"><link rel="prefetch" href="/assets/js/156.cd50c462.js"><link rel="prefetch" href="/assets/js/157.d5173787.js"><link rel="prefetch" href="/assets/js/158.6475cc5a.js"><link rel="prefetch" href="/assets/js/159.c7bb84e1.js"><link rel="prefetch" href="/assets/js/16.b93d6c0b.js"><link rel="prefetch" href="/assets/js/160.831f4447.js"><link rel="prefetch" href="/assets/js/161.4c312f6f.js"><link rel="prefetch" href="/assets/js/162.1fe949f9.js"><link rel="prefetch" href="/assets/js/163.dd6193aa.js"><link rel="prefetch" href="/assets/js/164.bd8fcbc1.js"><link rel="prefetch" href="/assets/js/165.0e630561.js"><link rel="prefetch" href="/assets/js/166.3ee43b85.js"><link rel="prefetch" href="/assets/js/167.9a78500a.js"><link rel="prefetch" href="/assets/js/168.3413f0f7.js"><link rel="prefetch" href="/assets/js/169.266b09af.js"><link rel="prefetch" href="/assets/js/17.0c814d3e.js"><link rel="prefetch" href="/assets/js/170.dee11218.js"><link rel="prefetch" href="/assets/js/171.bbae1fb6.js"><link rel="prefetch" href="/assets/js/172.f21fb4ea.js"><link rel="prefetch" href="/assets/js/173.f762d29c.js"><link rel="prefetch" href="/assets/js/18.842701cb.js"><link rel="prefetch" href="/assets/js/19.ae3578e4.js"><link rel="prefetch" href="/assets/js/20.870d9de1.js"><link rel="prefetch" href="/assets/js/21.abf3d0d4.js"><link rel="prefetch" href="/assets/js/22.89c8dd55.js"><link rel="prefetch" href="/assets/js/23.f6407bd5.js"><link rel="prefetch" href="/assets/js/24.f2993d9f.js"><link rel="prefetch" href="/assets/js/25.fd7244ce.js"><link rel="prefetch" href="/assets/js/26.d5a8efd0.js"><link rel="prefetch" href="/assets/js/27.be3c7096.js"><link rel="prefetch" href="/assets/js/28.065e60f5.js"><link rel="prefetch" href="/assets/js/29.9e855a1b.js"><link rel="prefetch" href="/assets/js/3.582414ce.js"><link rel="prefetch" href="/assets/js/30.d92d4132.js"><link rel="prefetch" href="/assets/js/31.014d4757.js"><link rel="prefetch" href="/assets/js/32.2dfe25f3.js"><link rel="prefetch" href="/assets/js/33.7108bfa8.js"><link rel="prefetch" href="/assets/js/34.c8d3757e.js"><link rel="prefetch" href="/assets/js/35.6d5c738c.js"><link rel="prefetch" href="/assets/js/36.dc89a8b9.js"><link rel="prefetch" href="/assets/js/37.300b4c9e.js"><link rel="prefetch" href="/assets/js/38.71bb421f.js"><link rel="prefetch" href="/assets/js/39.266b67d8.js"><link rel="prefetch" href="/assets/js/4.ef205920.js"><link rel="prefetch" href="/assets/js/40.4a34c99b.js"><link rel="prefetch" href="/assets/js/41.a24e4cfe.js"><link rel="prefetch" href="/assets/js/42.26dae2e8.js"><link rel="prefetch" href="/assets/js/43.66b41ada.js"><link rel="prefetch" href="/assets/js/44.500d4a1c.js"><link rel="prefetch" href="/assets/js/45.90c7216d.js"><link rel="prefetch" href="/assets/js/46.1571750c.js"><link rel="prefetch" href="/assets/js/47.fb7798e4.js"><link rel="prefetch" href="/assets/js/48.a8d36995.js"><link rel="prefetch" href="/assets/js/49.d7bd9e1a.js"><link rel="prefetch" href="/assets/js/5.6c7f4d05.js"><link rel="prefetch" href="/assets/js/50.942ee843.js"><link rel="prefetch" href="/assets/js/51.43bc5a7a.js"><link rel="prefetch" href="/assets/js/52.ad702f3d.js"><link rel="prefetch" href="/assets/js/53.b694c7ea.js"><link rel="prefetch" href="/assets/js/54.f9722d7d.js"><link rel="prefetch" href="/assets/js/55.ff1be627.js"><link rel="prefetch" href="/assets/js/56.931560b0.js"><link rel="prefetch" href="/assets/js/57.a80c4ce6.js"><link rel="prefetch" href="/assets/js/58.88c795ee.js"><link rel="prefetch" href="/assets/js/59.d295c4de.js"><link rel="prefetch" href="/assets/js/6.bb33fed3.js"><link rel="prefetch" href="/assets/js/60.94c5cde6.js"><link rel="prefetch" href="/assets/js/61.59c5ee89.js"><link rel="prefetch" href="/assets/js/62.77ac5f18.js"><link rel="prefetch" href="/assets/js/63.81429f13.js"><link rel="prefetch" href="/assets/js/64.8979fd95.js"><link rel="prefetch" href="/assets/js/65.a79f97bc.js"><link rel="prefetch" href="/assets/js/66.171f35fe.js"><link rel="prefetch" href="/assets/js/67.6ccaeff8.js"><link rel="prefetch" href="/assets/js/68.8d3b5748.js"><link rel="prefetch" href="/assets/js/69.f516b6b4.js"><link rel="prefetch" href="/assets/js/7.03daa1b7.js"><link rel="prefetch" href="/assets/js/70.391277d9.js"><link rel="prefetch" href="/assets/js/71.aae34cc7.js"><link rel="prefetch" href="/assets/js/72.2633590e.js"><link rel="prefetch" href="/assets/js/73.0a792cef.js"><link rel="prefetch" href="/assets/js/74.f3d9a3cd.js"><link rel="prefetch" href="/assets/js/75.5afb9d35.js"><link rel="prefetch" href="/assets/js/76.d7aa9b4d.js"><link rel="prefetch" href="/assets/js/77.aaba26af.js"><link rel="prefetch" href="/assets/js/78.13eecef6.js"><link rel="prefetch" href="/assets/js/79.a10866fe.js"><link rel="prefetch" href="/assets/js/8.150af887.js"><link rel="prefetch" href="/assets/js/80.f17ed883.js"><link rel="prefetch" href="/assets/js/81.933fc2db.js"><link rel="prefetch" href="/assets/js/82.5ea7b2c6.js"><link rel="prefetch" href="/assets/js/83.d550c574.js"><link rel="prefetch" href="/assets/js/84.ab04e8f1.js"><link rel="prefetch" href="/assets/js/85.1a91710d.js"><link rel="prefetch" href="/assets/js/86.adc15b31.js"><link rel="prefetch" href="/assets/js/87.2deb96d6.js"><link rel="prefetch" href="/assets/js/88.374de15d.js"><link rel="prefetch" href="/assets/js/89.2edab492.js"><link rel="prefetch" href="/assets/js/9.f7aab732.js"><link rel="prefetch" href="/assets/js/90.05985ef4.js"><link rel="prefetch" href="/assets/js/91.486e70d6.js"><link rel="prefetch" href="/assets/js/92.44b6b56c.js"><link rel="prefetch" href="/assets/js/93.50ec585e.js"><link rel="prefetch" href="/assets/js/94.40b89e32.js"><link rel="prefetch" href="/assets/js/95.8aeee9b2.js"><link rel="prefetch" href="/assets/js/96.ef8bcb5f.js"><link rel="prefetch" href="/assets/js/97.a243eda2.js"><link rel="prefetch" href="/assets/js/98.46127310.js"><link rel="prefetch" href="/assets/js/99.ac24a1be.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9b71556a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小张笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://toutiao.zhangfan.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小张头条
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/file_21/211111_writing_specifications_in_a_distributed_system_using_Ivy.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://toutiao.zhangfan.vip" target="_blank" rel="noopener noreferrer" class="nav-link external">
  小张头条
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/file_21/211111_writing_specifications_in_a_distributed_system_using_Ivy.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <!----></nav>  <!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>writing_specifications_in_a_distributed_system_using_Ivy</p> <p>Personal Blog of Bodun (Edward) Hu. CS PhD student at University of Texas at Austin. Operating system......</p> <p>Before we jump into writing specifications in a distributed setting, we first define what a specification is. I take the definition from the magnificent <a href="http://mcmil.net/wordpress/" target="_blank" rel="noopener noreferrer">Ken McMillan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: a specification is a <em>statement</em>.</p> <p>A statement describes an abstract view of a program. The view itself is often at an interface, which hides or abstracts internal states. A specification is stated in terms of two elements:</p> <ul><li>Assumption: properties of the environment the system relies on</li> <li>Guarantee: properties that most hold <em>if</em> the assumption(s) is met</li></ul> <p>The way we write specifications is through an abstract program that observes or monitors all program events. This abstract program is able to remember the execution history of program being monitored, and decides, at any given moment, whether an action is allowable according to the specification.</p> <p>One way to implement this abstract monitor program is to use guarded command form:</p> <ul><li>Let (A) be a set of program actions</li> <li>An event (e(x_1,\ …,\ x_n)) is an action (e\in A) with parameter values (x_1,\ …,\ x_n) of the right types for (e).</li> <li>Let (S) be a set of states and (s_0 \in S) be the initial state.</li> <li>Guarded command set (G) is specified as:</li></ul> <p>[e(V):\ \gamma (S,V) \rightarrow {S := \tau(S, V)}]</p> <p>It means if a guarded command (\gamma) determines a given event (e) satisfies certain specifications with parameter (V) under state (S), then we accept the code and then deterministically update the state with a function (\tau).</p> <p>The observation (E) of system is going to be a finite sequence of events, which corresponds to the system behavior, denoted as (e_0(V_0)…e_{n-1}(V_{n-1})). A run of (E) is a state sequence (s_0\ …s_n) such that for (i\in 0\ … n- 1), (\gamma(s_i, V_i)) is true and (s_{i+1} = \tau(s_i, v_i)). Observation (E) is accepted by the specification iff it has a run. We can test whether an observation is accepted by just executing the guarded commands. In layman’s term, if all guarded commands accepts the their corresponding event at a given time, then the sequence events must satisfy our specification and should be accepted.</p> <p>Now let’s replicated file as an example. Out first informal attempt to the specification for “append” operation would be:</p> <ul><li>Assumption: network is ordered and non-duplicating</li> <li>Guarantee: if no further append requests, eventually replicas are equal</li></ul> <p>However, the problem with this specification is that this is a liveness property, meaning that we can’t practically test such property by observing a finite sequence of events. Therefore, we resort to a different safety specification we can test:</p> <ul><li>If all sent messages are delivered, the two replicas are identical.</li></ul> <p>Now we convert liveness to safety by explicitly defining the moment hen the eventuality should hold.</p> <p>Liveness property means a good thing eventually happens. A liveness property can be <em>refuted</em> by finite execution. Safety property means a bad thing never happens. A safety property can always be refuted by a finite execution.</p> <p>To see how replicated file specification plays in action, we use the example given in <a href="http://mcmil.net/wordpress/" target="_blank" rel="noopener noreferrer">Prof. McMillan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>’s presentation. The code is written in <a href="https://microsoft.github.io/ivy/language.html" target="_blank" rel="noopener noreferrer">Ivy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and is pretty self-explanatory. In this demo we only have two processes.</p> <p>To install Ivy, simply execute <code>virtualenv ivyenv &amp;&amp; source ivyenv/bin/activate &amp;&amp; pip install ms-ivy</code>. This is tested on Ubuntu 18.04 LTS and may vary slight on other distros.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#lang ivy1.8

include numbers
include collections
include network

global {
    alias byte = uint[8]
    instance file : vector(byte)
    type pid = {0..1}
    instance net : tcp.net(byte)
}

process host(self:pid) = {
    export action append(val:byte)
    import action show(content:file)
    instance sock : net.socket
    var contents : file

    after init{
        contents := file.empty;
    }

    implement append {
        contents := contents.append(val);
        sock.send(host(1-self).sock.id, val);
        show(contents);
    }

    implement sock.recv(src:tcp.endpoint, val:byte) {
        contents := contents.append(val);
        show(contents);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>Then we form our specification based on the guarantee that if all sent messages are delivered, the two replicas are identical. The specification is equivalent to the <em>guarded command</em> we’ve talked about earlier.</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>specification {
    var msg_count : nat

    after init {
        msg_count := 0;
    }

    after host.sock.send(self:pid, dst:tcp.endpoint, val:byte) {
        msg_count := msg_count + 1;
    }

    after host.sock.recv(self:pid, src:tcp.endpoint, val:byte) {
        msg_count := msg_count - 1;
        ensure msg_count = 0 -&gt; host(0).contents.eq(host(1).contents);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>We wrote the above code into a file named <code>append.ivy</code> and we generate the testing code using <code>ivyc target=test append.ivy</code>. Then we run the code using <code>ivy_launch append.ivy</code>.</p> <p>Interestingly, the program yields an error message:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>`ivy_shell`; ./append &quot;[[0,{addr:0x7f000001,port:49124}],[1,{addr:0x7f000001,port:49125}]]&quot;
&gt; host.append(1,251)
&lt; host.show(1,[251])
&lt; host.show(0,[251])
&gt; host.append(1,46)
&lt; host.show(1,[251,46])
&gt; host.append(0,183)
&lt; host.show(0,[251,183])
&lt; host.show(0,[251,183,46])
&lt; host.show(1,[251,46,183])
assertion_failed(&quot;append.ivy: line 49&quot;)
append.ivy: line 49: error: assertion failed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>What happens is the program generates tests that randomizes message arrival times and we can see a delivered message may arrive after its target sends another message, therefore creating corrupted file contents.</p> <p>Notice that here we are actually running on real network to find counter examples, the downside is the test may be arbitrary long depending on the randomized testing cases. Instead, we will use bounded model checking (BMC) to test if the specification is correct. This way we can reply purely on the logic of our specification instead of running on the real network. The Ivy checker uses <a href="https://en.wikipedia.org/wiki/Z3_Theorem_Prover" target="_blank" rel="noopener noreferrer">Z3 Theorem Prover<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>BMC construct a boolean formula that is satisfiable if and only if the underlying state transition system can realize a finite sequence of state transitions that reaches certain states of interest.</p> <p>To tell Ivy using bounded model checking, we add the following lines to <code>append.ivy</code>:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>axiom host(0).sock.id ~= host(1).sock.id

attribute method=bmc[10]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Executing <code>ivy_check detailed=false append.ivy</code>, we see an error message:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&gt; host.append(1,80)
&lt; host.show(1,[80])
&gt; host.append(0,64)
&lt; host.show(0,[64])
&gt; host.sock.recv(0,{tcp.endpoint.addr:...,tcp.endpoint.port:...},80)
&lt; host.show(0,[64,80])
&gt; host.sock.recv(1,{tcp.endpoint.addr:...,tcp.endpoint.port:...},64)
&lt; host.show(1,[80,64])
append.ivy: line 49: error: assertion failed
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>Sometimes BMC can help us find the error faster because it is systematically checking all possible actions. However, increasing the number of steps for the BMC can result in the exploration space growing exponentially, so we are going to use some combination of BMC and randomized test cases.</p> <p>全文完</p> <p>本文由 <a href="http://ksria.com/simpread" target="_blank" rel="noopener noreferrer">简悦 SimpRead<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 优化，用以提升阅读体验</p> <p>使用了 全新的简悦词法分析引擎 beta，<a href="http://ksria.com/simpread/docs/#/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E" target="_blank" rel="noopener noreferrer">点击查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>详细说明</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2022/1/10 下午4:07:35</span></div></footer> <!----> </main> <div class="footer-wrapper footer"><span><a href="https://toutiao.zhangfan.vip">小张头条</a></span> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.59705b41.js" defer></script><script src="/assets/js/2.a6173bc2.js" defer></script><script src="/assets/js/117.7a9c97bf.js" defer></script>
  </body>
</html>
