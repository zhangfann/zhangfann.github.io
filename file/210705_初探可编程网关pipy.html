<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>初探可编程网关Pipy | 小张笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-141019448-1"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
      
          gtag('config', 'UA-141019448-1');
      </script>
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2468672938537807" crossorigin="anonymous"></script>
    <meta name="description" content="Little Zhang's Note">
    <meta name="baidu-site-verification" content="code-HRrK6kdBX1">
    
    <link rel="preload" href="/assets/css/0.styles.f6885cf5.css" as="style"><link rel="preload" href="/assets/js/app.d335a484.js" as="script"><link rel="preload" href="/assets/js/2.a6173bc2.js" as="script"><link rel="preload" href="/assets/js/54.3f8bdd35.js" as="script"><link rel="prefetch" href="/assets/js/10.bf63d664.js"><link rel="prefetch" href="/assets/js/100.693a312c.js"><link rel="prefetch" href="/assets/js/101.8be4160f.js"><link rel="prefetch" href="/assets/js/102.0fba87eb.js"><link rel="prefetch" href="/assets/js/103.498f1f77.js"><link rel="prefetch" href="/assets/js/104.cce45c2c.js"><link rel="prefetch" href="/assets/js/105.21148996.js"><link rel="prefetch" href="/assets/js/106.b01040c5.js"><link rel="prefetch" href="/assets/js/107.0bb2948d.js"><link rel="prefetch" href="/assets/js/108.b880f1a0.js"><link rel="prefetch" href="/assets/js/109.364f5e60.js"><link rel="prefetch" href="/assets/js/11.43694a7b.js"><link rel="prefetch" href="/assets/js/110.f9498efa.js"><link rel="prefetch" href="/assets/js/111.4bd4b4ec.js"><link rel="prefetch" href="/assets/js/112.89ba3573.js"><link rel="prefetch" href="/assets/js/113.acbb8288.js"><link rel="prefetch" href="/assets/js/114.9f14b25a.js"><link rel="prefetch" href="/assets/js/115.66342306.js"><link rel="prefetch" href="/assets/js/116.bd72681b.js"><link rel="prefetch" href="/assets/js/117.7a9d6ae8.js"><link rel="prefetch" href="/assets/js/118.eb65079d.js"><link rel="prefetch" href="/assets/js/119.e5a86bfd.js"><link rel="prefetch" href="/assets/js/12.316aac3b.js"><link rel="prefetch" href="/assets/js/120.1f61d1ba.js"><link rel="prefetch" href="/assets/js/121.809947c3.js"><link rel="prefetch" href="/assets/js/122.952eaa19.js"><link rel="prefetch" href="/assets/js/123.d30b8e83.js"><link rel="prefetch" href="/assets/js/124.114ee50a.js"><link rel="prefetch" href="/assets/js/125.29fc60f1.js"><link rel="prefetch" href="/assets/js/126.c4f6f1ff.js"><link rel="prefetch" href="/assets/js/127.c7f0d09a.js"><link rel="prefetch" href="/assets/js/128.74d892c7.js"><link rel="prefetch" href="/assets/js/129.dd264740.js"><link rel="prefetch" href="/assets/js/13.fe1139b9.js"><link rel="prefetch" href="/assets/js/130.7ca237f9.js"><link rel="prefetch" href="/assets/js/131.0c86bc9a.js"><link rel="prefetch" href="/assets/js/132.25630239.js"><link rel="prefetch" href="/assets/js/133.7c3aff70.js"><link rel="prefetch" href="/assets/js/134.b2825390.js"><link rel="prefetch" href="/assets/js/135.09ad891a.js"><link rel="prefetch" href="/assets/js/136.b6bc5137.js"><link rel="prefetch" href="/assets/js/137.be0265d3.js"><link rel="prefetch" href="/assets/js/138.fc905fe6.js"><link rel="prefetch" href="/assets/js/139.3f4e2934.js"><link rel="prefetch" href="/assets/js/14.96cae973.js"><link rel="prefetch" href="/assets/js/140.f0ad4f82.js"><link rel="prefetch" href="/assets/js/15.8ac0fdfe.js"><link rel="prefetch" href="/assets/js/16.89fc7d69.js"><link rel="prefetch" href="/assets/js/17.ab2f2dac.js"><link rel="prefetch" href="/assets/js/18.d9538616.js"><link rel="prefetch" href="/assets/js/19.a544c0c9.js"><link rel="prefetch" href="/assets/js/20.ffe5b7be.js"><link rel="prefetch" href="/assets/js/21.6b476e98.js"><link rel="prefetch" href="/assets/js/22.fe0ecba9.js"><link rel="prefetch" href="/assets/js/23.b363a0ed.js"><link rel="prefetch" href="/assets/js/24.6a8bfd74.js"><link rel="prefetch" href="/assets/js/25.c9f17ec9.js"><link rel="prefetch" href="/assets/js/26.23685cda.js"><link rel="prefetch" href="/assets/js/27.353cf9c7.js"><link rel="prefetch" href="/assets/js/28.cf6c83bd.js"><link rel="prefetch" href="/assets/js/29.218d6a39.js"><link rel="prefetch" href="/assets/js/3.582414ce.js"><link rel="prefetch" href="/assets/js/30.f457d7ac.js"><link rel="prefetch" href="/assets/js/31.9a2bd76d.js"><link rel="prefetch" href="/assets/js/32.48ccfdab.js"><link rel="prefetch" href="/assets/js/33.292dffe7.js"><link rel="prefetch" href="/assets/js/34.29ce886d.js"><link rel="prefetch" href="/assets/js/35.4f666517.js"><link rel="prefetch" href="/assets/js/36.6b954788.js"><link rel="prefetch" href="/assets/js/37.23afd5f5.js"><link rel="prefetch" href="/assets/js/38.be7afc8d.js"><link rel="prefetch" href="/assets/js/39.a0462821.js"><link rel="prefetch" href="/assets/js/4.b41ed5b4.js"><link rel="prefetch" href="/assets/js/40.ac14193e.js"><link rel="prefetch" href="/assets/js/41.121c8635.js"><link rel="prefetch" href="/assets/js/42.b6b02184.js"><link rel="prefetch" href="/assets/js/43.6038e8e4.js"><link rel="prefetch" href="/assets/js/44.77c00904.js"><link rel="prefetch" href="/assets/js/45.d66a71be.js"><link rel="prefetch" href="/assets/js/46.2fe0507a.js"><link rel="prefetch" href="/assets/js/47.3b724023.js"><link rel="prefetch" href="/assets/js/48.c5920a97.js"><link rel="prefetch" href="/assets/js/49.ffd9ad2a.js"><link rel="prefetch" href="/assets/js/5.266a3c02.js"><link rel="prefetch" href="/assets/js/50.a736b76c.js"><link rel="prefetch" href="/assets/js/51.6d9990df.js"><link rel="prefetch" href="/assets/js/52.ba3dd374.js"><link rel="prefetch" href="/assets/js/53.4ce00275.js"><link rel="prefetch" href="/assets/js/55.081a6724.js"><link rel="prefetch" href="/assets/js/56.9ba96fbf.js"><link rel="prefetch" href="/assets/js/57.aff3a665.js"><link rel="prefetch" href="/assets/js/58.304ef9d0.js"><link rel="prefetch" href="/assets/js/59.6468404c.js"><link rel="prefetch" href="/assets/js/6.770b56c2.js"><link rel="prefetch" href="/assets/js/60.fa65e7a8.js"><link rel="prefetch" href="/assets/js/61.8a2b4207.js"><link rel="prefetch" href="/assets/js/62.eed5a54f.js"><link rel="prefetch" href="/assets/js/63.5cfcbcb3.js"><link rel="prefetch" href="/assets/js/64.b1d4cdba.js"><link rel="prefetch" href="/assets/js/65.e2e3591a.js"><link rel="prefetch" href="/assets/js/66.426d3ada.js"><link rel="prefetch" href="/assets/js/67.2163bf62.js"><link rel="prefetch" href="/assets/js/68.a3b9b943.js"><link rel="prefetch" href="/assets/js/69.10d835d5.js"><link rel="prefetch" href="/assets/js/7.03daa1b7.js"><link rel="prefetch" href="/assets/js/70.4c7a468d.js"><link rel="prefetch" href="/assets/js/71.6d537378.js"><link rel="prefetch" href="/assets/js/72.a231600f.js"><link rel="prefetch" href="/assets/js/73.60fe7679.js"><link rel="prefetch" href="/assets/js/74.6d3c82cb.js"><link rel="prefetch" href="/assets/js/75.dc2baec9.js"><link rel="prefetch" href="/assets/js/76.118a071e.js"><link rel="prefetch" href="/assets/js/77.7c7b532f.js"><link rel="prefetch" href="/assets/js/78.d01d7612.js"><link rel="prefetch" href="/assets/js/79.a255473d.js"><link rel="prefetch" href="/assets/js/8.150af887.js"><link rel="prefetch" href="/assets/js/80.ba913eea.js"><link rel="prefetch" href="/assets/js/81.c19d05fe.js"><link rel="prefetch" href="/assets/js/82.d0b9d12a.js"><link rel="prefetch" href="/assets/js/83.3e04024c.js"><link rel="prefetch" href="/assets/js/84.e3426c0f.js"><link rel="prefetch" href="/assets/js/85.9c933571.js"><link rel="prefetch" href="/assets/js/86.d273250f.js"><link rel="prefetch" href="/assets/js/87.b4cad765.js"><link rel="prefetch" href="/assets/js/88.22b46094.js"><link rel="prefetch" href="/assets/js/89.d52c9da4.js"><link rel="prefetch" href="/assets/js/9.f7aab732.js"><link rel="prefetch" href="/assets/js/90.3bbb46b5.js"><link rel="prefetch" href="/assets/js/91.2cce8e2f.js"><link rel="prefetch" href="/assets/js/92.577bf3ad.js"><link rel="prefetch" href="/assets/js/93.f62024ff.js"><link rel="prefetch" href="/assets/js/94.170d2b1f.js"><link rel="prefetch" href="/assets/js/95.e576205a.js"><link rel="prefetch" href="/assets/js/96.8b3ff24e.js"><link rel="prefetch" href="/assets/js/97.cd67cb86.js"><link rel="prefetch" href="/assets/js/98.5d217544.js"><link rel="prefetch" href="/assets/js/99.f4024c11.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f6885cf5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小张笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/210705_初探可编程网关pipy.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/210705_初探可编程网关pipy.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>初探可编程网关Pipy</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#介绍" class="sidebar-link">介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#核心概念" class="sidebar-link">核心概念</a></li></ul></li><li><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#本地编译" class="sidebar-link">本地编译</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#环境准备" class="sidebar-link">环境准备</a></li><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#编译-pipy" class="sidebar-link">编译 Pipy</a></li><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#demo-hello-pipy" class="sidebar-link">Demo：Hello Pipy</a></li><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#pipy-过滤器" class="sidebar-link">Pipy 过滤器</a></li><li class="sidebar-sub-header"><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#原理" class="sidebar-link">原理</a></li></ul></li><li><a href="/file/210705_%E5%88%9D%E6%8E%A2%E5%8F%AF%E7%BC%96%E7%A8%8B%E7%BD%91%E5%85%B3pipy.html#结语" class="sidebar-link">结语</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>有幸参加了 Flomesh[1] 组织的 workshop，了解了他们的 Pipy 网络代理，以及围绕 Pipy 构建起来的生态。Pipy 在生态中，不止是代理的角色，还是 Flomesh 服务网格中的数据平面。</p> <p>整理一下，做个记录，顺便瞄一下 Pipy 的部分源码。</p> <h2 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h2> <p>下面是摘自 Github 上关于 Pipy 的介绍：</p> <p>Pipy 是一个轻量级、高性能、高稳定、可编程的网络代理。Pipy 核心框架使用 C++ 开发，网络 IO 采用 ASIO 库。 Pipy 的可执行文件仅有 5M 左右，运行期的内存占用 10M 左右，因此 Pipy 非常适合做 Sidecar proxy。</p> <p>Pipy 内置了自研的 pjs 作为脚本扩展，使得 Pipy 可以用 JS 脚本根据特定需求快速定制逻辑与功能。</p> <p>Pipy 采用了模块化、链式的处理架构，用顺序执行的模块来对网络数据块进行处理。这种简单的架构使得 Pipy 底层简单可靠，同时具备了动态编排流量的能力，兼顾了简单和灵活。通过使用 REUSE_PORT 的机制（主流 Linux 和 BSD 版本都支持该功能），Pipy 可以以多进程模式运行，使得 Pipy 不仅适用于 Sidecar 模式，也适用于大规模的流量处理场景。 在实践中，Pipy 独立部署的时候用作 “软负载”，可以在低延迟的情况下，实现媲美硬件的负载均衡吞吐能力，同时具有灵活的扩展性。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opWgEH19h0aJO9L0ksWrEGxwFgicgkIR7va5KfsiafybYzDibw67zNiaNrSg/640?wx_fmt=jpeg" alt="img"></p> <p>Pipy 的核心是消息流处理器：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opvVXCpNhZicPNyHz4HPRia78IA7mIGA5v5RjSelQgwsqteJmVcIwlcNAg/640?wx_fmt=jpeg" alt="img"></p> <p>Pipy 流量处理的流程：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opiap9TQaWjDdZNWZlYpkDpbV4FibCyJT90Vcic0DsiceO6a3b4NV0fqwOmg/640?wx_fmt=jpeg" alt="img"></p> <h3 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h3> <p>• 流（Stream）• 管道（Pipeline）• 模块（Module）• 会话（Session）• 上下文（Context）</p> <p>以下是个人浅见：</p> <p>Pipy 使用 <code>pjs</code> 引擎将 JavaScript 格式的配置，解析成其抽象的 <code>Configuration</code> 对象。每个 <code>Configuration</code> 中包含了多个 <code>Pipeline</code>，每个 <code>Configuration</code> 中又会用到多个 <code>Filter</code>。这些都属于 Pipy 的静态配置部分。（后面会提到 Pipeline 的三种不同类型）</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opgcw4UXj3ar5XHoPjll2kUqogYbQBkTH1Gj5bLZFxDguV5DWB9rQiaug/640?wx_fmt=jpeg" alt="img"></p> <p>而属于<strong>运行时</strong>的就是流、会话和上下文了，在 Pipy 中，数据流是由对象（Pipy 的抽象）组成的。而这些对象抵达 Pipy，被抽象成不同的事件。而事件触发不同的过滤器的执行。</p> <p>我个人更喜欢将其核心理解为：对数据流的事件处理引擎。</p> <p>理解归理解，实践出真知。“大胆假设，小心求证！”</p> <h2 id="本地编译"><a href="#本地编译" class="header-anchor">#</a> 本地编译</h2> <p>从编译 Pipy 开始。</p> <h3 id="环境准备"><a href="#环境准备" class="header-anchor">#</a> 环境准备</h3> <div class="language- line-numbers-mode"><pre class="language-text"><code>#安装 nodejs
$ nvm install lts/erbium 
#安装 cmake
$ brew install cmake
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="编译-pipy"><a href="#编译-pipy" class="header-anchor">#</a> 编译 Pipy</h3> <p>从 <code>https://github.com/flomesh-io/pipy.git</code> 克隆代码。</p> <p>Pipy 的编译包括了两个部分，GUI 和 Pipy 本体。</p> <p>GUI 是 Pipy 提供的一个用于开发模式下进行配置的界面，首先编译 Pipy GUI。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># pipy root folder
$ cd gui
$ npm install
$ npm run build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接着编译 Pipy 的本体</p> <div class="language- line-numbers-mode"><pre class="language-text"><code># pipy root folder
$ mkdir build
$ cd build
$ cmake -DCMAKE_BUILD_TYPE=Release -DPIPY_GUI=ON ..
$ make
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>完成后检查根目录下的 <code>bin</code> 目录，可以看到 pipy 的可执行文件，大小只有 11M。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opSczpVXXlezpqbjnICCIwV8CBqKicz1CHtuoa0l6K9tawoFOwf3sNPbg/640?wx_fmt=jpeg" alt="img"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ bin/pipy --help
Usage: pipy [options] &lt;script filename&gt;
Options:
  -h, -help, --help                    Show help information
  -v, -version, --version              Show version information
  --list-filters                       List all filters
  --help-filters                       Show detailed usage information for all filters
  --log-level=&lt;debug|info|warn|error&gt;  Set the level of log output
  --verify                             Verify configuration only
  --reuse-port                         Enable kernel load balancing for all listening ports
  --gui-port=&lt;port&gt;                    Enable web GUI on the specified port
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="demo-hello-pipy"><a href="#demo-hello-pipy" class="header-anchor">#</a> Demo：Hello Pipy</h3> <p>开发模式下可以让 Pipy 携带 GUI 启动，通过 GUI 进行配置。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#指定 gui 的端口为 6060，从 test 目录中加载配置
$ bin/pipy --gui-port=6060 test/
2021-05-30 22:48:41 [info] [gui] Starting GUI service...
2021-05-30 22:48:41 [info] [listener] Listening on 0.0.0.0:6060
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>浏览器中打开</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opPDicdPkf5a90rACSPvqxiapxatbUHmB32CnF0BQJpXxcCPSc8a2z8azw/640?wx_fmt=jpeg" alt="img"></p> <p>配置界面</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0op3kXZslyBVsyOR5z3PWN1D5ib9fiaialKpxYAdNCARTQtHlnXOu1xQBmkQ/640?wx_fmt=jpeg" alt="img"></p> <p>展开 <code>002-hello</code> 子目录点选 <code>pipy</code> 并点击运行按钮：</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opNVFwB04nMWFJgUJ8HUKQEL7oibOJEDLX4Fucic0BZmSY9caDIRbVXm0g/640?wx_fmt=jpeg" alt="img"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ curl -i localhost:6080
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 7
Hello!
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="pipy-过滤器"><a href="#pipy-过滤器" class="header-anchor">#</a> Pipy 过滤器</h3> <p>通过 pipe 的命令可以输出其支持的过滤器列表，一共 31 个。通过将一系列过滤器进行组装，可以实现复杂的流处理。</p> <p>比如 <code>007-logging</code> 的配置实现了日志的功能：记录请求和响应的数据，并批量发送到 ElasticSearch。这里就用到了 <code>fork</code>、<code>connect</code>、<code>onSessionStart</code>、<code>encodeHttpRequest</code>、<code>decodeHttpRequest</code>、<code>onMessageStart</code>、<code>onMessage</code>、<code>decodeHttpResponse</code>、<code>replaceMessage</code>、<code>link</code>、<code>mux</code>、<code>task</code> 等十多种过滤器。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opnp5YWibdtqEkiaicyjtXb9OBYkQGgQjbzGdLM8cFiabhRQPmTOLzHINZnw/640?wx_fmt=jpeg" alt="img"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>$ bin/pipy --list-filters
connect             (target[, options])                         Sends data to a remote endpoint and receives data from it
demux               (target)                                    Sends messages to a different pipline with each one in its own session and context
decodeDubbo         ()                                          Deframes a Dubbo message
decodeHttpRequest   ()                                          Deframes an HTTP request message
decodeHttpResponse  ()                                          Deframes an HTTP response message
dummy               ()                                          Eats up all events
dump                ([tag])                                     Outputs events to the standard output
encodeDubbo         ([head])                                    Frames a Dubbo message
encodeHttpRequest   ([head])                                    Frames an HTTP request message
encodeHttpResponse  ([head])                                    Frames an HTTP response message
exec                (command)                                   Spawns a child process and connects to its input/output
fork                (target[, sessionData])                     Sends copies of events to other pipeline sessions
link                (target[, when[, target2[, when2, ...]]])   Sends events to a different pipeline
mux                 (target[, selector])                        Sends messages from different sessions to a shared pipeline session
onSessionStart      (callback)                                  Handles the initial event in a session
onData              (callback)                                  Handles a Data event
onMessageStart      (callback)                                  Handles a MessageStart event
onMessageEnd        (callback)                                  Handles a MessageEnd event
onSessionEnd        (callback)                                  Handles a SessionEnd event
onMessageBody       (callback)                                  Handles a complete message body
onMessage           (callback)                                  Handles a complete message including the head and the body
print               ()                                          Outputs raw data to the standard output
replaceSessionStart (callback)                                  Replaces the initial event in a session
replaceData         ([replacement])                             Replaces a Data event
replaceMessageStart ([replacement])                             Replaces a MessageStart event
replaceMessageEnd   ([replacement])                             Replaces a MessageEnd event
replaceSessionEnd   ([replacement])                             Replaces a SessionEnd event
replaceMessageBody  ([replacement])                             Replaces an entire message body
replaceMessage      ([replacement])                             Replaces a complete message including the head and the body
tap                 (quota[, account])                          Throttles message rate or data rate
use                 (module, pipeline[, argv...])               Sends events to a pipeline in a different module
wait                (condition)                                 Buffers up events until a condition is fulfilled
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <p>“Talk is cheap, show me the code.”</p> <h4 id="配置加载"><a href="#配置加载" class="header-anchor">#</a> 配置加载</h4> <p>个人比较喜欢看源码来理解实现，即使是 C++。从浏览器请求入手发现运行时向<code>/api/program</code> 发送了 <code>POST</code> 请求，请求的内容是配置文件的地址。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opLZ1MEUzMNuHeFicJ27c0Rn3fibbB0Z2zGE425j1DndJK2yKUumliaKLTA/640?wx_fmt=jpeg" alt="img"></p> <p>检查源码后，找到逻辑的实现在 <code>src/gui.cpp:189</code>：</p> <p>\1. 创建新的 worker2. 加载配置，将 JavaScrip 代码解析成 <code>Configuration</code> 对象 3. 启动 worker，执行<code>Configuration::apply()</code>4. 卸载旧的 worker</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opWlcDZick9NtCb2GW1s9wVfj6PDX4ncMPJsicPibQ2V8rgWzXJaia4I2uwA/640?wx_fmt=jpeg" alt="img"></p> <p>从 <code>src/api/configuration.cpp:267</code> 处看：<code>pipeline</code>、<code>listen</code> 和 <code>task</code> 配置实际在 Pipy 的配置中都是被抽象为 <code>Pipeline</code> 对象，只是在类型上有差异分别为：<code>NAMED</code>、<code>LISTEN</code> 和 <code>TASK</code>。比如 <code>listen</code> 中可以通过 <code>fork</code> 过滤器将事件的副本发送到指定的 <code>pipeline</code> 中。</p> <p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0oppiblzfj5LibLiaqvG9cNiciaDgsLicbKu5sWjWib25V5DuTicEOg3gLsNBAwQg/640?wx_fmt=jpeg" alt="img"></p> <h4 id="基于数据流事件的处理"><a href="#基于数据流事件的处理" class="header-anchor">#</a> 基于数据流事件的处理</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>src/inbound.cpp:171
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/tMghG0NOfxfccGBoTG0PHr9icbByNr0opjIic4ddAgCbcyxagzqWtYHEYLlWbnUZe2N3m6k9ibgibibGB9ZZckBRMOA/640?wx_fmt=jpeg" alt="img"></p> <h2 id="结语"><a href="#结语" class="header-anchor">#</a> 结语</h2> <p>Pipy 虽小（只有 11M），但以其可编程的特性提供了灵活的配置能力，潜力无限。</p> <p>Pipy 像处理 HTTP 一样处理任意的七层协议。内部版本支持 Dubbo、Redis、Socks 等，目前正在迁移到开源版本。</p> <p>期待即将开源的 Portal，以及服务网格 Flomesh。持续关注，后面考虑再写几篇。</p> <p>“未来可期！”</p> <h4 id="引用链接"><a href="#引用链接" class="header-anchor">#</a> 引用链接</h4> <p><code>[1]</code> Flomesh: <em>https://flomesh.cn/</em></p> <p>全文完</p> <p>本文由 <a href="http://ksria.com/simpread" target="_blank" rel="noopener noreferrer">简悦 SimpRead<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 优化，用以提升阅读体验</p> <p>使用了 全新的简悦词法分析引擎 beta，<a href="http://ksria.com/simpread/docs/#/%E8%AF%8D%E6%B3%95%E5%88%86%E6%9E%90%E5%BC%95%E6%93%8E" target="_blank" rel="noopener noreferrer">点击查看<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>详细说明</p> <p><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-0" target="_blank" rel="noopener noreferrer">介绍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-1" target="_blank" rel="noopener noreferrer">核心概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-2" target="_blank" rel="noopener noreferrer">本地编译<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-3" target="_blank" rel="noopener noreferrer">环境准备<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-4" target="_blank" rel="noopener noreferrer">编译 Pipy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-5" target="_blank" rel="noopener noreferrer">Demo：Hello Pipy<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-6" target="_blank" rel="noopener noreferrer">Pipy 过滤器<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-7" target="_blank" rel="noopener noreferrer">原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-8" target="_blank" rel="noopener noreferrer">配置加载<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-9" target="_blank" rel="noopener noreferrer">基于数据流事件的处理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-10" target="_blank" rel="noopener noreferrer">结语<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://mp.weixin.qq.com/s?__biz=MjM5OTg2MTM0MQ==&amp;mid=2247484191&amp;idx=1&amp;sn=d25dd35ac1ce8e2fff1bc513a81e6c3f&amp;scene=21#sr-toc-11" target="_blank" rel="noopener noreferrer">引用链接<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/11/12 上午12:25:46</span></div></footer> <!----> </main> <div class="footer-wrapper footer"><span><a href="https://beian.miit.gov.cn/">豫ICP备20003255号</a></span> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d335a484.js" defer></script><script src="/assets/js/2.a6173bc2.js" defer></script><script src="/assets/js/54.3f8bdd35.js" defer></script>
  </body>
</html>
