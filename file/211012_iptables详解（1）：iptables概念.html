<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>“iptables详解（1）：iptables概念” | 小张笔记</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-141019448-1"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
      
          gtag('config', 'UA-141019448-1');
      </script>
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2468672938537807" crossorigin="anonymous"></script>
    <meta name="description" content="Little Zhang's Note">
    <meta name="baidu-site-verification" content="code-HRrK6kdBX1">
    
    <link rel="preload" href="/assets/css/0.styles.9b71556a.css" as="style"><link rel="preload" href="/assets/js/app.949e1d4d.js" as="script"><link rel="preload" href="/assets/js/2.a6173bc2.js" as="script"><link rel="preload" href="/assets/js/78.c54e5e93.js" as="script"><link rel="prefetch" href="/assets/js/10.bf63d664.js"><link rel="prefetch" href="/assets/js/100.693a312c.js"><link rel="prefetch" href="/assets/js/101.725a479a.js"><link rel="prefetch" href="/assets/js/102.40f52169.js"><link rel="prefetch" href="/assets/js/103.2717b6ca.js"><link rel="prefetch" href="/assets/js/104.e0df7176.js"><link rel="prefetch" href="/assets/js/105.1f0786cd.js"><link rel="prefetch" href="/assets/js/106.6a48bf56.js"><link rel="prefetch" href="/assets/js/107.49a2484f.js"><link rel="prefetch" href="/assets/js/108.5141baf2.js"><link rel="prefetch" href="/assets/js/109.71d37301.js"><link rel="prefetch" href="/assets/js/11.929ebbd8.js"><link rel="prefetch" href="/assets/js/110.ba21781c.js"><link rel="prefetch" href="/assets/js/111.0779a44a.js"><link rel="prefetch" href="/assets/js/112.4f663cbf.js"><link rel="prefetch" href="/assets/js/113.8c8b7ae8.js"><link rel="prefetch" href="/assets/js/114.8d6e510e.js"><link rel="prefetch" href="/assets/js/115.62f1946c.js"><link rel="prefetch" href="/assets/js/116.2c143730.js"><link rel="prefetch" href="/assets/js/117.124c1d03.js"><link rel="prefetch" href="/assets/js/118.89d4a12d.js"><link rel="prefetch" href="/assets/js/119.2b4508e9.js"><link rel="prefetch" href="/assets/js/12.72597efe.js"><link rel="prefetch" href="/assets/js/120.4195487b.js"><link rel="prefetch" href="/assets/js/121.797a43ad.js"><link rel="prefetch" href="/assets/js/122.62e66240.js"><link rel="prefetch" href="/assets/js/123.d57dca7b.js"><link rel="prefetch" href="/assets/js/124.45195017.js"><link rel="prefetch" href="/assets/js/125.30e6e8b7.js"><link rel="prefetch" href="/assets/js/126.95d0631d.js"><link rel="prefetch" href="/assets/js/127.31602d51.js"><link rel="prefetch" href="/assets/js/128.f2ee91f5.js"><link rel="prefetch" href="/assets/js/129.dd264740.js"><link rel="prefetch" href="/assets/js/13.c6ecca4f.js"><link rel="prefetch" href="/assets/js/130.ade97cb3.js"><link rel="prefetch" href="/assets/js/131.3fe22fdf.js"><link rel="prefetch" href="/assets/js/132.bd3f4fbd.js"><link rel="prefetch" href="/assets/js/133.3982d4ef.js"><link rel="prefetch" href="/assets/js/134.f73a8836.js"><link rel="prefetch" href="/assets/js/135.a9e9906f.js"><link rel="prefetch" href="/assets/js/136.2360d41d.js"><link rel="prefetch" href="/assets/js/137.bf58c952.js"><link rel="prefetch" href="/assets/js/138.3ad88192.js"><link rel="prefetch" href="/assets/js/139.3e185807.js"><link rel="prefetch" href="/assets/js/14.d98aa6b4.js"><link rel="prefetch" href="/assets/js/15.b59d47ee.js"><link rel="prefetch" href="/assets/js/16.0076b2d1.js"><link rel="prefetch" href="/assets/js/17.ab2f2dac.js"><link rel="prefetch" href="/assets/js/18.23dfab4e.js"><link rel="prefetch" href="/assets/js/19.a544c0c9.js"><link rel="prefetch" href="/assets/js/20.dc7b487c.js"><link rel="prefetch" href="/assets/js/21.6b476e98.js"><link rel="prefetch" href="/assets/js/22.e459fb79.js"><link rel="prefetch" href="/assets/js/23.b363a0ed.js"><link rel="prefetch" href="/assets/js/24.c7e3e56c.js"><link rel="prefetch" href="/assets/js/25.c9f17ec9.js"><link rel="prefetch" href="/assets/js/26.39d77fc6.js"><link rel="prefetch" href="/assets/js/27.b647187c.js"><link rel="prefetch" href="/assets/js/28.f314aa79.js"><link rel="prefetch" href="/assets/js/29.e64b97b0.js"><link rel="prefetch" href="/assets/js/3.582414ce.js"><link rel="prefetch" href="/assets/js/30.f457d7ac.js"><link rel="prefetch" href="/assets/js/31.9a2bd76d.js"><link rel="prefetch" href="/assets/js/32.76f542ca.js"><link rel="prefetch" href="/assets/js/33.3516b47f.js"><link rel="prefetch" href="/assets/js/34.47a0c8c7.js"><link rel="prefetch" href="/assets/js/35.03cb32b4.js"><link rel="prefetch" href="/assets/js/36.9277d651.js"><link rel="prefetch" href="/assets/js/37.23afd5f5.js"><link rel="prefetch" href="/assets/js/38.b909d32b.js"><link rel="prefetch" href="/assets/js/39.a0462821.js"><link rel="prefetch" href="/assets/js/4.b4b0170a.js"><link rel="prefetch" href="/assets/js/40.d1a729a6.js"><link rel="prefetch" href="/assets/js/41.121c8635.js"><link rel="prefetch" href="/assets/js/42.bf562506.js"><link rel="prefetch" href="/assets/js/43.dce43b40.js"><link rel="prefetch" href="/assets/js/44.0756cd25.js"><link rel="prefetch" href="/assets/js/45.8794fb7e.js"><link rel="prefetch" href="/assets/js/46.fe22afa4.js"><link rel="prefetch" href="/assets/js/47.3b724023.js"><link rel="prefetch" href="/assets/js/48.c5920a97.js"><link rel="prefetch" href="/assets/js/49.932957ea.js"><link rel="prefetch" href="/assets/js/5.6c7f4d05.js"><link rel="prefetch" href="/assets/js/50.a736b76c.js"><link rel="prefetch" href="/assets/js/51.fdf07d65.js"><link rel="prefetch" href="/assets/js/52.ba3dd374.js"><link rel="prefetch" href="/assets/js/53.4ce00275.js"><link rel="prefetch" href="/assets/js/54.3f8bdd35.js"><link rel="prefetch" href="/assets/js/55.081a6724.js"><link rel="prefetch" href="/assets/js/56.dd671968.js"><link rel="prefetch" href="/assets/js/57.f4151d91.js"><link rel="prefetch" href="/assets/js/58.304ef9d0.js"><link rel="prefetch" href="/assets/js/59.6468404c.js"><link rel="prefetch" href="/assets/js/6.bb33fed3.js"><link rel="prefetch" href="/assets/js/60.fa65e7a8.js"><link rel="prefetch" href="/assets/js/61.8a2b4207.js"><link rel="prefetch" href="/assets/js/62.eed5a54f.js"><link rel="prefetch" href="/assets/js/63.5cfcbcb3.js"><link rel="prefetch" href="/assets/js/64.8c72f137.js"><link rel="prefetch" href="/assets/js/65.f2f736aa.js"><link rel="prefetch" href="/assets/js/66.f4fde240.js"><link rel="prefetch" href="/assets/js/67.2163bf62.js"><link rel="prefetch" href="/assets/js/68.362215f6.js"><link rel="prefetch" href="/assets/js/69.8cc82c96.js"><link rel="prefetch" href="/assets/js/7.b8ca5592.js"><link rel="prefetch" href="/assets/js/70.4c7a468d.js"><link rel="prefetch" href="/assets/js/71.3982ce7a.js"><link rel="prefetch" href="/assets/js/72.60b0701f.js"><link rel="prefetch" href="/assets/js/73.60fe7679.js"><link rel="prefetch" href="/assets/js/74.21040cf6.js"><link rel="prefetch" href="/assets/js/75.d8605e36.js"><link rel="prefetch" href="/assets/js/76.0e066fd6.js"><link rel="prefetch" href="/assets/js/77.838e106d.js"><link rel="prefetch" href="/assets/js/79.55c0179b.js"><link rel="prefetch" href="/assets/js/8.df898268.js"><link rel="prefetch" href="/assets/js/80.58526f91.js"><link rel="prefetch" href="/assets/js/81.0ee1f516.js"><link rel="prefetch" href="/assets/js/82.d0b9d12a.js"><link rel="prefetch" href="/assets/js/83.a61a8d5a.js"><link rel="prefetch" href="/assets/js/84.c4d8e817.js"><link rel="prefetch" href="/assets/js/85.6a87b80a.js"><link rel="prefetch" href="/assets/js/86.cab67863.js"><link rel="prefetch" href="/assets/js/87.b4cad765.js"><link rel="prefetch" href="/assets/js/88.2a2291a2.js"><link rel="prefetch" href="/assets/js/89.6609a6d5.js"><link rel="prefetch" href="/assets/js/9.f7aab732.js"><link rel="prefetch" href="/assets/js/90.8aca6139.js"><link rel="prefetch" href="/assets/js/91.237eca1a.js"><link rel="prefetch" href="/assets/js/92.b7ef843b.js"><link rel="prefetch" href="/assets/js/93.8d26a9db.js"><link rel="prefetch" href="/assets/js/94.170d2b1f.js"><link rel="prefetch" href="/assets/js/95.e576205a.js"><link rel="prefetch" href="/assets/js/96.e090fc4a.js"><link rel="prefetch" href="/assets/js/97.3d4c2da3.js"><link rel="prefetch" href="/assets/js/98.5d217544.js"><link rel="prefetch" href="/assets/js/99.e5a41af7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9b71556a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小张笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/211012_iptables详解（1）：iptables概念.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/索引/Search.html" class="nav-link">
  Google站内搜索
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/211012_iptables详解（1）：iptables概念.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <!----></nav>  <!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>“iptables详解（1）：iptables概念”</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#防火墙相关概念" class="sidebar-link">防火墙相关概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#iptables基础" class="sidebar-link">iptables基础</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#链的概念" class="sidebar-link">链的概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#表的概念" class="sidebar-link">表的概念</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#表链关系" class="sidebar-link">表链关系</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#数据经过防火墙的流程" class="sidebar-link">数据经过防火墙的流程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#规则的概念" class="sidebar-link">规则的概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#匹配条件" class="sidebar-link">匹配条件</a></li><li class="sidebar-sub-header"><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#处理动作" class="sidebar-link">处理动作</a></li></ul></li><li><a href="/file/211012_iptables%E8%AF%A6%E8%A7%A3%EF%BC%881%EF%BC%89%EF%BC%9Aiptables%E6%A6%82%E5%BF%B5.html#小结" class="sidebar-link">小结</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><ul><li><p><img src="https://www.zsythink.net/m/touxiang/G.jpg" alt="朱双印"></p></li> <li><ul><li><p><a href="https://www.zsythink.net/archives/author/1" target="_blank" rel="noopener noreferrer">朱双印<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>7月前更新</p></li></ul></li> <li><p>[赞赏](javascript:😉</p></li></ul> <p>[301](javascript:(scrollTo('#comments',-100));)2380</p> <p>这篇文章会尽量以通俗易懂的方式描述<a href="https://www.zsythink.net/archives/tag/iptables/" target="_blank" rel="noopener noreferrer">iptables<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的相关概念，请耐心的读完它。</p> <h2 id="防火墙相关概念"><a href="#防火墙相关概念" class="header-anchor">#</a> 防火墙相关概念</h2> <p>此处先描述一些相关概念。</p> <p>从逻辑上讲。防火墙可以大体分为主机防火墙和网络防火墙。</p> <p>主机防火墙：针对于单个主机进行防护。</p> <p>网络防火墙：往往处于网络入口或边缘，针对于网络入口进行防护，服务于防火墙背后的本地局域网。</p> <p>网络防火墙和主机防火墙并不冲突，可以理解为，网络防火墙主外（集体）， 主机防火墙主内（个人）。</p> <p>从物理上讲，防火墙可以分为硬件防火墙和软件防火墙。</p> <p>硬件防火墙：在硬件级别实现部分防火墙功能，另一部分功能基于软件实现，性能高，成本高。</p> <p>软件防火墙：应用软件处理逻辑运行于通用硬件平台之上的防火墙，性能低，成本低。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="iptables.png"></p> <p>那么在此处，我们就来聊聊Linux的iptables</p> <p><strong>iptables</strong>其实不是真正的防火墙，我们可以把它理解成一个客户端代理，用户通过iptables这个代理，将用户的安全设定执行到对应的”安全框架”中，这个”安全框架”才是真正的防火墙，这个框架的名字叫<strong>netfilter</strong></p> <p>netfilter才是防火墙真正的安全框架（framework），netfilter位于内核空间。</p> <p>iptables其实是一个命令行工具，位于用户空间，我们用这个工具操作真正的框架。</p> <p>netfilter/iptables（下文中简称为iptables）组成Linux平台下的包过滤防火墙，与大多数的Linux软件一样，这个包过滤防火墙是免费的，它可以代替昂贵的商业防火墙解决方案，完成封包过滤、封包重定向和网络地址转换（NAT）等功能。</p> <p>Netfilter是Linux操作系统核心层内部的一个数据包处理模块，它具有如下功能：</p> <p>网络地址转换(Network Address Translate)</p> <p>数据包内容修改</p> <p>以及数据包过滤的防火墙功能</p> <p>所以说，虽然我们使用service iptables start启动iptables”服务”，但是其实准确的来说，iptables并没有一个守护进程，所以并不能算是真正意义上的服务，而应该算是内核提供的功能。</p> <h2 id="iptables基础"><a href="#iptables基础" class="header-anchor">#</a> iptables基础</h2> <p>我们知道iptables是按照规则来办事的，我们就来说说规则（rules），规则其实就是网络管理员预定义的条件，规则一般的定义为”如果数据包头符合这样的条件，就这样处理这个数据包”。规则存储在内核空间的信息包过滤表中，这些规则分别指定了源地址、目的地址、传输协议（如TCP、UDP、ICMP）和服务类型（如HTTP、FTP和SMTP）等。当数据包与规则匹配时，iptables就根据规则所定义的方法来处理这些数据包，如放行（accept）、拒绝（reject）和丢弃（drop）等。配置防火墙的主要工作就是添加、修改和删除这些规则。</p> <p>这样说可能并不容易理解，我们来换个容易理解的角度，从头说起.</p> <p>当客户端访问服务器的web服务时，客户端发送报文到网卡，而tcp/ip协议栈是属于内核的一部分，所以，客户端的信息会通过内核的TCP协议传输到用户空间中的web服务中，而此时，客户端报文的目标终点为web服务所监听的套接字（IP：Port）上，当web服务需要响应客户端请求时，web服务发出的响应报文的目标终点则为客户端，这个时候，web服务所监听的IP与端口反而变成了原点，我们说过，netfilter才是真正的防火墙，它是内核的一部分，所以，如果我们想要防火墙能够达到”防火”的目的，则需要在内核中设置关卡，所有进出的报文都要通过这些关卡，经过检查后，符合放行条件的才能放行，符合阻拦条件的则需要被阻止，于是，就出现了input关卡和output关卡，而这些关卡在iptables中不被称为”关卡”,而被称为”链”。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <p>其实我们上面描述的场景并不完善，因为客户端发来的报文访问的目标地址可能并不是本机，而是其他服务器，当本机的内核支持IP_FORWARD时，我们可以将报文转发给其他服务器，所以，这个时候，我们就会提到iptables中的其他”关卡”，也就是其他”链”，他们就是  “路由前”、”转发”、”路由后”，他们的英文名是</p> <p>PREROUTING、FORWARD、POSTROUTING</p> <p>也就是说，当我们启用了防火墙功能时，报文需要经过如下关卡，也就是说，根据实际情况的不同，报文经过”链”可能不同。如果报文需要转发，那么报文则不会经过input链发往用户空间，而是直接在内核空间中经过forward链和postrouting链转发出去的。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <p>所以，根据上图，我们能够想象出某些常用场景中，报文的流向：</p> <p>到本机某进程的报文：PREROUTING –&gt; INPUT</p> <p>由本机转发的报文：PREROUTING –&gt; FORWARD –&gt; POSTROUTING</p> <p>由本机的某进程发出报文（通常为响应报文）：OUTPUT –&gt; POSTROUTING</p> <h2 id="链的概念"><a href="#链的概念" class="header-anchor">#</a> 链的概念</h2> <p>现在，我们想象一下，这些”关卡”在iptables中为什么被称作”链”呢？我们知道，防火墙的作用就在于对经过的报文匹配”规则”，然后执行对应的”动作”,所以，当报文经过这些关卡的时候，则必须匹配这个关卡上的规则，但是，这个关卡上可能不止有一条规则，而是有很多条规则，当我们把这些规则串到一个链条上的时候，就形成了”链”,所以，我们把每一个”关卡”想象成如下图中的模样  ，这样来说，把他们称为”链”更为合适，每个经过这个”关卡”的报文，都要将这条”链”上的所有规则匹配一遍，如果有符合条件的规则，则执行规则对应的动作。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <h2 id="表的概念"><a href="#表的概念" class="header-anchor">#</a> 表的概念</h2> <p>我们再想想另外一个问题，我们对每个”链”上都放置了一串规则，但是这些规则有些很相似，比如，A类规则都是对IP或者端口的过滤，B类规则是修改报文，那么这个时候，我们是不是能把实现相同功能的规则放在一起呢，必须能的。</p> <p>我们把具有相同功能的规则的集合叫做”表”，所以说，不同功能的规则，我们可以放置在不同的表中进行管理，而iptables已经为我们定义了4种表，每种表对应了不同的功能，而我们定义的规则也都逃脱不了这4种功能的范围，所以，学习iptables之前，我们必须先搞明白每种表 的作用。</p> <p>iptables为我们提供了如下规则的分类，或者说，iptables为我们提供了如下”表”</p> <p>filter表：负责过滤功能，防火墙；内核模块：iptables_filter</p> <p>nat表：network address translation，网络地址转换功能；内核模块：iptable_nat</p> <p>mangle表：拆解报文，做出修改，并重新封装 的功能；iptable_mangle</p> <p>raw表：关闭nat表上启用的连接追踪机制；iptable_raw</p> <p>也就是说，我们自定义的所有规则，都是这四种分类中的规则，或者说，所有规则都存在于这4张”表”中。</p> <h2 id="表链关系"><a href="#表链关系" class="header-anchor">#</a> 表链关系</h2> <p>但是我们需要注意的是，某些”链”中注定不会包含”某类规则”，就像某些”关卡”天生就不具备某些功能一样，比如，A”关卡”只负责打击陆地敌人，没有防空能力，B”关卡”只负责打击空中敌人，没有防御步兵的能力，C”关卡”可能比较NB，既能防空，也能防御陆地敌人，D”关卡”最屌，海陆空都能防。</p> <p>那让我们来看看，每个”关卡”都有哪些能力，或者说，让我们看看每个”链”上的规则都存在于哪些”表”中。</p> <p>我们还是以图为例，先看看prerouting”链”上的规则都存在于哪些表中。</p> <p>注意：下图只用于说明prerouting链上的规则存在于哪些表中，并没有描述表的顺序。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <p>这幅图是什么意思呢？它的意思是说，prerouting”链”只拥有nat表、raw表和mangle表所对应的功能，所以，prerouting中的规则只能存放于nat表、raw表和mangle表中。</p> <p>那么，根据上述思路，我们来总结一下，每个”关卡”都拥有什么功能，</p> <p>或者说，每个”链”中的规则都存在于哪些”表”中。</p> <p>PREROUTING    的规则可以存在于：raw表，mangle表，nat表。</p> <p>INPUT      的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p> <p>FORWARD     的规则可以存在于：mangle表，filter表。</p> <p>OUTPUT     的规则可以存在于：raw表mangle表，nat表，filter表。</p> <p>POSTROUTING    的规则可以存在于：mangle表，nat表。</p> <p>但是，<strong>我们在实际的使用过程中，往往是通过”表”作为操作入****口，对规则进行定义的</strong>，之所以按照上述过程介绍iptables，是因为从”关卡”的角度更容易从入门的角度理解，但是为了以便在实际使用的时候，更加顺畅的理解它们，此处我们还要将各”表”与”链”的关系罗列出来，</p> <p>表（功能）&lt;–&gt;  链（钩子）：</p> <p>raw   表中的规则可以被哪些链使用：PREROUTING，OUTPUT</p> <p>mangle  表中的规则可以被哪些链使用：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</p> <p>nat   表中的规则可以被哪些链使用：PREROUTING，OUTPUT，POSTROUTING（centos7中还有INPUT，centos6中没有）</p> <p>filter  表中的规则可以被哪些链使用：INPUT，FORWARD，OUTPUT</p> <p>其实我们还需要注意一点，因为数据包经过一个”链”的时候，会将当前链的所有规则都匹配一遍，但是匹配时总归要有顺序，我们应该一条一条的去匹配，而且我们说过，相同功能类型的规则会汇聚在一张”表”中，那么，哪些”表”中的规则会放在”链”的最前面执行呢，这时候就需要有一个优先级的问题，我们还拿prerouting”链”做图示。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <p>prerouting链中的规则存放于三张表中，而这三张表中的规则执行的优先级如下：</p> <p>raw –&gt; mangle –&gt; nat</p> <p>但是我们知道，iptables为我们定义了4张”表”,当他们处于同一条”链”时，执行的优先级如下。</p> <p>优先级次序（由高而低）：</p> <p>raw –&gt; mangle –&gt; nat –&gt; filter</p> <p>但是我们前面说过，某些链天生就不能使用某些表中的规则，所以，4张表中的规则处于同一条链的目前只有output链，它就是传说中海陆空都能防守的关卡。</p> <p>为了更方便的管理，我们还可以在某个表里面创建自定义链，将针对某个应用程序所设置的规则放置在这个自定义链中，但是自定义链接不能直接使用，只能被某个默认的链当做动作去调用才能起作用，我们可以这样想象，自定义链就是一段比较”短”的链子，这条”短”链子上的规则都是针对某个应用程序制定的，但是这条短的链子并不能直接使用，而是需要”焊接”在iptables默认定义链子上，才能被IPtables使用，这就是为什么默认定义的”链”需要把”自定义链”当做”动作”去引用的原因。这是后话，后面再聊，在实际使用时我们即可更加的明白。</p> <h2 id="数据经过防火墙的流程"><a href="#数据经过防火墙的流程" class="header-anchor">#</a> 数据经过防火墙的流程</h2> <p>结合上述所有的描述，我们可以将数据包通过防火墙的流程总结为下图：</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <p>我们在写Iptables规则的时候，要时刻牢记这张路由次序图，灵活配置规则。</p> <p>我们将经常用到的对应关系重新写在此处，方便对应图例查看。</p> <p>链的规则存放于哪些表中（从链到表的对应关系）：</p> <p>PREROUTING  的规则可以存在于：raw表，mangle表，nat表。</p> <p>INPUT     的规则可以存在于：mangle表，filter表，（centos7中还有nat表，centos6中没有）。</p> <p>FORWARD    的规则可以存在于：mangle表，filter表。</p> <p>OUTPUT    的规则可以存在于：raw表mangle表，nat表，filter表。</p> <p>POSTROUTING  的规则可以存在于：mangle表，nat表。</p> <p>表中的规则可以被哪些链使用（从表到链的对应关系）：</p> <p>raw   表中的规则可以被哪些链使用：PREROUTING，OUTPUT</p> <p>mangle  表中的规则可以被哪些链使用：PREROUTING，INPUT，FORWARD，OUTPUT，POSTROUTING</p> <p>nat   表中的规则可以被哪些链使用：PREROUTING，OUTPUT，POSTROUTING（centos7中还有INPUT，centos6中没有）</p> <p>filter  表中的规则可以被哪些链使用：INPUT，FORWARD，OUTPUT</p> <p>下图中nat表在centos7中的情况就不再标明。</p> <p><img src="http://www.zsythink.net/wp-content/themes/zibll/img/thumbnail-lg.svg" alt="img"></p> <h2 id="规则的概念"><a href="#规则的概念" class="header-anchor">#</a> 规则的概念</h2> <p>说了一圈又说回来了，在上述描述中我们一直在提规则，可是没有细说，现在说说它。</p> <p>先说说规则的概念，然后再通俗的解释它。</p> <p>规则：根据指定的匹配条件来尝试匹配每个流经此处的报文，一旦匹配成功，则由规则后面指定的处理动作进行处理；</p> <p>那么我们来通俗的解释一下什么是iptables的规则，之前打过一个比方，每条”链”都是一个”关卡”，每个通过这个”关卡”的报文都要匹配这个关卡上的规则，如果匹配，则对报文进行对应的处理，比如说，你我二人此刻就好像两个”报文”，你我二人此刻都要入关，可是城主有命，只有器宇轩昂的人才能入关，不符合此条件的人不能入关，于是守关将士按照城主制定的”规则”，开始打量你我二人，最终，你顺利入关了，而我已被拒之门外，因为你符合”器宇轩昂”的标准，所以把你”放行”了，而我不符合标准，所以没有被放行，其实，”器宇轩昂”就是一种”匹配条件”，”放行”就是一种”动作”，”匹配条件”与”动作”组成了规则。</p> <p>了解了规则的概念，那我们来聊聊规则的组成部分,此处只是大概的将规则的结构列出，后面的文章中会单独对规则进行总结。</p> <p>规则由匹配条件和处理动作组成。</p> <h3 id="匹配条件"><a href="#匹配条件" class="header-anchor">#</a> 匹配条件</h3> <p>匹配条件分为基本匹配条件与扩展匹配条件</p> <p><strong>基本匹配条件：</strong></p> <p>源地址Source IP，目标地址 Destination IP</p> <p>上述内容都可以作为基本匹配条件。</p> <p><strong>扩展匹配条件：</strong></p> <p>除了上述的条件可以用于匹配，还有很多其他的条件可以用于匹配，这些条件泛称为扩展条件，这些扩展条件其实也是netfilter中的一部分，只是以模块的形式存在，如果想要使用这些条件，则需要依赖对应的扩展模块。</p> <p>源端口Source Port, 目标端口Destination Port</p> <p>上述内容都可以作为扩展匹配条件</p> <h3 id="处理动作"><a href="#处理动作" class="header-anchor">#</a> <strong>处理动作</strong></h3> <p>处理动作在iptables中被称为target（这样说并不准确，我们暂且这样称呼），动作也可以分为基本动作和扩展动作。</p> <p>此处列出一些常用的动作，之后的文章会对它们进行详细的示例与总结：</p> <p><strong>ACCEPT</strong>：允许数据包通过。</p> <p><strong>DROP</strong>：直接丢弃数据包，不给任何回应信息，这时候客户端会感觉自己的请求泥牛入海了，过了超时时间才会有反应。</p> <p><strong>REJECT</strong>：拒绝数据包通过，必要时会给数据发送端一个响应的信息，客户端刚请求就会收到拒绝的信息。</p> <p><strong>SNAT</strong>：源地址转换，解决内网用户用同一个公网地址上网的问题。</p> <p><strong>MASQUERADE</strong>：是SNAT的一种特殊形式，适用于动态的、临时会变的ip上。</p> <p><strong>DNAT</strong>：目标地址转换。</p> <p><strong>REDIRECT</strong>：在本机做端口映射。</p> <p><strong>LOG</strong>：在/var/log/messages文件中记录日志信息，然后将数据包传递给下一条规则，也就是说除了记录以外不对数据包做任何其他操作，仍然让下一条规则去匹配。</p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>iptables的实际操作我们会另外总结为其他文章，iptables系列文章列表直达链接如下：</p> <p><a href="https://www.zsythink.net/archives/tag/iptables/" target="_blank" rel="noopener noreferrer">iptables零基础快速入门系列<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>好了，iptables的概念暂时总结到这里，懂得概念之后，再结合实际的命令去练习，搞定iptables绝对妥妥的。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/11/12 上午12:25:46</span></div></footer> <!----> </main> <div class="footer-wrapper footer"><span><a href="https://beian.miit.gov.cn/">豫ICP备20003255号</a></span> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.949e1d4d.js" defer></script><script src="/assets/js/2.a6173bc2.js" defer></script><script src="/assets/js/78.c54e5e93.js" defer></script>
  </body>
</html>
