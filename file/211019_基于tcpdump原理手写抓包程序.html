<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>â€œåŸºäºtcpdumpåŸç†æ‰‹å†™æŠ“åŒ…ç¨‹åºâ€ | å°å¼ ç¬”è®°</title>
    <meta name="generator" content="VuePress 1.7.1">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=UA-141019448-1"></script>
    <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
      
          gtag('config', 'UA-141019448-1');
      </script>
    <script async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2468672938537807" crossorigin="anonymous"></script>
    <meta name="description" content="Little Zhang's Note">
    <meta name="baidu-site-verification" content="code-HRrK6kdBX1">
    
    <link rel="preload" href="/assets/css/0.styles.ceffaf74.css" as="style"><link rel="preload" href="/assets/js/app.0c0842f3.js" as="script"><link rel="preload" href="/assets/js/2.a6173bc2.js" as="script"><link rel="preload" href="/assets/js/90.8aca6139.js" as="script"><link rel="prefetch" href="/assets/js/10.bf63d664.js"><link rel="prefetch" href="/assets/js/100.26066952.js"><link rel="prefetch" href="/assets/js/101.af73cdfe.js"><link rel="prefetch" href="/assets/js/102.7595455c.js"><link rel="prefetch" href="/assets/js/103.7d1e9bcd.js"><link rel="prefetch" href="/assets/js/104.ffe1e7ed.js"><link rel="prefetch" href="/assets/js/105.1f0786cd.js"><link rel="prefetch" href="/assets/js/106.6a48bf56.js"><link rel="prefetch" href="/assets/js/107.49a2484f.js"><link rel="prefetch" href="/assets/js/108.5141baf2.js"><link rel="prefetch" href="/assets/js/109.d4b9b021.js"><link rel="prefetch" href="/assets/js/11.485b99ca.js"><link rel="prefetch" href="/assets/js/110.6106ded1.js"><link rel="prefetch" href="/assets/js/111.0779a44a.js"><link rel="prefetch" href="/assets/js/112.ee4b5344.js"><link rel="prefetch" href="/assets/js/113.b0d9e8f0.js"><link rel="prefetch" href="/assets/js/114.8d6e510e.js"><link rel="prefetch" href="/assets/js/115.62f1946c.js"><link rel="prefetch" href="/assets/js/116.2b8e6798.js"><link rel="prefetch" href="/assets/js/117.9fa03b43.js"><link rel="prefetch" href="/assets/js/118.89d4a12d.js"><link rel="prefetch" href="/assets/js/119.21b2436d.js"><link rel="prefetch" href="/assets/js/12.ef0e7bb2.js"><link rel="prefetch" href="/assets/js/120.03436387.js"><link rel="prefetch" href="/assets/js/121.d073d8f2.js"><link rel="prefetch" href="/assets/js/122.f5a7c934.js"><link rel="prefetch" href="/assets/js/123.5e10b800.js"><link rel="prefetch" href="/assets/js/124.0657ec75.js"><link rel="prefetch" href="/assets/js/125.e707dfcd.js"><link rel="prefetch" href="/assets/js/126.95d0631d.js"><link rel="prefetch" href="/assets/js/127.f032934c.js"><link rel="prefetch" href="/assets/js/128.4a5f529b.js"><link rel="prefetch" href="/assets/js/129.91a6c0b4.js"><link rel="prefetch" href="/assets/js/13.87dd89d6.js"><link rel="prefetch" href="/assets/js/130.bda83357.js"><link rel="prefetch" href="/assets/js/131.4aa57eff.js"><link rel="prefetch" href="/assets/js/132.5b9896e8.js"><link rel="prefetch" href="/assets/js/133.38cee145.js"><link rel="prefetch" href="/assets/js/134.bebc442c.js"><link rel="prefetch" href="/assets/js/135.0726be31.js"><link rel="prefetch" href="/assets/js/136.148aa795.js"><link rel="prefetch" href="/assets/js/137.ecf5da6a.js"><link rel="prefetch" href="/assets/js/138.075e8bc7.js"><link rel="prefetch" href="/assets/js/139.3f2e7d02.js"><link rel="prefetch" href="/assets/js/14.d98aa6b4.js"><link rel="prefetch" href="/assets/js/140.bc3e4561.js"><link rel="prefetch" href="/assets/js/141.ace4896f.js"><link rel="prefetch" href="/assets/js/142.ac7853e7.js"><link rel="prefetch" href="/assets/js/143.45450d0f.js"><link rel="prefetch" href="/assets/js/144.25820a3f.js"><link rel="prefetch" href="/assets/js/145.241f1f1e.js"><link rel="prefetch" href="/assets/js/146.34385972.js"><link rel="prefetch" href="/assets/js/147.96aa98bf.js"><link rel="prefetch" href="/assets/js/148.9de0fb5f.js"><link rel="prefetch" href="/assets/js/149.eba5050d.js"><link rel="prefetch" href="/assets/js/15.b59d47ee.js"><link rel="prefetch" href="/assets/js/150.aba2fd84.js"><link rel="prefetch" href="/assets/js/151.dd288598.js"><link rel="prefetch" href="/assets/js/152.741c9b96.js"><link rel="prefetch" href="/assets/js/153.5183a4cf.js"><link rel="prefetch" href="/assets/js/154.43618a7f.js"><link rel="prefetch" href="/assets/js/16.63ef0330.js"><link rel="prefetch" href="/assets/js/17.ab2f2dac.js"><link rel="prefetch" href="/assets/js/18.d9538616.js"><link rel="prefetch" href="/assets/js/19.b1c3184d.js"><link rel="prefetch" href="/assets/js/20.47ac56bd.js"><link rel="prefetch" href="/assets/js/21.6b476e98.js"><link rel="prefetch" href="/assets/js/22.f9bfbad9.js"><link rel="prefetch" href="/assets/js/23.76b7cdec.js"><link rel="prefetch" href="/assets/js/24.c7e3e56c.js"><link rel="prefetch" href="/assets/js/25.c9f17ec9.js"><link rel="prefetch" href="/assets/js/26.ceeb895c.js"><link rel="prefetch" href="/assets/js/27.353cf9c7.js"><link rel="prefetch" href="/assets/js/28.cf6c83bd.js"><link rel="prefetch" href="/assets/js/29.218d6a39.js"><link rel="prefetch" href="/assets/js/3.582414ce.js"><link rel="prefetch" href="/assets/js/30.f457d7ac.js"><link rel="prefetch" href="/assets/js/31.9a2bd76d.js"><link rel="prefetch" href="/assets/js/32.76f542ca.js"><link rel="prefetch" href="/assets/js/33.3516b47f.js"><link rel="prefetch" href="/assets/js/34.999c4a7b.js"><link rel="prefetch" href="/assets/js/35.4f666517.js"><link rel="prefetch" href="/assets/js/36.9288d5ed.js"><link rel="prefetch" href="/assets/js/37.4663f1b2.js"><link rel="prefetch" href="/assets/js/38.dff2362e.js"><link rel="prefetch" href="/assets/js/39.a0462821.js"><link rel="prefetch" href="/assets/js/4.37124f74.js"><link rel="prefetch" href="/assets/js/40.4470e8cb.js"><link rel="prefetch" href="/assets/js/41.87c56094.js"><link rel="prefetch" href="/assets/js/42.85a1217e.js"><link rel="prefetch" href="/assets/js/43.6038e8e4.js"><link rel="prefetch" href="/assets/js/44.7aafac1f.js"><link rel="prefetch" href="/assets/js/45.05e89f7b.js"><link rel="prefetch" href="/assets/js/46.fe22afa4.js"><link rel="prefetch" href="/assets/js/47.4d0f0f82.js"><link rel="prefetch" href="/assets/js/48.9b41e3ac.js"><link rel="prefetch" href="/assets/js/49.c4163dc8.js"><link rel="prefetch" href="/assets/js/5.b649da8c.js"><link rel="prefetch" href="/assets/js/50.57533708.js"><link rel="prefetch" href="/assets/js/51.fdf07d65.js"><link rel="prefetch" href="/assets/js/52.4c7fdcd2.js"><link rel="prefetch" href="/assets/js/53.ddd0e223.js"><link rel="prefetch" href="/assets/js/54.5c91c7e3.js"><link rel="prefetch" href="/assets/js/55.250afd87.js"><link rel="prefetch" href="/assets/js/56.5c138b7e.js"><link rel="prefetch" href="/assets/js/57.60e551e3.js"><link rel="prefetch" href="/assets/js/58.921e3d14.js"><link rel="prefetch" href="/assets/js/59.6468404c.js"><link rel="prefetch" href="/assets/js/6.a396de83.js"><link rel="prefetch" href="/assets/js/60.fa65e7a8.js"><link rel="prefetch" href="/assets/js/61.1afe7d7a.js"><link rel="prefetch" href="/assets/js/62.518ff306.js"><link rel="prefetch" href="/assets/js/63.19d38b68.js"><link rel="prefetch" href="/assets/js/64.3069aeba.js"><link rel="prefetch" href="/assets/js/65.f2f736aa.js"><link rel="prefetch" href="/assets/js/66.ee3184cb.js"><link rel="prefetch" href="/assets/js/67.2f1c3534.js"><link rel="prefetch" href="/assets/js/68.a3b9b943.js"><link rel="prefetch" href="/assets/js/69.10d835d5.js"><link rel="prefetch" href="/assets/js/7.03daa1b7.js"><link rel="prefetch" href="/assets/js/70.4c7a468d.js"><link rel="prefetch" href="/assets/js/71.5ba570b2.js"><link rel="prefetch" href="/assets/js/72.a231600f.js"><link rel="prefetch" href="/assets/js/73.096b496f.js"><link rel="prefetch" href="/assets/js/74.21040cf6.js"><link rel="prefetch" href="/assets/js/75.d8605e36.js"><link rel="prefetch" href="/assets/js/76.737ce24b.js"><link rel="prefetch" href="/assets/js/77.7c7b532f.js"><link rel="prefetch" href="/assets/js/78.60b44955.js"><link rel="prefetch" href="/assets/js/79.6dbe3652.js"><link rel="prefetch" href="/assets/js/8.150af887.js"><link rel="prefetch" href="/assets/js/80.58526f91.js"><link rel="prefetch" href="/assets/js/81.c19d05fe.js"><link rel="prefetch" href="/assets/js/82.d0b9d12a.js"><link rel="prefetch" href="/assets/js/83.a61a8d5a.js"><link rel="prefetch" href="/assets/js/84.c4d8e817.js"><link rel="prefetch" href="/assets/js/85.6a87b80a.js"><link rel="prefetch" href="/assets/js/86.cab67863.js"><link rel="prefetch" href="/assets/js/87.b4cad765.js"><link rel="prefetch" href="/assets/js/88.22b46094.js"><link rel="prefetch" href="/assets/js/89.f494a431.js"><link rel="prefetch" href="/assets/js/9.f7aab732.js"><link rel="prefetch" href="/assets/js/91.42745b4d.js"><link rel="prefetch" href="/assets/js/92.b7ef843b.js"><link rel="prefetch" href="/assets/js/93.23cc4aff.js"><link rel="prefetch" href="/assets/js/94.338f5c05.js"><link rel="prefetch" href="/assets/js/95.00aa4f44.js"><link rel="prefetch" href="/assets/js/96.c911c744.js"><link rel="prefetch" href="/assets/js/97.0225f345.js"><link rel="prefetch" href="/assets/js/98.d421614b.js"><link rel="prefetch" href="/assets/js/99.e5a41af7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ceffaf74.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">å°å¼ ç¬”è®°</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/ç´¢å¼•/Search.html" class="nav-link">
  Googleç«™å†…æœç´¢
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/211019_åŸºäºtcpdumpåŸç†æ‰‹å†™æŠ“åŒ…ç¨‹åº.html" class="nav-link">
  ç®€ä½“ä¸­æ–‡
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/ç´¢å¼•/Search.html" class="nav-link">
  Googleç«™å†…æœç´¢
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">é€‰æ‹©è¯­è¨€</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/" class="nav-link">
  en-US
</a></li><li class="dropdown-item"><!----> <a href="/file/211019_åŸºäºtcpdumpåŸç†æ‰‹å†™æŠ“åŒ…ç¨‹åº.html" class="nav-link">
  ç®€ä½“ä¸­æ–‡
</a></li></ul></div></div> <!----></nav>  <!----> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>â€œåŸºäºtcpdumpåŸç†æ‰‹å†™æŠ“åŒ…ç¨‹åºâ€</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>[Linuxå†…æ ¸ä¹‹æ—…](javascript:void(0)ğŸ˜‰ <em>ä»Šå¤©</em></p> <p>ä»¥ä¸‹æ–‡ç« æ¥æºäºæŠ€æœ¯ç®€è¯´ ï¼Œä½œè€…è‘£æ—­</p> <p>æœ¬å…¬ä¼—å·ä½œè€…ä¸ºLinuxå†…æ ¸ä¹‹æ—…ç¤¾åŒºæˆå‘˜-è‘£æ—­</p> <p>åŸºäºtcpdumpåŸç†æ‰‹åŠ¨å®ç°æŠ“åŒ…ç¨‹åº</p> <p>å‰é¢ä¸¤ç¯‡æ–‡ç« åˆ†ætcpdumpå®ç°æŠ“åŒ…åŸç†ï¼š</p> <p>1ã€<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483799&amp;idx=1&amp;sn=d31ddd924b8809040c004c5f163cb61d&amp;chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸»è¦ä»Linuxå†…æ ¸è§’åº¦åˆ†ætcpdumpæ—è·¯å—…æ¢æ•°æ®åŒ…çš„è¿‡ç¨‹</p> <p>2ã€<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483893&amp;idx=1&amp;sn=e6ba1fdb1bb5a792ccb141b936eb5211&amp;chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸»è¦ä»Linuxå†…æ ¸è§’åº¦åˆ†ætcpdumpåˆ©ç”¨BPFæœºåˆ¶å®ç°æ•°æ®åŒ…æ•è·å‰çš„è¿‡æ»¤è¿‡ç¨‹</p> <p>æœ¬æ¬¡å°†æ ¹æ®å‰é¢çš„åˆ†æï¼Œæ‰‹åŠ¨å†™ä¸€ä¸ªåŸºäºtcpdumpå·¥å…·åŸç†çš„ç®€æ˜“æŠ“åŒ…ç¨‹åºï¼Œå®ç°ä»é“¾è·¯å±‚çš„æŠ“åŒ…ï¼ŒåŠ æ·±ä¸€ä¸‹å…³äºtcpdumpåŸç†çš„å°è±¡ã€‚</p> <h3 id=""><a href="#" class="header-anchor">#</a></h3> <p>æµç¨‹åˆ†æ</p> <h4 id="_1ã€pf-packetåè®®æ—çš„socket"><a href="#_1ã€pf-packetåè®®æ—çš„socket" class="header-anchor">#</a> 1ã€PF_PACKETåè®®æ—çš„socket</h4> <p>æ­£å¦‚åœ¨<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483799&amp;idx=1&amp;sn=d31ddd924b8809040c004c5f163cb61d&amp;chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­åˆ†ææ—¶ï¼Œä»¥<code>socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL))</code>ä¸ºç€æ‰‹ç‚¹ã€‚æˆ‘ä»¬é€šå¸¸éƒ½æ˜¯é€šè¿‡åˆ›å»ºPF_PACKETåè®®æ—çš„socket,ç”¨æ¥æŠ“åŒ…ã€åˆ†ææ•°æ®çš„ã€‚</p> <p>å¦‚ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªPF_PACKETç±»å‹çš„socket,typeæŒ‡å®šä¸ºSOCK_RAW,å½“æŒ‡å®šSOCK_RAWæ—¶ï¼Œè·å–çš„æ•°æ®åŒ…æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®é“¾è·¯å±‚æ•°æ®åŒ…ã€‚proticolå­—æ®µè®¾ç½®ä¸ºhtons(ETH_P_ALL)ï¼Œè¡¨ç¤ºæ¥æ”¶ç«¯æ•°æ®é“¾è·¯å±‚æ‰€æœ‰åè®®å¸§ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>/*socketå‡½æ•°åŸå‹ï¼š
#include &lt;sys/socket.h&gt;
sockfd = socket(int socket_family, int socket_type, int protocol);
*/
sock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
 if (sock &lt; 0) {
  perror(&quot;socket&quot;);
  return 1;
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h4 id="_2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§"><a href="#_2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§" class="header-anchor">#</a> 2ã€è®¾ç½®é“¾è·¯å±‚å±æ€§</h4> <h5 id="æ ¸å¿ƒç»“æ„ä½“-struct-sockaddr-ll"><a href="#æ ¸å¿ƒç»“æ„ä½“-struct-sockaddr-ll" class="header-anchor">#</a> æ ¸å¿ƒç»“æ„ä½“ï¼šstruct sockaddr_ll</h5> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct sockaddr_ll
{
 unsigned short int sll_family; /* ä¸€èˆ¬ä¸ºAF_PACKET */
 unsigned short int sll_protocol; /* ä¸Šå±‚åè®®ç±»å‹ */
 int  sll_ifindex; /* ç½‘å¡æ¥å£ç´¢å¼•å·ï¼Œ0 åŒ¹é…æ‰€æœ‰çš„ç½‘ç»œæ¥å£å¡ */
 unsigned short int sll_hatype; /* æŠ¥å¤´ç±»å‹ */
 unsigned char sll_pkttype; /* åŒ…ç±»å‹ */
 unsigned char sll_halen; /* åœ°å€é•¿åº¦ */
 unsigned char sll_addr[8]; /* MACåœ°å€ */
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>è¯¥ç»“æ„ä½“ä¸ºè®¾å¤‡æ— å…³çš„ç‰©ç†å±‚åœ°å€ç»“æ„ï¼Œæ•°æ®é“¾è·¯å±‚çš„å¤´ä¿¡æ¯é€šå¸¸å®šä¹‰åœ¨sockaddr_allçš„ç»“æ„ä½“ä¸­ï¼Œå½“å‘é€æ•°æ®åŒ…æ—¶ï¼ŒæŒ‡å®š sll_family, sll_addr, sll_halen, sll_ifindex, sll_protocol å°±è¶³å¤Ÿäº†ã€‚å…¶å®ƒå­—æ®µè®¾ç½®ä¸º0ï¼›sll_hatypeå’Œ sll_pkttypeæ˜¯åœ¨æ¥æ”¶æ•°æ®åŒ…æ—¶ä½¿ç”¨çš„ï¼›å¦‚æœè¦bind, åªéœ€è¦ä½¿ç”¨ sll_protocolå’Œ sll_ifindexå°±è¶³å¤Ÿã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> struct sockaddr_ll addr;
 memset(&amp;addr, 0, sizeof(addr));
 addr.sll_ifindex = if_nametoindex(name);//nameä¸ºå½“å‰è¦æŠ“åŒ…çš„ç½‘å¡æ¥å£åç§°
 addr.sll_family = AF_PACKET;
 addr.sll_protocol = htons(ETH_P_ALL);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š"><a href="#_3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š" class="header-anchor">#</a> 3ã€å°†åˆ›å»ºçš„soccketä¸åœ°å€ç»‘å®š</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code> if (bind(sock, (struct sockaddr *) &amp;addr, sizeof(addr))) {
  perror(&quot;bind&quot;);
  return 1;
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="_4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶"><a href="#_4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶" class="header-anchor">#</a> 4ã€æŠ“åŒ…çš„è¿‡æ»¤æ¡ä»¶</h4> <p>åœ¨<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483893&amp;idx=1&amp;sn=e6ba1fdb1bb5a792ccb141b936eb5211&amp;chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ï¼Œä»‹ç»äº†BPFè¿‡æ»¤æœºåˆ¶ï¼Œåœ¨tcpdumpçš„è¿‡æ»¤æœºåˆ¶ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„ç»“æ„ä½“:struct sock_filterï¼ŒåŒæ—¶ä¹Ÿæ˜¯cBPFæ±‡ç¼–çš„ä¸€ä¸ªæ¡†æ¶</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct sock_filter {
 __u16 code;   /*æŒ‡ä»¤  32ä½*/
 __u8 jt; /* jtæ˜¯æŒ‡ä»¤ç»“æœä¸ºtrueçš„è·³è½¬ */
 __u8 jf; /* jfæ˜¯ä¸ºfalseçš„è·³è½¬ */
 __u32 k;      /* æŒ‡ä»¤å‚æ•°*/
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>è¯¥ç»“æ„ä½“ä¸€èˆ¬æ˜¯å°è£…åœ¨struct sock_fprogä¸­ä½¿ç”¨:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct sock_fprog      
{
    unsigned short  len;   
    struct sock_filter   *filter;
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>åœ¨<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483799&amp;idx=1&amp;sn=d31ddd924b8809040c004c5f163cb61d&amp;chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­åˆ†æè¿‡ï¼Œä½¿ç”¨tcpdump -då‚æ•°å¯ä»¥ç”ŸæˆBPFæ±‡ç¼–ä¼ªä»£ç ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dx@ubuntu:~$ sudo tcpdump -d 'ip and tcp port 80'
(000) ldh      [12]
(001) jeq      #0x800           jt 2    jf 12
(002) ldb      [23]
(003) jeq      #0x6             jt 4    jf 12
(004) ldh      [20]
(005) jset     #0x1fff          jt 12   jf 6
(006) ldxb     4*([14]&amp;0xf)
(007) ldh      [x + 14]
(008) jeq      #0x50            jt 11   jf 9
(009) ldh      [x + 16]
(010) jeq      #0x50            jt 11   jf 12
(011) ret      #262144
(012) ret      #0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¿™ç§ä¼ªä»£ç åœ¨Cç¨‹åºä¸­æ˜¯æ— æ³•ä½¿ç”¨çš„ï¼Œéœ€è¦å€Ÿç”¨tcpdump -ddå‚æ•°ç”Ÿæˆç­‰æ•ˆçš„cä»£ç ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>dx@ubuntu:~$ sudo tcpdump -dd 'ip and tcp port 80'
{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 0, 10, 0x00000800 },
{ 0x30, 0, 0, 0x00000017 },
{ 0x15, 0, 8, 0x00000006 },
{ 0x28, 0, 0, 0x00000014 },
{ 0x45, 6, 0, 0x00001fff },
{ 0xb1, 0, 0, 0x0000000e },
{ 0x48, 0, 0, 0x0000000e },
{ 0x15, 2, 0, 0x00000050 },
{ 0x48, 0, 0, 0x00000010 },
{ 0x15, 0, 1, 0x00000050 },
{ 0x6, 0, 0, 0x00040000 },
{ 0x6, 0, 0, 0x00000000 },
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>è¿™æ®µä»£ç å°±æ˜¯struct sock_filterï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>static struct sock_filter bpfcode[13] = {
{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 0, 10, 0x00000800 },
{ 0x30, 0, 0, 0x00000017 },
{ 0x15, 0, 8, 0x00000006 },
{ 0x28, 0, 0, 0x00000014 },
{ 0x45, 6, 0, 0x00001fff },
{ 0xb1, 0, 0, 0x0000000e },
{ 0x48, 0, 0, 0x0000000e },
{ 0x15, 2, 0, 0x00000050 },
{ 0x48, 0, 0, 0x00000010 },
{ 0x15, 0, 1, 0x00000050 },
{ 0x6, 0, 0, 0x00040000 },
{ 0x6, 0, 0, 0x00000000 },
};

struct sock_fprog bpf = { 13, bpfcode };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h4 id="_5ã€è®¾ç½®bpfè¿‡æ»¤å™¨"><a href="#_5ã€è®¾ç½®bpfè¿‡æ»¤å™¨" class="header-anchor">#</a> 5ã€è®¾ç½®BPFè¿‡æ»¤å™¨</h4> <p>Linuxåœ¨å®‰è£…å’Œå¸è½½è¿‡æ»¤å™¨æ—¶éƒ½ä½¿ç”¨äº†å‡½æ•°setsockopt(),å…¶ä¸­æ ‡å¿—SOL_SOCKETä»£è¡¨å¯¹socketè¿›è¡Œè®¾ç½®ï¼ŒSO_ATTACH_FILTERè¡¨ç¤ºå®‰è£…è¿‡æ»¤å™¨åŠ¨ä½œï¼Œsetsockoptåœ¨å†…æ ¸ä¸­çš„è°ƒç”¨å¯ä»¥çœ‹<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483893&amp;idx=1&amp;sn=e6ba1fdb1bb5a792ccb141b936eb5211&amp;chksm=cfcacf3ef8bd462868d9b1071c28aa5b7fe0871f48564971079b4a666cd96f1c084877731ba3&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>setsockopt(sd, SOL_SOCKET, SO_ATTACH_FILTER, &amp;Filter, sizeof(Filter));
 if (setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &amp;bpf, sizeof(bpf))) {
  perror(&quot;setsockopt ATTACH_FILTER&quot;);
  return 1;
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼"><a href="#_6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼" class="header-anchor">#</a> 6ã€è®¾ç½®ç½‘å¡çš„æ··æ‚æ¨¡å¼</h4> <p>å…³é”®ç»“æ„ä½“ï¼šstruct packet_mreq</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct packet_mreq
{
intmr_ifindex; /* æ¥å£ç´¢å¼• */
unsigned shortmr_type; /* mreq ç±»å‹ */
unsigned shortmr_alen; /* åœ°å€é•¿åº¦ */
unsigned charmr_address[8]; /* ç‰©ç†åœ°å€ */
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>æ··æ‚æ¨¡å¼ï¼š</p> <p>æ··æ‚æ¨¡å¼å°±æ˜¯æ¥æ”¶æ‰€æœ‰ç»è¿‡ç½‘å¡çš„æ•°æ®åŒ…ï¼ŒåŒ…æ‹¬ä¸æ˜¯å‘ç»™æœ¬æœºçš„åŒ…ï¼Œé»˜è®¤æƒ…å†µä¸‹ç½‘å¡åªæŠŠå‘ç»™æœ¬æœºçš„åŒ…ï¼ˆåŒ…æ‹¬å¹¿æ’­åŒ…ï¼‰ä¼ é€’ç»™ä¸Šå±‚ç¨‹åºï¼Œå…¶å®ƒçš„åŒ…ä¸€å¾‹ä¸¢å¼ƒï¼›ç®€å•çš„è®²ï¼Œæ··æ‚æ¨¡å¼å°±æ˜¯æŒ‡ç½‘å¡èƒ½æ¥å—æ‰€æœ‰é€šè¿‡å®ƒçš„æ•°æ®æµï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œä»€ä¹ˆåœ°å€ï¼Œå½“ç½‘å¡å¤„äºæ··æ‚æ¨¡å¼æ—¶ï¼Œè¯¥ç½‘å¡å°±å…·æœ‰â€œå¹¿æ’­åœ°å€â€ï¼Œå®ƒå¯¹æ‰€æœ‰é‡åˆ°çš„æ¯ä¸€ä¸ªæ•°æ®å¸§éƒ½äº§ç”Ÿä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ï¼Œä»¥ä¾¿æé†’æ“ä½œç³»ç»Ÿå¤„ç†æµç»è¿‡è¯¥ç‰©ç†åª’ä½“ä¸Šçš„æ¯ä¸€ä¸ªæŠ¥æ–‡åŒ…ã€‚</p> <p>é€šè¿‡<code>shortmr_type</code>å­—æ®µå¯ä»¥è®¾ç½®æ··æ‚æ¨¡å¼</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>    struct packet_mreq mreq;
    memset(&amp;mreq, 0, sizeof(mreq));
 mreq.mr_type = PACKET_MR_PROMISC;//è®¾ç½®æ··æ‚æ¨¡å¼
 mreq.mr_ifindex = if_nametoindex(name);
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>å°†è®¾ç½®çš„æ··æ‚æ¨¡å¼è®¾ç½®åˆ°socket:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> if (setsockopt(sock, SOL_PACKET,
    PACKET_ADD_MEMBERSHIP, (char *)&amp;mreq, sizeof(mreq))) {
  perror(&quot;setsockopt MR_PROMISC&quot;);//ACKET_ADD_MEMBERSHIP ç”¨äºå¢åŠ ä¸€ä¸ªç»‘å®š
  return 1;
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h4 id="_7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯"><a href="#_7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯" class="header-anchor">#</a> 7ã€å®šä¹‰è¦è·å¾—çš„æ•°æ®æŠ¥æ–‡ä¿¡æ¯</h4> <h5 id="æºå’Œç›®çš„macåœ°å€"><a href="#æºå’Œç›®çš„macåœ°å€" class="header-anchor">#</a> æºå’Œç›®çš„MACåœ°å€</h5> <p>å…³é”®ç»“æ„ä½“ï¼š</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct ether_header
{
  uint8_t  ether_dhost[ETH_ALEN]; /* ç›®çš„MACåœ°å€ */
  uint8_t  ether_shost[ETH_ALEN]; /* æºMACåœ°å€ */
  uint16_t ether_type;          /* packet type ID field */
};
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>IPä¿¡æ¯(æºã€ç›®çš„IPï¼ŒIPç‰ˆæœ¬)ã€ä¸Šå±‚åè®®ç±»å‹</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>struct iphdr
  {
#if __BYTE_ORDER == __LITTLE_ENDIAN
    unsigned int ihl:4;
    unsigned int version:4;
#elif __BYTE_ORDER == __BIG_ENDIAN
    unsigned int version:4;
    unsigned int ihl:4;
#else
# error &quot;Please fix &lt;bits/endian.h&gt;&quot;
#endif
    uint8_t tos;
    uint16_t tot_len;
    uint16_t id;
    uint16_t frag_off;
    uint8_t ttl;
    uint8_t protocol;  //ä¸Šå±‚åè®®ç±»å‹
    uint16_t check;
    uint32_t saddr;   //æºåœ°å€
    uint32_t daddr;   //ç›®çš„åœ°å€
    /*The options start here. */
  };
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h4 id="_8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…"><a href="#_8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…" class="header-anchor">#</a> 8ã€å¾ªç¯æ¥æ”¶æ•è·çš„æ•°æ®åŒ…</h4> <p>åœ¨<a href="http://mp.weixin.qq.com/s?__biz=Mzg5MTU1ODgyMA==&amp;mid=2247483799&amp;idx=1&amp;sn=d31ddd924b8809040c004c5f163cb61d&amp;chksm=cfcacf5cf8bd464abdab4c3a9b571d6e52d0a8d0ee9d71191bbe8ed3c3dfb084e303b636afce&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">æ–‡ç« 1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>ä¸­ï¼Œåˆ†æäº†æ•°æ®åŒ…æ˜¯æ€æ ·æ•è·çš„:</p> <blockquote><p>å›é¡¾ï¼š</p> <p>tcpdumpè¿›è¡ŒæŠ“åŒ…çš„å†…æ ¸æµç¨‹æ¢³ç†</p> <ul><li>åº”ç”¨å±‚é€šè¿‡libpcapåº“ï¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨åˆ›å»ºsocket,<code>sock_fd = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));</code>tcpdumpåœ¨socketåˆ›å»ºè¿‡ç¨‹ä¸­åˆ›å»ºpacket_type(struct packet_type),å¹¶æŒ‚è½½åˆ°å…¨å±€çš„ptype_allé“¾è¡¨ä¸Šã€‚(åŒæ—¶åœ¨packet_typeè®¾ç½®å›è°ƒå‡½æ•°packet_rcv</li> <li>ç½‘ç»œæ”¶åŒ…/å‘åŒ…æ—¶ï¼Œä¼šåœ¨å„è‡ªçš„å¤„ç†å‡½æ•°(æ”¶åŒ…æ—¶ï¼š<code>__netif_receive_skb_core</code>ï¼Œå‘åŒ…æ—¶ï¼š<code>dev_queue_xmit_nit</code>)ä¸­éå†ptype_allé“¾è¡¨ï¼Œå¹¶åŒæ—¶æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ï¼Œè¿™é‡Œtcpdumpçš„æ³¨å†Œçš„å›è°ƒå‡½æ•°å°±æ˜¯packet_rcv</li> <li>packet_rcvå‡½æ•°ä¸­ä¼šå°†ç”¨æˆ·è®¾ç½®çš„è¿‡æ»¤æ¡ä»¶ï¼Œé€šè¿‡BPFè¿›è¡Œè¿‡æ»¤ï¼Œå¹¶å°†è¿‡æ»¤çš„æ•°æ®åŒ…æ·»åŠ åˆ°æ¥æ”¶é˜Ÿåˆ—ä¸­</li> <li>åº”ç”¨å±‚è°ƒç”¨recvfrom ã€‚PF_PACKET åè®®ç°‡æ¨¡å—è°ƒç”¨packet_recvmsg å°†æ¥æ”¶é˜Ÿåˆ—ä¸­çš„æ•°æ®copyåº”ç”¨å±‚ï¼Œåˆ°æ­¤å°†æ•°æ®åŒ…æ•è·åˆ°ã€‚</li></ul></blockquote> <p>æ‰€ä»¥ä¸Šé¢åˆ›å»ºå¥½çš„PF_PACKETç±»å‹socketï¼Œå¹¶è®¾ç½®å¥½è¿‡æ»¤å™¨åï¼Œå½“ç½‘å¡æœ‰æ•°æ®è¿›å‡ºæ—¶ï¼Œå°±å·²ç»å°†æ•°æ®æŠ¥æ–‡æ·»åŠ åˆ°äº†æ¥æ”¶é˜Ÿåˆ—ä¸Šäº†ï¼Œä¸‹é¢åªéœ€è¦æˆ‘ä»¬è¿›è¡Œrecvè·å–æ•°æ®æŠ¥æ–‡å³å¯ã€‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code> for (;;) {
  n = recv(sock, buf, sizeof(buf), 0);
  if (n &lt; 1) {
   perror(&quot;recv&quot;);
   return 0;
  }
        //è·å–é“¾è·¯å±‚çš„æºå’Œç›®çš„åœ°å€
  mac_hdr=(struct ether_header *)buf;

  ip = (struct iphdr *)(buf + sizeof(struct ether_header));

  inet_ntop(AF_INET, &amp;ip-&gt;saddr, saddr_str, sizeof(saddr_str));
  inet_ntop(AF_INET, &amp;ip-&gt;daddr, daddr_str, sizeof(daddr_str));

  switch (ip-&gt;protocol) {
#define PTOSTR(_p,_str) \
   case _p: proto_str = _str; break

  PTOSTR(IPPROTO_ICMP, &quot;icmp&quot;);
  PTOSTR(IPPROTO_TCP, &quot;tcp&quot;);
  PTOSTR(IPPROTO_UDP, &quot;udp&quot;);
  default:
   proto_str = &quot;&quot;;
   break;
  }
        printf(&quot; SMAC:%X:%X:%X:%X:%X:%X&quot;,
    (u_char)mac_hdr-&gt;ether_shost[0],
    (u_char)mac_hdr-&gt;ether_shost[1],
    (u_char)mac_hdr-&gt;ether_shost[2],
    (u_char)mac_hdr-&gt;ether_shost[3],
    (u_char)mac_hdr-&gt;ether_shost[4],
    (u_char)mac_hdr-&gt;ether_shost[5]
   );

  printf(&quot; ==&gt;  DMAC:%X:%X:%X:%X:%X:%X  &quot;,
    (u_char)mac_hdr-&gt;ether_dhost[0],
    (u_char)mac_hdr-&gt;ether_dhost[1],
    (u_char)mac_hdr-&gt;ether_dhost[2],
    (u_char)mac_hdr-&gt;ether_dhost[3],
    (u_char)mac_hdr-&gt;ether_dhost[4],
    (u_char)mac_hdr-&gt;ether_dhost[5]
   );
  printf(&quot;IPv%d proto=%d(%s) src=%s dst=%s\n&quot;,
    ip-&gt;version, ip-&gt;protocol, proto_str, saddr_str, daddr_str);
 }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><p>è‡³æ­¤ï¼Œä»åˆ›å»ºsocketï¼Œåˆ°è®¾ç½®socketè¿‡æ»¤å™¨ã€ç½‘å¡å·¥ä½œæ¨¡å¼ï¼Œåˆ°æ¥æ”¶æ•è·çš„æ•°æ®åŒ…å°±ç»“æŸäº†ã€‚</p> <h3 id="-2"><a href="#-2" class="header-anchor">#</a></h3> <p>é™„ï¼šæºä»£ç </p> <p><img src="https://mmbiz.qpic.cn/mmbiz_gif/EjWxxIM2EQJDl28hhtwMqByPiceMkObWic7WIIXpTBn5ibvVNKicK8Dhjga8Q1zasPKVgbhC4vd3CyyCH4tJMvicQ2Q/640?wx_fmt=gif&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1" alt="å›¾ç‰‡"></p> <p>å®ç°æ•è·æ•°æ®åŒ…çš„è¿‡æ»¤æ¡ä»¶ï¼šip and tcp port 80</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;net/if.h&gt;
#include &lt;net/ethernet.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;netinet/ip.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;netpacket/packet.h&gt;
#include &lt;linux/filter.h&gt;

static struct sock_filter bpfcode[13] = {
{ 0x28, 0, 0, 0x0000000c },
{ 0x15, 0, 10, 0x00000800 },
{ 0x30, 0, 0, 0x00000017 },
{ 0x15, 0, 8, 0x00000006 },
{ 0x28, 0, 0, 0x00000014 },
{ 0x45, 6, 0, 0x00001fff },
{ 0xb1, 0, 0, 0x0000000e },
{ 0x48, 0, 0, 0x0000000e },
{ 0x15, 2, 0, 0x00000050 },
{ 0x48, 0, 0, 0x00000010 },
{ 0x15, 0, 1, 0x00000050 },
{ 0x6, 0, 0, 0x00040000 },
{ 0x6, 0, 0, 0x00000000 },
};

int main(int argc, char **argv)
{
 int sock;
 int n;
 char buf[2000];
 struct sockaddr_ll addr;
 struct packet_mreq mreq;
 struct iphdr *ip;
    struct ether_header *mac_hdr;
    char saddr_str[INET_ADDRSTRLEN], daddr_str[INET_ADDRSTRLEN];
 char *proto_str;
 char *name;
 struct sock_fprog bpf = { 13, bpfcode };

 if (argc != 2) {
  printf(&quot;Usage: %s ifname\n&quot;, argv[0]);
  return 1;
 }

 name = argv[1];

 sock = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
 if (sock &lt; 0) {
  perror(&quot;socket&quot;);
  return 1;
 }

 memset(&amp;addr, 0, sizeof(addr));
 addr.sll_ifindex = if_nametoindex(name);
 addr.sll_family = AF_PACKET;
 addr.sll_protocol = htons(ETH_P_ALL);

 if (bind(sock, (struct sockaddr *) &amp;addr, sizeof(addr))) {
  perror(&quot;bind&quot;);
  return 1;
 }

 if (setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &amp;bpf, sizeof(bpf))) {
  perror(&quot;setsockopt ATTACH_FILTER&quot;);
  return 1;
 }

 memset(&amp;mreq, 0, sizeof(mreq));
 mreq.mr_type = PACKET_MR_PROMISC;
 mreq.mr_ifindex = if_nametoindex(name);

 if (setsockopt(sock, SOL_PACKET,
    PACKET_ADD_MEMBERSHIP, (char *)&amp;mreq, sizeof(mreq))) {
  perror(&quot;setsockopt MR_PROMISC&quot;);
  return 1;
 }

 for (;;) {
  n = recv(sock, buf, sizeof(buf), 0);
  if (n &lt; 1) {
   perror(&quot;recv&quot;);
   return 0;
  }
        //è·å–é“¾è·¯å±‚çš„æºå’Œç›®çš„åœ°å€
  mac_hdr=(struct ether_header *)buf;

  ip = (struct iphdr *)(buf + sizeof(struct ether_header));

  inet_ntop(AF_INET, &amp;ip-&gt;saddr, saddr_str, sizeof(saddr_str));
  inet_ntop(AF_INET, &amp;ip-&gt;daddr, daddr_str, sizeof(daddr_str));

  switch (ip-&gt;protocol) {
#define PTOSTR(_p,_str) \
   case _p: proto_str = _str; break

  PTOSTR(IPPROTO_ICMP, &quot;icmp&quot;);
  PTOSTR(IPPROTO_TCP, &quot;tcp&quot;);
  PTOSTR(IPPROTO_UDP, &quot;udp&quot;);
  default:
   proto_str = &quot;&quot;;
   break;
  }
        printf(&quot; SMAC:%X:%X:%X:%X:%X:%X&quot;,
    (u_char)mac_hdr-&gt;ether_shost[0],
    (u_char)mac_hdr-&gt;ether_shost[1],
    (u_char)mac_hdr-&gt;ether_shost[2],
    (u_char)mac_hdr-&gt;ether_shost[3],
    (u_char)mac_hdr-&gt;ether_shost[4],
    (u_char)mac_hdr-&gt;ether_shost[5]
   );

  printf(&quot; ==&gt;  DMAC:%X:%X:%X:%X:%X:%X  &quot;,
    (u_char)mac_hdr-&gt;ether_dhost[0],
    (u_char)mac_hdr-&gt;ether_dhost[1],
    (u_char)mac_hdr-&gt;ether_dhost[2],
    (u_char)mac_hdr-&gt;ether_dhost[3],
    (u_char)mac_hdr-&gt;ether_dhost[4],
    (u_char)mac_hdr-&gt;ether_dhost[5]
   );
  printf(&quot;IPv%d proto=%d(%s) src=%s dst=%s\n&quot;,
    ip-&gt;version, ip-&gt;protocol, proto_str, saddr_str, daddr_str);
 }

 return 0;
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br></div></div><h4 id="è¿è¡Œ"><a href="#è¿è¡Œ" class="header-anchor">#</a> è¿è¡Œï¼š</h4> <p><img src="https://mmbiz.qpic.cn/mmbiz_png/EjWxxIM2EQLoiaBp9GUEWP5Qx1RQRc0CFGcDVdUb9aaJyWYhmI3LuPZh6wMy1kaEjO7ibnT510jXTAJzLytF2Rwg/640?wx_fmt=png&amp;tp=webp&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="å›¾ç‰‡"></p> <blockquote><p>æ³¨æ„ï¼šç¨‹åºæŒ‡å®šçš„å‚æ•°ï¼šens33ä¸ºè‡ªå·±çš„ç½‘å¡æ¥å£åç§°ï¼Œå¯ä»¥é€šè¿‡ip addrè¿›è¡ŒæŸ¥çœ‹ã€‚</p></blockquote> <p>å–œæ¬¢æ­¤å†…å®¹çš„äººè¿˜å–œæ¬¢</p> <p>Filebeatã€Logstashã€Rsyslog å„ç§å§¿åŠ¿é‡‡é›†Nginxæ—¥å¿—</p> <p>é«˜æ•ˆè¿ç»´</p> <p>ä¸å–œæ¬¢</p> <p>ä¸çœ‹çš„åŸå› </p> <p>ç¡®å®š</p> <ul><li><p>å†…å®¹è´¨é‡ä½</p></li> <li></li> <li><p>ä¸çœ‹æ­¤å…¬ä¼—å·</p></li></ul> <p><img src="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=102&amp;__biz=MzI3NzA5MzUxNA==&amp;mid=2664610380&amp;idx=1&amp;sn=2f15cdfb6e31bcd5b5f62437ca4c7740&amp;send_time=" alt="img"></p> <p>å¾®ä¿¡æ‰«ä¸€æ‰«
å…³æ³¨è¯¥å…¬ä¼—å·</p> <p>ï¼šï¼Œã€‚è§†é¢‘å°ç¨‹åºèµï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆèµåœ¨çœ‹ï¼Œè½»ç‚¹ä¸¤ä¸‹å–æ¶ˆåœ¨çœ‹</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2021/11/12 ä¸Šåˆ12:25:46</span></div></footer> <!----> </main> <div class="footer-wrapper footer"><span><a href="https://beian.miit.gov.cn/">è±«ICPå¤‡20003255å·</a></span> <!----></div></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0c0842f3.js" defer></script><script src="/assets/js/2.a6173bc2.js" defer></script><script src="/assets/js/90.8aca6139.js" defer></script>
  </body>
</html>
